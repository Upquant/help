
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>策略示例 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-advanced-emoji/emoji-website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-ancre-navigation/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="style/override.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="starategy6.html" />
    
    
    <link rel="prev" href="api5.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    优品量化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="guide1.html">
            
                <a href="guide1.html#新手指引">
            
                    
                    新手指引
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="guide1.html">
            
                <a href="guide1.html#三分钟完成本地回测">
            
                    
                    三分钟完成本地策略回测
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="guide1.html">
            
                <a href="guide1.html#三分钟完成本地策略回测-旧">
            
                    
                    三分钟完成本地策略回测-旧
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="introduction2.html">
            
                <a href="introduction2.html#平台介绍">
            
                    
                    平台介绍
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="introduction2.html">
            
                <a href="introduction2.html#整体架构">
            
                    
                    整体架构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="introduction2.html">
            
                <a href="introduction2.html#金融数据">
            
                    
                    金融数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="introduction2.html">
            
                <a href="introduction2.html#量化引擎">
            
                    
                    量化引擎
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="introduction2.html">
            
                <a href="introduction2.html#sdk">
            
                    
                    sdk(python/c++)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="introduction2.html">
            
                <a href="introduction2.html#web管理">
            
                    
                    web管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="introduction2.html">
            
                <a href="introduction2.html#部署架构">
            
                    
                    部署架构
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="operation3.html">
            
                <a href="operation3.html#使用说明">
            
                    
                    使用说明
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="operation3.html">
            
                <a href="operation3.html#开启量化之旅">
            
                    
                    开启量化之旅
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="operation3.html">
            
                <a href="operation3.html#进入量化平台">
            
                    
                    进入量化平台
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="operation3.html">
            
                <a href="operation3.html#sdk下载">
            
                    
                    sdk下载
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="operation3.html">
            
                <a href="operation3.html#sdk解压">
            
                    
                    sdk解压
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.2" data-path="operation3.html">
            
                <a href="operation3.html#安装python包">
            
                    
                    安装python包
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.3" data-path="operation3.html">
            
                <a href="operation3.html#sdk升级">
            
                    
                    sdk升级
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3.4" data-path="operation3.html">
            
                <a href="operation3.html#文件说明">
            
                    
                    文件说明
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="operation3.html">
            
                <a href="operation3.html#策略研究">
            
                    
                    策略研究
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.4.1" data-path="operation3.html">
            
                <a href="operation3.html#策略创建">
            
                    
                    策略创建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.2" data-path="operation3.html">
            
                <a href="operation3.html#创建回测实例">
            
                    
                    创建回测实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.3" data-path="operation3.html">
            
                <a href="operation3.html#运行回测">
            
                    
                    运行回测
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4.4" data-path="operation3.html">
            
                <a href="operation3.html#查看回测结果">
            
                    
                    查看回测结果
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="operation3.html">
            
                <a href="operation3.html#模拟交易">
            
                    
                    模拟交易
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.5.1" data-path="operation3.html">
            
                <a href="operation3.html#模拟交易策略管理">
            
                    
                    模拟交易策略管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.2" data-path="operation3.html">
            
                <a href="operation3.html#创建模拟交易运行实例">
            
                    
                    创建模拟交易运行实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.3" data-path="operation3.html">
            
                <a href="operation3.html#模拟运行实例">
            
                    
                    模拟运行实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.4" data-path="operation3.html">
            
                <a href="operation3.html#查看模拟运行详情">
            
                    
                    查看模拟运行详情
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.5" data-path="operation3.html">
            
                <a href="operation3.html#模拟运行中调参">
            
                    
                    模拟运行中调参
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.6" data-path="operation3.html">
            
                <a href="operation3.html#模拟运行中手动下单">
            
                    
                    模拟运行中手动下单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.7" data-path="operation3.html">
            
                <a href="operation3.html#模拟运行中盘前挂单">
            
                    
                    模拟运行中盘前挂单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.8" data-path="operation3.html">
            
                <a href="operation3.html#查看模拟账户">
            
                    
                    查看模拟账户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.9" data-path="operation3.html">
            
                <a href="operation3.html#风控管理">
            
                    
                    风控管理
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="operation3.html">
            
                <a href="operation3.html#实盘交易">
            
                    
                    实盘交易
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.6.1" data-path="operation3.html">
            
                <a href="operation3.html#创建实盘交易运行实例">
            
                    
                    创建实盘交易运行实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.2" data-path="operation3.html">
            
                <a href="operation3.html#实盘运行实例">
            
                    
                    实盘运行实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.3" data-path="operation3.html">
            
                <a href="operation3.html#查看实盘运行详情">
            
                    
                    查看实盘运行详情
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.4" data-path="operation3.html">
            
                <a href="operation3.html#实盘运行中调参">
            
                    
                    实盘运行中调参
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.5" data-path="operation3.html">
            
                <a href="operation3.html#实盘运行中手动下单">
            
                    
                    实盘运行中手动下单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.6" data-path="operation3.html">
            
                <a href="operation3.html#实盘运行中盘前挂单">
            
                    
                    实盘运行中盘前挂单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.7" data-path="operation3.html">
            
                <a href="operation3.html#查看实盘账户">
            
                    
                    查看实盘账户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6.8" data-path="operation3.html">
            
                <a href="operation3.html#实盘风控管理">
            
                    
                    实盘风控管理
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="runtime4.html">
            
                <a href="runtime4.html#运行环境">
            
                    
                    运行环境
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="runtime4.html">
            
                <a href="runtime4.html#支持语言及所需模块">
            
                    
                    支持语言及所需模块
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="runtime4.html">
            
                <a href="runtime4.html#行情订阅">
            
                    
                    行情订阅
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="runtime4.html">
            
                <a href="runtime4.html#撮合机制">
            
                    
                    撮合机制
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.1" data-path="runtime4.html">
            
                <a href="runtime4.html#回测环境">
            
                    
                    回测环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.2" data-path="runtime4.html">
            
                <a href="runtime4.html#交易环境">
            
                    
                    交易环境
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="runtime4.html">
            
                <a href="runtime4.html#交易引擎">
            
                    
                    交易引擎
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.4.1" data-path="runtime4.html">
            
                <a href="runtime4.html#交易税费">
            
                    
                    交易税费
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.2" data-path="runtime4.html">
            
                <a href="runtime4.html#滑点">
            
                    
                    滑点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.3" data-path="runtime4.html">
            
                <a href="runtime4.html#执行时间">
            
                    
                    执行时间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.4" data-path="runtime4.html">
            
                <a href="runtime4.html#交易环境下日k的收取">
            
                    
                    交易环境下日K的收取
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.5" data-path="runtime4.html">
            
                <a href="runtime4.html#除权除息">
            
                    
                    除权除息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.6" data-path="runtime4.html">
            
                <a href="runtime4.html#期货连续合约跳空">
            
                    
                    期货连续合约跳空
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.7" data-path="runtime4.html">
            
                <a href="runtime4.html#期货交割日处理">
            
                    
                    期货交割日处理
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="runtime4.html">
            
                <a href="runtime4.html#业绩评价">
            
                    
                    业绩评价
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.5.1" data-path="runtime4.html">
            
                <a href="runtime4.html#策略收益率">
            
                    
                    策略收益率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.2" data-path="runtime4.html">
            
                <a href="runtime4.html#基准收益率">
            
                    
                    基准收益率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.3" data-path="runtime4.html">
            
                <a href="runtime4.html#策略年化收益率">
            
                    
                    策略年化收益率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.4" data-path="runtime4.html">
            
                <a href="runtime4.html#策略收益波动率">
            
                    
                    策略收益波动率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.5" data-path="runtime4.html">
            
                <a href="runtime4.html#夏普比率">
            
                    
                    夏普比率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.6" data-path="runtime4.html">
            
                <a href="runtime4.html#平仓胜率">
            
                    
                    平仓胜率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.7" data-path="runtime4.html">
            
                <a href="runtime4.html#最大回撤">
            
                    
                    最大回撤
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="api5.html">
            
                <a href="api5.html#api使用文档">
            
                    
                    API使用文档
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="api5.html">
            
                <a href="api5.html#从一个简单的策略示例说起">
            
                    
                    从一个简单的策略示例说起
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1.1" data-path="api5.html">
            
                <a href="api5.html#引入etasdk量化策略库">
            
                    
                    引入etasdk量化策略库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.2" data-path="api5.html">
            
                <a href="api5.html#系统初始化事件">
            
                    
                    系统初始化事件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.3" data-path="api5.html">
            
                <a href="api5.html#盘前事件">
            
                    
                    盘前事件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.4" data-path="api5.html">
            
                <a href="api5.html#盘中事件">
            
                    
                    盘中事件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.5" data-path="api5.html">
            
                <a href="api5.html#系统终止事件-回测">
            
                    
                    系统终止事件-回测
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.6" data-path="api5.html">
            
                <a href="api5.html#小结">
            
                    
                    小结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="api5.html">
            
                <a href="api5.html#深度理解api-必看">
            
                    
                    深度理解API-必看
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="api5.html">
            
                <a href="api5.html#主要问题">
            
                    
                    主要问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="api5.html">
            
                <a href="api5.html#设置数据">
            
                    
                    设置数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.3" data-path="api5.html">
            
                <a href="api5.html#减少k线播放量">
            
                    
                    减少K线播放量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.4" data-path="api5.html">
            
                <a href="api5.html#k线的三种播放机制">
            
                    
                    K线的三种播放机制
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="api5.html">
            
                <a href="api5.html#内置数据结构">
            
                    
                    内置数据结构
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="api5.html">
            
                <a href="api5.html#refdata-股票基础信息">
            
                    
                    RefData-股票基础信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.2" data-path="api5.html">
            
                <a href="api5.html#tick-tick行情信息">
            
                    
                    Tick-Tick行情信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.3" data-path="api5.html">
            
                <a href="api5.html#bar-bar数据信息">
            
                    
                    Bar-Bar数据信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.4" data-path="api5.html">
            
                <a href="api5.html#symbolposition-策略的标的持仓">
            
                    
                    SymbolPosition-策略的标的持仓
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.5" data-path="api5.html">
            
                <a href="api5.html#strategypnl-策略的盈亏信息">
            
                    
                    StrategyPnL-策略的盈亏信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.6" data-path="api5.html">
            
                <a href="api5.html#overallposition-账户的标的持仓">
            
                    
                    OverallPosition-账户的标的持仓
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.7" data-path="api5.html">
            
                <a href="api5.html#account-账户信息">
            
                    
                    Account-账户信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.8" data-path="api5.html">
            
                <a href="api5.html#order-订单委托信息">
            
                    
                    Order-订单委托信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.9" data-path="api5.html">
            
                <a href="api5.html#etatime-时间信息">
            
                    
                    EtaTime-时间信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="api5.html">
            
                <a href="api5.html#内置枚举类型">
            
                    
                    内置枚举类型
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.4.1" data-path="api5.html">
            
                <a href="api5.html#etimespan-频率类型">
            
                    
                    ETimeSpan-频率类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.2" data-path="api5.html">
            
                <a href="api5.html#epricemode-复权模式">
            
                    
                    EPriceMode-复权模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.3" data-path="api5.html">
            
                <a href="api5.html#epositionside-持仓方向">
            
                    
                    EPositionSide-持仓方向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.4" data-path="api5.html">
            
                <a href="api5.html#eorderside-买卖方向">
            
                    
                    EOrderSide-买卖方向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.5" data-path="api5.html">
            
                <a href="api5.html#eordertype-订单类型">
            
                    
                    EOrderType-订单类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.6" data-path="api5.html">
            
                <a href="api5.html#eordstatus-订单状态">
            
                    
                    EOrdStatus-订单状态
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.7" data-path="api5.html">
            
                <a href="api5.html#eexectype-订单执行状态">
            
                    
                    EExecType-订单执行状态
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.8" data-path="api5.html">
            
                <a href="api5.html#etimeinforce-订单委托属性">
            
                    
                    ETimeInForce-订单委托属性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4.9" data-path="api5.html">
            
                <a href="api5.html#etapricelist-报价列表">
            
                    
                    EtaPriceList-报价列表
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="api5.html">
            
                <a href="api5.html#需要实现的事件">
            
                    
                    需要实现的事件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.5.1" data-path="api5.html">
            
                <a href="api5.html#oninitializeapi-初始化">
            
                    
                    on_initialize(api)-初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.2" data-path="api5.html">
            
                <a href="api5.html#onbeforemarketopenapi-tradedate-盘前运行">
            
                    
                    on_before_market_open(api, trade_date)-盘前运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.3" data-path="api5.html">
            
                <a href="api5.html#onbarapi-bar-bar响应回调">
            
                    
                    on_bar(api, bar)-Bar响应回调
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.4" data-path="api5.html">
            
                <a href="api5.html#onhandledataapi-timestamp-数据到齐后触发">
            
                    
                    on_handle_data(api, timestamp)-数据到齐后触发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.5" data-path="api5.html">
            
                <a href="api5.html#onterminateapi-result-运行终止">
            
                    
                    on_terminate(api, result)-运行终止
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.6" data-path="api5.html">
            
                <a href="api5.html#ontimerapi-定时器">
            
                    
                    on_timer(api)-定时器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.7" data-path="api5.html">
            
                <a href="api5.html#onorderupdateapi-order-订单状态更新回调">
            
                    
                    on_order_update(api, order)-订单状态更新回调
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="api5.html">
            
                <a href="api5.html#内置上下文参数-apicontext">
            
                    
                    内置上下文参数-api.context
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.6.1" data-path="api5.html">
            
                <a href="api5.html#取当前策略上下文的方式">
            
                    
                    取当前策略上下文的方式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.2" data-path="api5.html">
            
                <a href="api5.html#取指定策略名称的上下文的方式">
            
                    
                    取指定策略名称的上下文的方式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.3" data-path="api5.html">
            
                <a href="api5.html#初始化参数">
            
                    
                    初始化参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.4" data-path="api5.html">
            
                <a href="api5.html#时间处理参数">
            
                    
                    时间处理参数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.6.4.1" data-path="api5.html">
            
                <a href="api5.html#1-当前时间">
            
                    
                    1. 当前时间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.4.2" data-path="api5.html">
            
                <a href="api5.html#2-取年月日时分秒等">
            
                    
                    2. 取年月日时分秒等
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.4.3" data-path="api5.html">
            
                <a href="api5.html#3-转化普通时间">
            
                    
                    3. 转化普通时间
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.6.5" data-path="api5.html">
            
                <a href="api5.html#股票池参数">
            
                    
                    股票池参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.6" data-path="api5.html">
            
                <a href="api5.html#k线类参数">
            
                    
                    k线类参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.7" data-path="api5.html">
            
                <a href="api5.html#账户信息">
            
                    
                    账户信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.8" data-path="api5.html">
            
                <a href="api5.html#账户持仓信息">
            
                    
                    账户持仓信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6.9" data-path="api5.html">
            
                <a href="api5.html#策略信息">
            
                    
                    策略信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="api5.html">
            
                <a href="api5.html#只盘前支持的函数">
            
                    
                    只盘前支持的函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.7.1" data-path="api5.html">
            
                <a href="api5.html#setfocussymbolssymbols-设置关注的标的池">
            
                    
                    set_focus_symbols(symbols) 设置关注的标的池
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="api5.html">
            
                <a href="api5.html#交易函数">
            
                    
                    交易函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.8.1" data-path="api5.html">
            
                <a href="api5.html#targetpositionsymbol-qty-price-side-tif-remark-pricelist-目标仓位数量下单">
            
                    
                    target_position(symbol, qty, price, side, tif, remark, price_list) 目标仓位数量下单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8.2" data-path="api5.html">
            
                <a href="api5.html#cancelordersymbol-side-撤单">
            
                    
                    cancel_order(symbol， side) 撤单
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="api5.html">
            
                <a href="api5.html#查询函数">
            
                    
                    查询函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.1" data-path="api5.html">
            
                <a href="api5.html#获取策略账户信息">
            
                    
                    获取策略/账户信息
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.1.1" data-path="api5.html">
            
                <a href="api5.html#getsymbolpositionsymbol-side-获取策略级别单个标的仓位">
            
                    
                    get_symbol_position(symbol, side) 获取策略级别单个标的仓位
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.1.2" data-path="api5.html">
            
                <a href="api5.html#getsymbolpositions-获取所有持仓标的仓位信息">
            
                    
                    get_symbol_positions() 获取所有持仓标的仓位信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.1.3" data-path="api5.html">
            
                <a href="api5.html#getaccountsymbol-market-获取标的或者市场所属账户信息">
            
                    
                    get_account(symbol, market) 获取标的或者市场所属账户信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.1.4" data-path="api5.html">
            
                <a href="api5.html#getoverallpositionsymbol-获取标的汇总仓位">
            
                    
                    get_overall_position(symbol) 获取标的汇总仓位
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9.2" data-path="api5.html">
            
                <a href="api5.html#获取交易日期">
            
                    
                    获取交易日期
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.2.1" data-path="api5.html">
            
                <a href="api5.html#gettradedayintervalsymbol-startdate-enddate-获取交易日数">
            
                    
                    get_trade_day_interval(symbol, start_date, end_date) 获取交易日数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2.2" data-path="api5.html">
            
                <a href="api5.html#getprevtradedatetradedate-market-获取上一个交易日期">
            
                    
                    get_prev_trade_date(trade_date, market) 获取上一个交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2.3" data-path="api5.html">
            
                <a href="api5.html#getnexttradedatetradedate-market-获取下一个交易日期">
            
                    
                    get_next_trade_date(trade_date, market) 获取下一个交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2.4" data-path="api5.html">
            
                <a href="api5.html#gettradedatesstartdate-enddate-market-period-获取一段时间内交易日期">
            
                    
                    get_trade_dates(start_date, end_date, market，period) 获取一段时间内交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2.5" data-path="api5.html">
            
                <a href="api5.html#getprevtradedatestradedate-count-market-period-获取某个市场截止指定日期的多个交易日期">
            
                    
                    get_prev_trade_dates(trade_date, count, market, period) 获取某个市场截止指定日期的多个交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2.6" data-path="api5.html">
            
                <a href="api5.html#datenow-获取当前交易日期">
            
                    
                    date_now() 获取当前交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.2.7" data-path="api5.html">
            
                <a href="api5.html#timenow-获取当前交易时间">
            
                    
                    time_now() 获取当前交易时间
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9.3" data-path="api5.html">
            
                <a href="api5.html#获取标的信息">
            
                    
                    获取标的信息
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.3.1" data-path="api5.html">
            
                <a href="api5.html#getrefdatasymbol-获取标的基本信息">
            
                    
                    get_ref_data(symbol) 获取标的基本信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3.2" data-path="api5.html">
            
                <a href="api5.html#getconstituentsymbolssymbolset-tradedate-获取成分股数据">
            
                    
                    get_constituent_symbols(symbol_set, trade_date) 获取成分股数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3.3" data-path="api5.html">
            
                <a href="api5.html#getcontinuoussymbolsymbol-tradedate-获取连续合约对应的标的">
            
                    
                    get_continuous_symbol(symbol, trade_date) 获取连续合约对应的标的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3.4" data-path="api5.html">
            
                <a href="api5.html#getappointedsymbolsmode-tradedate-获取指定合约集合">
            
                    
                    get_appointed_symbols(mode, trade_date) 获取指定合约集合
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3.5" data-path="api5.html">
            
                <a href="api5.html#issuspendsymbol-tradedate-是否停牌">
            
                    
                    is_suspend(symbol, trade_date) 是否停牌
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3.6" data-path="api5.html">
            
                <a href="api5.html#isstsymbol-tradedate-是否st股">
            
                    
                    is_ST(symbol, trade_date) 是否ST股
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.3.7" data-path="api5.html">
            
                <a href="api5.html#islistedsymbol-tradedate-是否上市">
            
                    
                    is_listed(symbol, trade_date) 是否上市
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9.4" data-path="api5.html">
            
                <a href="api5.html#获取标的数据">
            
                    
                    获取标的数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.4.1" data-path="api5.html">
            
                <a href="api5.html#getbarshistorysymbol-timespan-count-pricemode-skipsuspended-fields-获取历史k线数据">
            
                    
                    get_bars_history(symbol, time_span, count, price_mode, skip_suspended, fields) 获取历史K线数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.4.2" data-path="api5.html">
            
                <a href="api5.html#getvaluefieldsymbols-fields-startdate-enddate-count-获取数值类因子">
            
                    
                    get_value_field(symbols, fields, start_date, end_date, count) 获取数值类因子
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.4.3" data-path="api5.html">
            
                <a href="api5.html#getfinancefieldssymbols-fields-tradedate-report-获取财务数据单交易日">
            
                    
                    get_finance_fields(symbols, fields, trade_date, report) 获取财务数据(单交易日)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.4.4" data-path="api5.html">
            
                <a href="api5.html#gettablefieldsymbol-field-startdate-enddate-count-columns-获取表格类因子数据">
            
                    
                    get_table_field(symbol, field, start_date, end_date, count, columns) 获取表格类因子数据
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.9.5" data-path="api5.html">
            
                <a href="api5.html#更多">
            
                    
                    更多
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.9.5.1" data-path="api5.html">
            
                <a href="api5.html#getdynamicvaluefield-获取动态运行参数">
            
                    
                    get_dynamic_value(field) 获取动态运行参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.5.2" data-path="api5.html">
            
                <a href="api5.html#getdefinedata-获取命令行参数">
            
                    
                    get_define_data-获取命令行参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.5.3" data-path="api5.html">
            
                <a href="api5.html#log-日志输出">
            
                    
                    log.*-日志输出
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9.5.4" data-path="api5.html">
            
                <a href="api5.html#sendcustommessagemsg-设置用户自定义运行消息">
            
                    
                    send_custom_message(msg) 设置用户自定义运行消息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="starategy6.html">
            
                <a href="starategy6.html#策略示例">
            
                    
                    策略示例
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="starategy6.html">
            
                <a href="starategy6.html#入门策略">
            
                    
                    入门策略
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="starategy6.html">
            
                <a href="starategy6.html#buysellsymbol-股票买卖策略">
            
                    
                    buySellSymbol-股票买卖策略
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="starategy6.html">
            
                <a href="starategy6.html#buysellfutures-期货买卖策略">
            
                    
                    buySellFutures-期货买卖策略
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="starategy6.html">
            
                <a href="starategy6.html#ma-双均线策略（股票）">
            
                    
                    MA-双均线策略（股票）
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="starategy6.html">
            
                <a href="starategy6.html#进阶股票策略">
            
                    
                    进阶股票策略
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.1" data-path="starategy6.html">
            
                <a href="starategy6.html#buydemo-带参数的买入策略（股票）">
            
                    
                    buyDemo-带参数的买入策略（股票）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2" data-path="starategy6.html">
            
                <a href="starategy6.html#multifactor-多因子选股（股票）">
            
                    
                    multiFactor-多因子选股（股票）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.3" data-path="starategy6.html">
            
                <a href="starategy6.html#stocktiming-股票择时（股票）">
            
                    
                    stockTiming-股票择时（股票）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.4" data-path="starategy6.html">
            
                <a href="starategy6.html#industryrotation-行业轮动（股票）">
            
                    
                    industryRotation-行业轮动（股票）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.5" data-path="starategy6.html">
            
                <a href="starategy6.html#indexhedgealpha-指数对冲（股票期货）">
            
                    
                    index_hedge_alpha-指数对冲（股票+期货）
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="starategy6.html">
            
                <a href="starategy6.html#精通股票策略">
            
                    
                    精通股票策略
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="starategy6.html">
            
                <a href="starategy6.html#machinelearning-机器学习（股票）">
            
                    
                    machineLearning-机器学习（股票）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="starategy6.html">
            
                <a href="starategy6.html#intradaystocktrade-日内回转交易（股票）">
            
                    
                    intradayStockTrade-日内回转交易（股票）
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="starategy6.html">
            
                <a href="starategy6.html#高阶经典期货策略">
            
                    
                    高阶经典期货策略
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="starategy6.html">
            
                <a href="starategy6.html#nettrade-网格交易（期货）">
            
                    
                    net_trade-网格交易（期货）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="starategy6.html">
            
                <a href="starategy6.html#turtletradingrule-海龟交易法（期货）">
            
                    
                    turtleTradingRule-海龟交易法（期货）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.3" data-path="starategy6.html">
            
                <a href="starategy6.html#intercommodityspread-跨市场套利（期货）">
            
                    
                    interCommoditySpread-跨市场套利（期货）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.4" data-path="starategy6.html">
            
                <a href="starategy6.html#calendararbitrage-跨期套利（期货）">
            
                    
                    calendarArbitrage-跨期套利（期货）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.5" data-path="starategy6.html">
            
                <a href="starategy6.html#dualtrust-日内交易（期货）">
            
                    
                    dualTrust-日内交易（期货）
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="data7.html">
            
                <a href="data7.html#平台数据">
            
                    
                    平台数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="data7.html">
            
                <a href="data7.html#市场与代码约定">
            
                    
                    市场与代码约定
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1.1" data-path="data7.html">
            
                <a href="data7.html#股票">
            
                    
                    股票
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.2" data-path="data7.html">
            
                <a href="data7.html#期货">
            
                    
                    期货
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="data7.html">
            
                <a href="data7.html#特殊集合约定">
            
                    
                    特殊集合约定
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="data7.html">
            
                <a href="data7.html#市场板块集合">
            
                    
                    市场&板块集合
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.2" data-path="data7.html">
            
                <a href="data7.html#期货商品集合">
            
                    
                    期货商品集合
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="data7.html">
            
                <a href="data7.html#行情数据">
            
                    
                    行情数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.3.1" data-path="data7.html">
            
                <a href="data7.html#tick-tick数据">
            
                    
                    Tick-Tick数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.2" data-path="data7.html">
            
                <a href="data7.html#bar-bar数据">
            
                    
                    Bar-Bar数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.3" data-path="data7.html">
            
                <a href="data7.html#bar行情的频率类型">
            
                    
                    Bar行情的频率类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.4" data-path="data7.html">
            
                <a href="data7.html#期货主力合约">
            
                    
                    期货主力合约
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3.5" data-path="data7.html">
            
                <a href="data7.html#期货连续合约">
            
                    
                    期货连续合约
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="data7.html">
            
                <a href="data7.html#标的基础信息">
            
                    
                    标的基础信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="data7.html">
            
                <a href="data7.html#股票指数代码">
            
                    
                    股票指数代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="data7.html">
            
                <a href="data7.html#股票行业板块代码">
            
                    
                    股票行业板块代码
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.6.1" data-path="data7.html">
            
                <a href="data7.html#优品行业代码">
            
                    
                    优品行业代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6.2" data-path="data7.html">
            
                <a href="data7.html#申万一级行业代码">
            
                    
                    申万一级行业代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6.3" data-path="data7.html">
            
                <a href="data7.html#申万二级行业代码">
            
                    
                    申万二级行业代码
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="data7.html">
            
                <a href="data7.html#股票交易指标-日频">
            
                    
                    股票交易指标-日频
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.7.1" data-path="data7.html">
            
                <a href="data7.html#交易状态">
            
                    
                    交易状态
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7.2" data-path="data7.html">
            
                <a href="data7.html#基于l2衍生因子-深市">
            
                    
                    基于L2衍生因子-深市
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7.3" data-path="data7.html">
            
                <a href="data7.html#市值数据">
            
                    
                    市值数据
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.8" data-path="data7.html">
            
                <a href="data7.html#股票财务数据-季频">
            
                    
                    股票财务数据-季频
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.8.1" data-path="data7.html">
            
                <a href="data7.html#资产负债表">
            
                    
                    资产负债表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.8.2" data-path="data7.html">
            
                <a href="data7.html#利润表">
            
                    
                    利润表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.8.3" data-path="data7.html">
            
                <a href="data7.html#现金流量表">
            
                    
                    现金流量表
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.9" data-path="data7.html">
            
                <a href="data7.html#表格型数据">
            
                    
                    表格型数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.9.1" data-path="data7.html">
            
                <a href="data7.html#期货成交量">
            
                    
                    期货成交量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.9.2" data-path="data7.html">
            
                <a href="data7.html#期货持卖单量">
            
                    
                    期货持卖单量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.9.3" data-path="data7.html">
            
                <a href="data7.html#期货持买单量">
            
                    
                    期货持买单量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.9.4" data-path="data7.html">
            
                <a href="data7.html#申万一级行业指数日k行情数据">
            
                    
                    申万一级行业指数日K行情数据
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="question8.html">
            
                <a href="question8.html#常见问题">
            
                    
                    常见问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="question8.html">
            
                <a href="question8.html#关于优品量化">
            
                    
                    关于优品量化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1.1" data-path="question8.html">
            
                <a href="question8.html#什么是量化投资？">
            
                    
                    什么是量化投资？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.2" data-path="question8.html">
            
                <a href="question8.html#量化投资具体内容是什么？">
            
                    
                    量化投资具体内容是什么？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.3" data-path="question8.html">
            
                <a href="question8.html#量化投资的优势是？">
            
                    
                    量化投资的优势是？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.4" data-path="question8.html">
            
                <a href="question8.html#什么是优品量化平台？">
            
                    
                    什么是优品量化平台？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.5" data-path="question8.html">
            
                <a href="question8.html#优品量化提供哪些服务？">
            
                    
                    优品量化提供哪些服务？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.6" data-path="question8.html">
            
                <a href="question8.html#支持哪些交易品种？">
            
                    
                    支持哪些交易品种？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.7" data-path="question8.html">
            
                <a href="question8.html#可以做套利策略吗？">
            
                    
                    可以做套利策略吗？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.1.8" data-path="question8.html">
            
                <a href="question8.html#优品量化适用群体？">
            
                    
                    优品量化适用群体？
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="question8.html">
            
                <a href="question8.html#策略问题">
            
                    
                    策略问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.2.1" data-path="question8.html">
            
                <a href="question8.html#有现成策略提供吗？是否收费？">
            
                    
                    有现成策略提供吗？是否收费？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.2" data-path="question8.html">
            
                <a href="question8.html#策略归谁所有？是否安全？">
            
                    
                    策略归谁所有？是否安全？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.3" data-path="question8.html">
            
                <a href="question8.html#优品量化有哪些风控策略？">
            
                    
                    优品量化有哪些风控策略？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.4" data-path="question8.html">
            
                <a href="question8.html#策略id有什么用？如何产生的？">
            
                    
                    策略ID有什么用？如何产生的？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2.5" data-path="question8.html">
            
                <a href="question8.html#支持哪些python库？">
            
                    
                    支持哪些Python库？
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="question8.html">
            
                <a href="question8.html#回测问题">
            
                    
                    回测问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.3.1" data-path="question8.html">
            
                <a href="question8.html#可以支持tick级别回测吗？">
            
                    
                    可以支持tick级别回测吗？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.2" data-path="question8.html">
            
                <a href="question8.html#按日线、分钟线和tick回测的区别">
            
                    
                    按日线、分钟线和tick回测的区别
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.3" data-path="question8.html">
            
                <a href="question8.html#不同市场的tick数据推送频率是否相同？">
            
                    
                    不同市场的tick数据推送频率是否相同？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3.4" data-path="question8.html">
            
                <a href="question8.html#回测股票策略时如何处理复权、拆分、分红等变化？">
            
                    
                    回测股票策略时如何处理复权、拆分、分红等变化？
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="question8.html">
            
                <a href="question8.html#模拟交易问题">
            
                    
                    模拟交易问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.4.1" data-path="question8.html">
            
                <a href="question8.html#模拟交易有什么用处？">
            
                    
                    模拟交易有什么用处？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4.2" data-path="question8.html">
            
                <a href="question8.html#模拟交易和回测有什么区别？">
            
                    
                    模拟交易和回测有什么区别？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4.3" data-path="question8.html">
            
                <a href="question8.html#一个账户能能否同时运行多个模拟交易？">
            
                    
                    一个账户能能否同时运行多个模拟交易？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4.4" data-path="question8.html">
            
                <a href="question8.html#模拟交易中哪些参数可以调整优化？">
            
                    
                    模拟交易中哪些参数可以调整优化？
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="question8.html">
            
                <a href="question8.html#平台使用问题">
            
                    
                    平台使用问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.5.1" data-path="question8.html">
            
                <a href="question8.html#使用sdk常见错误码问题">
            
                    
                    使用SDK常见错误码问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5.2" data-path="question8.html">
            
                <a href="question8.html#更多错误码原因">
            
                    
                    更多错误码原因
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5.3" data-path="question8.html">
            
                <a href="question8.html#没有触发onbar回调原因">
            
                    
                    没有触发onBar回调原因
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5.4" data-path="question8.html">
            
                <a href="question8.html#没有触发onhandledata回调原因">
            
                    
                    没有触发onHandleData回调原因
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5.5" data-path="question8.html">
            
                <a href="question8.html#getbarshistory获取不到历史k线的原因">
            
                    
                    getBarsHistory获取不到历史K线的原因
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5.6" data-path="question8.html">
            
                <a href="question8.html#期货交易是否有结算处理">
            
                    
                    期货交易是否有结算处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5.7" data-path="question8.html">
            
                <a href="question8.html#优品的数据是什么时候更新的？">
            
                    
                    优品的数据是什么时候更新的？
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="question8.html">
            
                <a href="question8.html#其他问题">
            
                    
                    其他问题
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.6.1" data-path="question8.html">
            
                <a href="question8.html#什么是主力合约？什么的当月连续合约？">
            
                    
                    什么是主力合约？什么的当月连续合约？
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="apiold9.html">
            
                <a href="apiold9.html#api文档（旧版）">
            
                    
                    API文档  (旧版)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="apiold9.html">
            
                <a href="apiold9.html#一个简单的策略">
            
                    
                    一个简单的策略
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="apiold9.html">
            
                <a href="apiold9.html#深度理解api（必看）">
            
                    
                    深度理解API(必看)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.2.1" data-path="apiold9.html">
            
                <a href="apiold9.html#主要问题">
            
                    
                    主要问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.2" data-path="apiold9.html">
            
                <a href="apiold9.html#设置数据">
            
                    
                    设置数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.3" data-path="apiold9.html">
            
                <a href="apiold9.html#减少k线播放量">
            
                    
                    减少K线播放量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2.4" data-path="apiold9.html">
            
                <a href="apiold9.html#k线的三种播放机制">
            
                    
                    K线的三种播放机制
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="apiold9.html">
            
                <a href="apiold9.html#数据结构">
            
                    
                    数据结构
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.3.1" data-path="apiold9.html">
            
                <a href="apiold9.html#refdata-股票基础信息">
            
                    
                    RefData-股票基础信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.2" data-path="apiold9.html">
            
                <a href="apiold9.html#tick-tick行情信息">
            
                    
                    Tick-Tick行情信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.3" data-path="apiold9.html">
            
                <a href="apiold9.html#bar-bar数据信息">
            
                    
                    Bar-Bar数据信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.4" data-path="apiold9.html">
            
                <a href="apiold9.html#symbolposition-策略持仓信息">
            
                    
                    SymbolPosition-策略持仓信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.5" data-path="apiold9.html">
            
                <a href="apiold9.html#strategypnl-策略盈亏信息">
            
                    
                    StrategyPnL-策略盈亏信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.6" data-path="apiold9.html">
            
                <a href="apiold9.html#overallposition-账户标的持仓信息">
            
                    
                    OverallPosition-账户标的持仓信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.7" data-path="apiold9.html">
            
                <a href="apiold9.html#account-账户信息">
            
                    
                    Account-账户信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3.8" data-path="apiold9.html">
            
                <a href="apiold9.html#order-订单委托信息">
            
                    
                    Order-订单委托信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="apiold9.html">
            
                <a href="apiold9.html#枚举类型">
            
                    
                    枚举类型
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.4.1" data-path="apiold9.html">
            
                <a href="apiold9.html#etimespan-频率类型">
            
                    
                    ETimeSpan-频率类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.2" data-path="apiold9.html">
            
                <a href="apiold9.html#epricemode-复权模式">
            
                    
                    EPriceMode-复权模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.3" data-path="apiold9.html">
            
                <a href="apiold9.html#epositionside-持仓方向">
            
                    
                    EPositionSide-持仓方向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.4" data-path="apiold9.html">
            
                <a href="apiold9.html#eorderside-买卖方向">
            
                    
                    EOrderSide-买卖方向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.5" data-path="apiold9.html">
            
                <a href="apiold9.html#eordertype-订单类型">
            
                    
                    EOrderType-订单类型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.6" data-path="apiold9.html">
            
                <a href="apiold9.html#eordstatus-订单状态">
            
                    
                    EOrdStatus-订单状态
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.7" data-path="apiold9.html">
            
                <a href="apiold9.html#eexectype-订单执行状态">
            
                    
                    EExecType-订单执行状态
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.8" data-path="apiold9.html">
            
                <a href="apiold9.html#etimeinforce-订单委托属性">
            
                    
                    ETimeInForce-订单委托属性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4.9" data-path="apiold9.html">
            
                <a href="apiold9.html#etapricelist-报价列表">
            
                    
                    EtaPriceList-报价列表
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.5" data-path="apiold9.html">
            
                <a href="apiold9.html#需要实现的事件">
            
                    
                    需要实现的事件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.5.1" data-path="apiold9.html">
            
                <a href="apiold9.html#oninitialize-初始化">
            
                    
                    onInitialize-初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.2" data-path="apiold9.html">
            
                <a href="apiold9.html#onbeforemarketopen-盘前运行">
            
                    
                    onBeforeMarketOpen-盘前运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.3" data-path="apiold9.html">
            
                <a href="apiold9.html#ontick-tick产生">
            
                    
                    onTick-tick产生
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.4" data-path="apiold9.html">
            
                <a href="apiold9.html#onfirsttick-第一根tick触发">
            
                    
                    onFirstTick-第一根tick触发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.5" data-path="apiold9.html">
            
                <a href="apiold9.html#onbar-bar产生">
            
                    
                    onBar-Bar产生
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.6" data-path="apiold9.html">
            
                <a href="apiold9.html#onhandledata-数据到齐后触发">
            
                    
                    onHandleData-数据到齐后触发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.7" data-path="apiold9.html">
            
                <a href="apiold9.html#onterminate-运行终止">
            
                    
                    onTerminate-运行终止
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.8" data-path="apiold9.html">
            
                <a href="apiold9.html#ontimer-定时器">
            
                    
                    onTimer-定时器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.5.9" data-path="apiold9.html">
            
                <a href="apiold9.html#onorderupdate-订单状态更新回调">
            
                    
                    onOrderUpdate -订单状态更新回调
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.6" data-path="apiold9.html">
            
                <a href="apiold9.html#设置函数">
            
                    
                    设置函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.6.1" data-path="apiold9.html">
            
                <a href="apiold9.html#setrequiredata-设置策略所需缓存数据（包含k线、股票池和日频、季频、财务数据字段）">
            
                    
                    setRequireData-设置策略所需缓存数据（包含K线、股票池和日频、季频、财务数据字段）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6.2" data-path="apiold9.html">
            
                <a href="apiold9.html#setfocussymbols-设置关注的标的池">
            
                    
                    setFocusSymbols-设置关注的标的池
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6.3" data-path="apiold9.html">
            
                <a href="apiold9.html#setsymbolpool-设置股票池">
            
                    
                    setSymbolPool-设置股票池
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6.4" data-path="apiold9.html">
            
                <a href="apiold9.html#setrequirebars-设置行情数据缓存条数">
            
                    
                    setRequireBars-设置行情数据缓存条数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6.5" data-path="apiold9.html">
            
                <a href="apiold9.html#setrequirefields-设置缓存日频、季频、财务等非行情类数据">
            
                    
                    setRequireFields-设置缓存日频、季频、财务等非行情类数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6.6" data-path="apiold9.html">
            
                <a href="apiold9.html#setgroupmode-设置到齐回调模式">
            
                    
                    setGroupMode-设置到齐回调模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.6.7" data-path="apiold9.html">
            
                <a href="apiold9.html#settimercycle-设置定时回调频率">
            
                    
                    setTimerCycle-设置定时回调频率
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.7" data-path="apiold9.html">
            
                <a href="apiold9.html#交易函数">
            
                    
                    交易函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.7.1" data-path="apiold9.html">
            
                <a href="apiold9.html#targetposition-下单">
            
                    
                    targetPosition-下单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.7.2" data-path="apiold9.html">
            
                <a href="apiold9.html#cancelorder-撤单">
            
                    
                    cancelOrder-撤单
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.8" data-path="apiold9.html">
            
                <a href="apiold9.html#标的查询函数">
            
                    
                    标的查询函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.8.1" data-path="apiold9.html">
            
                <a href="apiold9.html#getsymbolposition-获取单个标的仓位">
            
                    
                    getSymbolPosition-获取单个标的仓位
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.8.2" data-path="apiold9.html">
            
                <a href="apiold9.html#getsymbolpositions-获取多个所有持仓标的仓位信息">
            
                    
                    getSymbolPositions-获取多个/所有持仓标的仓位信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.9" data-path="apiold9.html">
            
                <a href="apiold9.html#账户查询函数">
            
                    
                    账户查询函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.9.1" data-path="apiold9.html">
            
                <a href="apiold9.html#getaccount-获取标的所属账号信息">
            
                    
                    getAccount-获取标的所属账号信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.9.2" data-path="apiold9.html">
            
                <a href="apiold9.html#getoverallposition-获取标的汇总仓位">
            
                    
                    getOverallPosition-获取标的汇总仓位
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.10" data-path="apiold9.html">
            
                <a href="apiold9.html#策略查询函数">
            
                    
                    策略查询函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.10.1" data-path="apiold9.html">
            
                <a href="apiold9.html#getstrategypnl-获取策略盈亏信息">
            
                    
                    getStrategyPnL-获取策略盈亏信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.11" data-path="apiold9.html">
            
                <a href="apiold9.html#策略数据查询函数">
            
                    
                    策略数据查询函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.11.1" data-path="apiold9.html">
            
                <a href="apiold9.html#getvalueas-获取动态运行参数">
            
                    
                    getValueAs*-获取动态运行参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.2" data-path="apiold9.html">
            
                <a href="apiold9.html#getsymbolpool-获取股票池代码">
            
                    
                    getSymbolPool-获取股票池代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.3" data-path="apiold9.html">
            
                <a href="apiold9.html#getfocusandpositionsymbols-获取持仓和当日关注的标的代码">
            
                    
                    getFocusAndPositionSymbols-获取持仓和当日关注的标的代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.4" data-path="apiold9.html">
            
                <a href="apiold9.html#getpositionsymbols-获取持仓标的代码">
            
                    
                    getPositionSymbols-获取持仓标的代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.5" data-path="apiold9.html">
            
                <a href="apiold9.html#getappointedsymbols-获取指定合约集合">
            
                    
                    getAppointedSymbols-获取指定合约集合
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.6" data-path="apiold9.html">
            
                <a href="apiold9.html#getcurrtradedate-获取当前交易日期">
            
                    
                    getCurrTradeDate-获取当前交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.11.7" data-path="apiold9.html">
            
                <a href="apiold9.html#getbarshistory-获取历史k线数据">
            
                    
                    getBarsHistory-获取历史K线数据
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.12" data-path="apiold9.html">
            
                <a href="apiold9.html#基础数据查询函数">
            
                    
                    基础数据查询函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.12.1" data-path="apiold9.html">
            
                <a href="apiold9.html#getrefdata-获取标的基本信息">
            
                    
                    getRefData-获取标的基本信息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.2" data-path="apiold9.html">
            
                <a href="apiold9.html#getconstituentsymbols-获取成分股数据">
            
                    
                    getConstituentSymbols-获取成分股数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.3" data-path="apiold9.html">
            
                <a href="apiold9.html#getcontinuoussymbol-获取指定交易日连续主力等合约对应的合约代码">
            
                    
                    getContinuousSymbol-获取指定交易日连续/主力等合约对应的合约代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.4" data-path="apiold9.html">
            
                <a href="apiold9.html#getfieldsoneday-获取多只股票单个交易日的数据">
            
                    
                    getFieldsOneDay-获取多只股票单个交易日的数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.5" data-path="apiold9.html">
            
                <a href="apiold9.html#getfieldsrangedays-获取单只股票多个交易日的数据">
            
                    
                    getFieldsRangeDays-获取单只股票多个交易日的数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.6" data-path="apiold9.html">
            
                <a href="apiold9.html#getfieldscountdays-获取单只股票基于某个交易日的前n条数据">
            
                    
                    getFieldsCountDays-获取单只股票基于某个交易日的前n条数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.7" data-path="apiold9.html">
            
                <a href="apiold9.html#getstockfinfields-获取财务数据">
            
                    
                    getStockFinFields -获取财务数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.8" data-path="apiold9.html">
            
                <a href="apiold9.html#gettablefieldoneday-获取单标的某一交易日的表格型数据">
            
                    
                    getTableFieldOneDay-获取单标的某一交易日的表格型数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.9" data-path="apiold9.html">
            
                <a href="apiold9.html#gettablefieldrangedays-获取单标的多个交易日的表格型数据">
            
                    
                    getTableFieldRangeDays-获取单标的多个交易日的表格型数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.10" data-path="apiold9.html">
            
                <a href="apiold9.html#gettablefieldcountdays-获取单标的多条表格型数据">
            
                    
                    getTableFieldCountDays-获取单标的多条表格型数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.11" data-path="apiold9.html">
            
                <a href="apiold9.html#gettradedayinterval-获取交易日数">
            
                    
                    getTradeDayInterval-获取交易日数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.12" data-path="apiold9.html">
            
                <a href="apiold9.html#getprevtradedate-获取上一个交易日期">
            
                    
                    getPrevTradeDate-获取上一个交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.13" data-path="apiold9.html">
            
                <a href="apiold9.html#getnexttradedate-获取下一个交易日期">
            
                    
                    getNextTradeDate-获取下一个交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.14" data-path="apiold9.html">
            
                <a href="apiold9.html#gettradedates-获取一段时间内交易日期">
            
                    
                    getTradeDates-获取一段时间内交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.15" data-path="apiold9.html">
            
                <a href="apiold9.html#getprevtradedates-获取某个市场截止指定日期的多个交易日期">
            
                    
                    getPrevTradeDates-获取某个市场截止指定日期的多个交易日期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.16" data-path="apiold9.html">
            
                <a href="apiold9.html#issuspend-是否停牌">
            
                    
                    isSuspend-是否停牌
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.17" data-path="apiold9.html">
            
                <a href="apiold9.html#isst-是否st股">
            
                    
                    isST-是否ST股
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.12.18" data-path="apiold9.html">
            
                <a href="apiold9.html#islisted-是否上市">
            
                    
                    isListed-是否上市
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10.13" data-path="apiold9.html">
            
                <a href="apiold9.html#其他函数">
            
                    
                    其他函数
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.13.1" data-path="apiold9.html">
            
                <a href="apiold9.html#getdefinedata-获取命令行参数">
            
                    
                    getDefineData-获取命令行参数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.2" data-path="apiold9.html">
            
                <a href="apiold9.html#log-日志输出">
            
                    
                    LOG.*-日志输出
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.3" data-path="apiold9.html">
            
                <a href="apiold9.html#sendcustommsg-设置用户自定义运行消息">
            
                    
                    sendCustomMsg-设置用户自定义运行消息
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.4" data-path="apiold9.html">
            
                <a href="apiold9.html#istradingnow-标的当前时间是否为交易时间">
            
                    
                    isTradingNow-标的当前时间是否为交易时间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.13.5" data-path="apiold9.html">
            
                <a href="apiold9.html#timenow-获取时间">
            
                    
                    timeNow-获取时间
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >策略示例</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-anchor"></i><ul><li><span class="title-icon "></span><a href="#&#x7B56;&#x7565;&#x793A;&#x4F8B;"><b></b>&#x7B56;&#x7565;&#x793A;&#x4F8B;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5165;&#x95E8;&#x7B56;&#x7565;"><b></b>&#x5165;&#x95E8;&#x7B56;&#x7565;</a></li><ul><li><span class="title-icon "></span><a href="#buysellsymbol-&#x80A1;&#x7968;&#x4E70;&#x5356;&#x7B56;&#x7565;"><b></b>buySellSymbol-&#x80A1;&#x7968;&#x4E70;&#x5356;&#x7B56;&#x7565;</a></li><li><span class="title-icon "></span><a href="#buysellfutures-&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;"><b></b>buySellFutures-&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;</a></li><li><span class="title-icon "></span><a href="#ma-&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>MA-&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li></ul><li><span class="title-icon "></span><a href="#&#x8FDB;&#x9636;&#x80A1;&#x7968;&#x7B56;&#x7565;"><b></b>&#x8FDB;&#x9636;&#x80A1;&#x7968;&#x7B56;&#x7565;</a></li><ul><li><span class="title-icon "></span><a href="#buydemo-&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E70;&#x5165;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>buyDemo-&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E70;&#x5165;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#multifactor-&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>multiFactor-&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#stocktiming-&#x80A1;&#x7968;&#x62E9;&#x65F6;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>stockTiming-&#x80A1;&#x7968;&#x62E9;&#x65F6;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#industryrotation-&#x884C;&#x4E1A;&#x8F6E;&#x52A8;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>industryRotation-&#x884C;&#x4E1A;&#x8F6E;&#x52A8;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#indexhedgealpha-&#x6307;&#x6570;&#x5BF9;&#x51B2;&#xFF08;&#x80A1;&#x7968;&#x671F;&#x8D27;&#xFF09;"><b></b>index_hedge_alpha-&#x6307;&#x6570;&#x5BF9;&#x51B2;&#xFF08;&#x80A1;&#x7968;+&#x671F;&#x8D27;&#xFF09;</a></li></ul><li><span class="title-icon "></span><a href="#&#x7CBE;&#x901A;&#x80A1;&#x7968;&#x7B56;&#x7565;"><b></b>&#x7CBE;&#x901A;&#x80A1;&#x7968;&#x7B56;&#x7565;</a></li><ul><li><span class="title-icon "></span><a href="#machinelearning-&#x673A;&#x5668;&#x5B66;&#x4E60;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>machineLearning-&#x673A;&#x5668;&#x5B66;&#x4E60;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#intradaystocktrade-&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><b></b>intradayStockTrade-&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#xFF08;&#x80A1;&#x7968;&#xFF09;</a></li></ul><li><span class="title-icon "></span><a href="#&#x9AD8;&#x9636;&#x7ECF;&#x5178;&#x671F;&#x8D27;&#x7B56;&#x7565;"><b></b>&#x9AD8;&#x9636;&#x7ECF;&#x5178;&#x671F;&#x8D27;&#x7B56;&#x7565;</a></li><ul><li><span class="title-icon "></span><a href="#nettrade-&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><b></b>net_trade-&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#turtletradingrule-&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><b></b>turtleTradingRule-&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;&#xFF08;&#x671F;&#x8D27;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#intercommodityspread-&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><b></b>interCommoditySpread-&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#calendararbitrage-&#x8DE8;&#x671F;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><b></b>calendarArbitrage-&#x8DE8;&#x671F;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;</a></li><li><span class="title-icon "></span><a href="#dualtrust-&#x65E5;&#x5185;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><b></b>dualTrust-&#x65E5;&#x5185;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;</a></li></ul></ul></ul></div><a href="#&#x7B56;&#x7565;&#x793A;&#x4F8B;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="&#x7B56;&#x7565;&#x793A;&#x4F8B;"><a name="&#x7B56;&#x7565;&#x793A;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#&#x7B56;&#x7565;&#x793A;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7B56;&#x7565;&#x793A;&#x4F8B;</h1>
<h2 id="&#x5165;&#x95E8;&#x7B56;&#x7565;"><a name="&#x5165;&#x95E8;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#&#x5165;&#x95E8;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5165;&#x95E8;&#x7B56;&#x7565;</h2>
<h3 id="buysellsymbol-&#x80A1;&#x7968;&#x4E70;&#x5356;&#x7B56;&#x7565;"><a name="buysellsymbol-&#x80A1;&#x7968;&#x4E70;&#x5356;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#buysellsymbol-&#x80A1;&#x7968;&#x4E70;&#x5356;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>buySellSymbol-&#x80A1;&#x7968;&#x4E70;&#x5356;&#x7B56;&#x7565;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

from etasdk import *

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x80A1;&#x7968;&#x7B56;&#x7565;&#xFF1A;&#x4E70;&#x5356;&#x7B56;&#x7565;
&#x672C;&#x7B56;&#x7565;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4E70;&#x5356;&#x7B56;&#x7565;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4F53;&#x73B0;&#x5982;&#x4F55;&#x4E0B;&#x5355;&#x7684;&#x3002;&#x5F53;&#x6CA1;&#x6709;&#x6301;&#x4ED3;&#x65F6;&#x5C31;&#x8FDB;&#x884C;&#x4E70;&#x5165;&#x64CD;&#x4F5C;&#xFF0C;&#x5F53;&#x6709;&#x6301;&#x4ED3;&#x65F6;&#xFF0C;&#x5C31;&#x8FDB;&#x884C;&#x5356;&#x51FA;&#x5E73;&#x4ED3;&#x64CD;&#x4F5C;
&#x56DE;&#x6D4B;&#x6807;&#x7684;&#xFF1A;&#x5E73;&#x5B89;&#x94F6;&#x884C;&#xFF08;000001.CS&#xFF09;
&#x56DE;&#x6D4B;&#x5468;&#x671F;&#xFF1A;20180702-20181101
&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;&#x65E5;K
&#x66F4;&#x591A;&#x8BE6;&#x60C5;&#x8BF7;&#x770B;&#x5E2E;&#x52A9;&#x6587;&#x6863;&#xFF1A;http://quant.upchina.com/doc/first.html
&apos;</span><span class="hljs-string">&apos;&apos;</span>
<span class="hljs-keyword">if</span> __name_<span class="hljs-number">_</span> == <span class="hljs-string">&apos;__main__&apos;</span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5E76;&#x542F;&#x52A8;&#x7B56;&#x7565;</span>
    config = {
        <span class="hljs-string">&quot;host&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;120.55.22.60&quot;</span>,
        <span class="hljs-string">&quot;port&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">80</span>,
        <span class="hljs-string">&quot;user&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;SDK-User&quot;</span>,         <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x70B9;&#x51FB;&#x91CF;&#x5316;&#x5E73;&#x53F0;&#x53F3;&#x4E0A;&#x89D2;&#x7528;&#x6237;&#x540D;&#x53EF;&#x67E5;&#x770B;&#x586B;&#x5199;</span>
        <span class="hljs-string">&quot;token&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;SDK-Token&quot;</span>,          <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x70B9;&#x51FB;&#x91CF;&#x5316;&#x5E73;&#x53F0;&#x53F3;&#x4E0A;&#x89D2;&#x7528;&#x6237;&#x540D;&#x53EF;&#x67E5;&#x770B;&#x586B;&#x5199;</span>
        <span class="hljs-string">&quot;strategy_name&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;buySellSymbol&quot;</span>,   <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x7B56;&#x7565;&#x540D;&#x79F0;</span>
        <span class="hljs-string">&quot;console&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>,
        <span class="hljs-string">&quot;loglevel&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;ERROR&quot;</span>,         <span class="hljs-comment"># &#x663E;&#x793A;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x67E5;&#x770B;&#x5E2E;&#x52A9;&#x6587;&#x6863;</span>
        <span class="hljs-string">&quot;instance_id&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;20190222-113322-609-001BI&quot;</span>,    <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x56DE;&#x6D4B;&#x8BB0;&#x5F55;&#x4E2D;&#x672C;&#x7B56;&#x7565;&#x7684;&#x56DE;&#x6D4B;ID,&#x70B9;&#x51FB;&#x590D;&#x5236;ID,&#x7C98;&#x8D34;&#x6B64;&#x5904;&#x5373;&#x53EF;</span>
        <span class="hljs-comment"># &#x521D;&#x59CB;&#x5316;&#x53C2;&#x6570;</span>
        <span class="hljs-string">&quot;initialize&quot;</span><span class="hljs-symbol">:</span> {
            <span class="hljs-comment"># symbols&#x91CC;&#x8BBE;&#x7F6E;&#x5355;&#x4E2A;&#x80A1;&#x7968;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x6709;&#x6548;&#x7684;&#x6807;&#x7684;</span>
            <span class="hljs-comment"># symbol_sets&#x91CC;&#x8BBE;&#x7F6E;&#x6807;&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;&#x6B64;&#x5904;&#x7684;IF.PRD&#x6307;&#x7684;&#x5C31;&#x662F;IF&#x54C1;&#x79CD;&#x7684;&#x6240;&#x6709;&#x6807;&#x51C6;&#x5408;&#x7EA6;&#xFF0C;&#x4E0D;&#x5305;&#x542B;IFZ0.CF&#x548C;IFZ1.CF</span>
            <span class="hljs-comment"># &#x6CE8;&#xFF1A;symbols&#x548C;symbol_sets&#x4E0D;&#x80FD;&#x5168;&#x90E8;&#x4E3A;&#x7A7A;</span>
            <span class="hljs-string">&apos;symbols&apos;</span><span class="hljs-symbol">:</span> [<span class="hljs-string">&apos;000001.CS&apos;</span>],
            <span class="hljs-comment"># fields&#x7F13;&#x5B58;&#x7684;&#x56E0;&#x5B50;</span>
            <span class="hljs-comment"># &apos;fields&apos;: [&apos;FUT_TRADE_RANK&apos;, &apos;FUT_SHORT_RANK&apos;, &apos;FUT_LONG_RANK&apos;, &apos;STK_HOLD_DET&apos;, &apos;STK_HOLD_STAT&apos;, &apos;ST_STA&apos;,&apos;LIST_STA&apos;, &apos;TRADE_STA&apos;, &apos;NET_PROFIT&apos;, &apos;PB&apos;, &apos;PE&apos;, &apos;PS&apos;, &apos;PE_TTM&apos;],</span>
            <span class="hljs-comment"># &#x5FC5;&#x586B;&#xFF1A;&#x8BBE;&#x7F6E;&#x6240;&#x9700;k&#x7EBF;&#x7C7B;&#x578B;&#xFF0C;interval&#x53EF;&#x4EE5;&#x9009;&#x53D6;1&#x5206;&#x949F;&#xFF0C;5&#x5206;&#x949F;&#xFF0C;15&#x5206;&#x949F;&#xFF0C;30&#x5206;&#x949F;&#xFF0C;60&#x5206;&#x949F;&#xFF0C;&#x65E5;k&#xFF0C;Tick&#x7EA7;&#x522B;&#xFF0C;count&#x4E3A;&#x63D0;&#x524D;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x76EE;</span>
            <span class="hljs-string">&apos;prepared_bars&apos;</span><span class="hljs-symbol">:</span> [{<span class="hljs-string">&apos;interval&apos;</span><span class="hljs-symbol">:</span> ETimeSpan.DAY_1, <span class="hljs-string">&apos;count&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">60</span>}],
            <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x8BBE;&#x7F6E;&#x64AE;&#x5408;&#x53C2;&#x6570; interval&#x4E3A;&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF0C;time_ranges&#x4E3A;&#x65E5;&#x5185;&#x64AE;&#x5408;&#x65F6;&#x95F4;&#x6BB5;&#xFF0C;&#x5C06;&#x53EA;&#x5728;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x6BB5;&#x4EE5;interval&#x5468;&#x671F;&#x56DE;&#x8C03;on_bar&#x6216;on_handle_date</span>
            <span class="hljs-string">&apos;match_param&apos;</span><span class="hljs-symbol">:</span> {
                <span class="hljs-string">&apos;interval&apos;</span><span class="hljs-symbol">:</span> ETimeSpan.DAY_1,
                <span class="hljs-comment"># &apos;time_ranges&apos;: [(&apos;12:00&apos;, &apos;14:45&apos;), (&apos;10:10&apos;, &apos;11:00&apos;)]</span>
            },

            <span class="hljs-string">&apos;mode&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&apos;both&apos;</span>,                       <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x4E3A;group_only&#xFF0C;&#x5219;&#x53EA;&#x54CD;&#x5E94;on_handle_data&#xFF1B;&#x4E3A;single_only&#xFF0C;&#x5219;&#x53EA;&#x54CD;&#x5E94;on_bar&#xFF1B;&#x4E3A;both&#xFF0C;&#x5219;&#x4E24;&#x4E2A;&#x56DE;&#x8C03;&#x540C;&#x65F6;&#x54CD;&#x5E94;</span>
            <span class="hljs-string">&apos;commission&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>.<span class="hljs-number">0002</span>,                       <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x8BBE;&#x7F6E;&#x624B;&#x7EED;&#x8D39;</span>

            <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x4EC5;&#x56DE;&#x6D4B;&#x751F;&#x6548;&#x7684;&#x9879;&#xFF0C;&#x4E0D;&#x8BBE;&#x7F6E;&#x65F6;&#x4EE5;web&#x9875;&#x9762;&#x4E0A;&#x7684;&#x8BBE;&#x7F6E;&#x4E3A;&#x51C6;</span>
            <span class="hljs-string">&apos;backtest&apos;</span><span class="hljs-symbol">:</span> {
                <span class="hljs-string">&apos;start_date&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">20180702</span>,                 <span class="hljs-comment"># &#x56DE;&#x6D4B;&#x5F00;&#x59CB;&#x65E5;&#x671F;</span>
                <span class="hljs-string">&apos;end_date&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">20181101</span>,                   <span class="hljs-comment"># &#x56DE;&#x6D4B;&#x7ED3;&#x675F;&#x65E5;&#x671F;</span>
                <span class="hljs-string">&apos;slippage&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>,                          <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x6ED1;&#x70B9;,&#x53D6;&#x503C;&#x4E3A;&#x6574;&#x6570;,&#x6807;&#x7684;&#x4EF7;&#x683C;&#x6D6E;&#x52A8;&#x6700;&#x5C0F;&#x5355;&#x4F4D;&#x503C;&#x7684;&#x6574;&#x6570;&#x500D;</span>
                <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x8D26;&#x6237;&#x521D;&#x59CB;&#x8D44;&#x91D1;</span>
                <span class="hljs-string">&apos;cash&apos;</span><span class="hljs-symbol">:</span> {
                    <span class="hljs-string">&apos;CS&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1000000</span>,                            <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x8D26;&#x6237;&#x8D44;&#x91D1;</span>
                    <span class="hljs-string">&apos;CF&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>                      <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x671F;&#x8D27;&#x8D26;&#x6237;&#x8D44;&#x91D1;</span>
                }
            },

            <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x4EC5;&#x6A21;&#x62DF;&#x76D8;/&#x5B9E;&#x76D8;&#x751F;&#x6548;&#x7684;&#x9879;</span>
            <span class="hljs-string">&apos;realtime&apos;</span><span class="hljs-symbol">:</span> {
                <span class="hljs-string">&apos;pre_market_time&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&apos;8:50&apos;</span>,            <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F00;&#x76D8;&#x524D;&#x56DE;&#x8C03;on_before_market_open&#x54CD;&#x5E94;&#x4E8B;&#x4EF6;&#x65F6;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;web&#x9875;&#x9762;&#x4E0A;&#x8BBE;&#x7F6E;&#x7684;&#x65F6;&#x95F4;</span>
                <span class="hljs-string">&apos;closing_time&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&apos;14:55&apos;</span>,               <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x6536;&#x76D8;&#x524D;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x56DE;&#x8C03;on_bar&#x6216;on_handle_data&#x54CD;&#x5E94;&#x4E8B;&#x4EF6;&#x65F6;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;web&#x9875;&#x9762;&#x4E0A;&#x8BBE;&#x7F6E;&#x7684;&#x65F6;&#x95F4;</span>
                <span class="hljs-string">&apos;group_timeout&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">10000</span>,                <span class="hljs-comment"># &#x8BBE;&#x7F6E;group&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x7EC4;&#x64AD;&#xFF0C;&#x7B49;&#x5F85;&#x591A;&#x5C11;ms&#x5219;&#x5F3A;&#x5236;&#x54CD;&#x5E94;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;5000ms</span>
                <span class="hljs-string">&apos;timer_cycle&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">60000</span>                   <span class="hljs-comment"># &#x8BBE;&#x7F6E;onTimer&#x54CD;&#x5E94;&#x65F6;&#x95F4;(ms), &#x4E3A;0&#x5219;&#x4E0D;&#x54CD;&#x5E94;onTimer&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x56DE;&#x8C03;onTimer</span>
            }
        }
    }

    etasdk.load_config_json(config).start()



<span class="hljs-comment"># &#x5FC5;&#x8981;&#xFF1A;&#x6BCF;&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x56DE;&#x6D4B;/&#x6A21;&#x62DF;/&#x5B9E;&#x76D8;&#x524D;&#x8981;&#x505A;&#x7684;&#x64CD;&#x4F5C;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_before_market_open</span><span class="hljs-params">(api, date_now)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x5FC5;&#x8981;&#xFF1A;&#x83B7;&#x53D6;&#x5F53;&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x9700;&#x5173;&#x6CE8;&#x7684;&#x80A1;&#x7968;</span>
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x4ECA;&#x5929;&#x5173;&#x6CE8;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x5982;&#x679C;&#x80A1;&#x7968;&#x6C60;&#x4E2D;&#x53EA;&#x6709;&#x4E00;&#x53EA;&#x80A1;&#x7968;&#xFF0C;&#x5219;&#x5168;&#x90E8;&#x5173;&#x6CE8;&#x5373;&#x53EF;&#xFF1B;&#x80A1;&#x7968;&#x6C60;&#x4E2D;&#x80A1;&#x7968;&#x8FC7;&#x591A;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x5148;&#x9009;&#x80A1;&#x5728;&#x8BBE;&#x7F6E;&#x90E8;&#x5206;&#x5173;&#x6CE8;&#x4EE5;&#x63D0;&#x9AD8;&#x8FD0;&#x884C;&#x6548;&#x7387;</span>
    api.context.pool.focus = api.context.pool.all


<span class="hljs-comment"># &#x5FC5;&#x8981;&#xFF1A;&#x6BCF;&#x5929;&#x56DE;&#x6D4B;/&#x4EA4;&#x6613; &#x7B56;&#x7565; &#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#x56DE;&#x8C03;  on_bar/on_handle_data</span>
<span class="hljs-comment"># &#x7528;&#x65E5;K&#x505A;&#x56DE;&#x6D4B;&#xFF0C;&#x6240;&#x4EE5;&#x6BCF;&#x5929;&#x53EA;&#x4F1A;&#x8FDB;&#x5165;&#x4E00;&#x6B21;&#xFF0C;&#x6536;&#x76D8;&#x65F6;&#x54CD;&#x5E94;&#x6B64;&#x51FD;&#x6570;</span>
<span class="hljs-comment"># &#x7B56;&#x7565;&#x903B;&#x8F91;&#xFF1A;&#x7B2C;&#x4E00;&#x5929;&#x4E70;&#x5165;&#xFF0C;&#x7B2C;&#x4E8C;&#x5929;&#x5356;&#x51FA;&#xFF1B;&#x5224;&#x65AD;&#x903B;&#x8F91;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x6709;&#x4ED3;&#x4F4D;&#xFF0C;&#x5219;&#x5E73;&#x4ED3;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#xFF0C;&#x5219;&#x4E70;&#x5165;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_bar</span><span class="hljs-params">(api, bar)</span></span><span class="hljs-symbol">:</span>
    symbol_positions = api.get_symbol_positions()  <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6301;&#x4ED3;&#x6807;&#x7684;&#x4FE1;&#x606F;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-symbol">symbol_positions:</span>  <span class="hljs-comment"># &#x5982;&#x679C;&#x6301;&#x4ED3;&#x6570;&#x5927;&#x4E8E;0</span>
        <span class="hljs-comment"># &#x5E73;&#x4ED3;</span>
        log.info(<span class="hljs-string">&quot;target position zero!&quot;</span>)
        api.target_position(symbol=bar.symbol, qty=<span class="hljs-number">0</span>)  <span class="hljs-comment"># &#x5356;&#x51FA; &#xFF0C;symbol = &#x9009;&#x4E2D;&#x6807;&#x7684;&#xFF0C;&#x6570;&#x91CF;&#x53D8;&#x4E3A;0</span>
    <span class="hljs-symbol">else:</span>
        <span class="hljs-comment"># &#x5E02;&#x4EF7;&#x4E0B;&#x5355;1000&#x80A1;</span>
        log.info(<span class="hljs-string">&quot;target position 1000!&quot;</span>)
        api.target_position(symbol=bar.symbol, qty=<span class="hljs-number">50000</span>)  <span class="hljs-comment"># &#x4E70;&#x5165; symbol = &#x9009;&#x4E2D;&#x6807;&#x7684;&#xFF0C;&#x76F4;&#x81F3;&#x6301;&#x4ED3;&#x6570;&#x8FBE;500&#x80A1;</span>


<span class="hljs-comment"># &#x5B9A;&#x65F6;&#x5668;&#xFF0C;&#x6A21;&#x62DF;&#x76D8;&#x54CD;&#x5E94;&#xFF1B;&#x56DE;&#x6D4B;&#x65F6;&#x53EF;&#x5FFD;&#x7565;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_timer</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    pass


<span class="hljs-comment"># &#x7B56;&#x7565;&#x7EC8;&#x6B62;&#x65F6;&#x54CD;&#x5E94;&#xFF1B;&#x56DE;&#x6D4B;&#x8FD0;&#x884C;&#x7EC8;&#x6B62;&#x65F6;&#x4F1A;&#x8C03;&#x7528;&#x4E00;&#x6B21;, exit_info&#x8FD4;&#x56DE;&#x503C;&#x4E3A;&#x7EC8;&#x6B62;&#x6D88;&#x606F;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_terminate</span><span class="hljs-params">(api, exit_info)</span></span><span class="hljs-symbol">:</span>
    log.info(<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)  <span class="hljs-comment"># &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span>
</code></pre>
<h3 id="buysellfutures-&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;"><a name="buysellfutures-&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#buysellfutures-&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>buySellFutures-&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x671F;&#x8D27;&#x7B56;&#x7565;&#xFF1A;&#x4E70;&#x5356;&#x7B56;&#x7565;
&#x672C;&#x7B56;&#x7565;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x671F;&#x8D27;&#x4E70;&#x5356;&#x7B56;&#x7565;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4F53;&#x73B0;&#x671F;&#x8D27;&#x7B80;&#x5355;&#x4E70;&#x5356;
&#x66F4;&#x591A;&#x8BE6;&#x60C5;&#x8BF7;&#x770B;&#x5E2E;&#x52A9;&#x6587;&#x6863;&#xFF1A;http://quant.upchina.com/doc/first.html
&apos;</span><span class="hljs-string">&apos;&apos;</span>
from etasdk import *

<span class="hljs-keyword">if</span> __name_<span class="hljs-number">_</span> == <span class="hljs-string">&apos;__main__&apos;</span><span class="hljs-symbol">:</span>
    config = {
        <span class="hljs-string">&quot;host&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;120.55.22.60&quot;</span>,
        <span class="hljs-string">&quot;port&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">80</span>,
        <span class="hljs-string">&quot;user&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;SDK-User&quot;</span>,         <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x70B9;&#x51FB;&#x91CF;&#x5316;&#x5E73;&#x53F0;&#x53F3;&#x4E0A;&#x89D2;&#x7528;&#x6237;&#x540D;&#x53EF;&#x67E5;&#x770B;&#x586B;&#x5199;</span>
        <span class="hljs-string">&quot;token&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;SDK-Token&quot;</span>,          <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x70B9;&#x51FB;&#x91CF;&#x5316;&#x5E73;&#x53F0;&#x53F3;&#x4E0A;&#x89D2;&#x7528;&#x6237;&#x540D;&#x53EF;&#x67E5;&#x770B;&#x586B;&#x5199;</span>
        <span class="hljs-string">&quot;strategy_name&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;buySellFutures&quot;</span>,   <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x7B56;&#x7565;&#x540D;&#x79F0;</span>
        <span class="hljs-string">&quot;console&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>,
        <span class="hljs-string">&quot;loglevel&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;ERROR&quot;</span>,         <span class="hljs-comment"># &#x663E;&#x793A;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x67E5;&#x770B;&#x5E2E;&#x52A9;&#x6587;&#x6863;</span>
        <span class="hljs-string">&quot;instance_id&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;20180605-165138-917-002BI&quot;</span>,    <span class="hljs-comment"># Web&#x7AEF;&#xFF1A;&#x56DE;&#x6D4B;&#x8BB0;&#x5F55;&#x4E2D;&#x672C;&#x7B56;&#x7565;&#x7684;&#x56DE;&#x6D4B;ID,&#x70B9;&#x51FB;&#x590D;&#x5236;ID,&#x7C98;&#x8D34;&#x6B64;&#x5904;&#x5373;&#x53EF;</span>
        <span class="hljs-comment"># &#x521D;&#x59CB;&#x5316;&#x53C2;&#x6570;</span>
        <span class="hljs-string">&quot;initialize&quot;</span><span class="hljs-symbol">:</span> {
            <span class="hljs-comment"># symbols&#x91CC;&#x8BBE;&#x7F6E;&#x5355;&#x4E2A;&#x80A1;&#x7968;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x6709;&#x6548;&#x7684;&#x6807;&#x7684;</span>
            <span class="hljs-comment"># symbol_sets&#x91CC;&#x8BBE;&#x7F6E;&#x6807;&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;&#x6B64;&#x5904;&#x7684;IF.PRD&#x6307;&#x7684;&#x5C31;&#x662F;IF&#x54C1;&#x79CD;&#x7684;&#x6240;&#x6709;&#x6807;&#x51C6;&#x5408;&#x7EA6;&#xFF0C;&#x4E0D;&#x5305;&#x542B;IFZ0.CF&#x548C;IFZ1.CF</span>
            <span class="hljs-comment"># &#x6CE8;&#xFF1A;symbols&#x548C;symbol_sets&#x4E0D;&#x80FD;&#x5168;&#x90E8;&#x4E3A;&#x7A7A;</span>
            <span class="hljs-string">&apos;symbols&apos;</span><span class="hljs-symbol">:</span> [<span class="hljs-string">&apos;IFZ0.CF&apos;</span>],
            <span class="hljs-string">&apos;symbol_sets&apos;</span><span class="hljs-symbol">:</span> [<span class="hljs-string">&apos;IF.PRD&apos;</span>],
            <span class="hljs-comment"># fields&#x7F13;&#x5B58;&#x7684;&#x56E0;&#x5B50;</span>
            <span class="hljs-comment"># &apos;fields&apos;: [&apos;FUT_TRADE_RANK&apos;, &apos;FUT_SHORT_RANK&apos;, &apos;FUT_LONG_RANK&apos;, &apos;STK_HOLD_DET&apos;, &apos;STK_HOLD_STAT&apos;, &apos;ST_STA&apos;,&apos;LIST_STA&apos;, &apos;TRADE_STA&apos;, &apos;NET_PROFIT&apos;, &apos;PB&apos;, &apos;PE&apos;, &apos;PS&apos;, &apos;PE_TTM&apos;],</span>
            <span class="hljs-comment"># &#x5FC5;&#x586B;&#xFF1A;&#x8BBE;&#x7F6E;&#x6240;&#x9700;k&#x7EBF;&#x7C7B;&#x578B;&#xFF0C;interval&#x53EF;&#x4EE5;&#x9009;&#x53D6;1&#x5206;&#x949F;&#xFF0C;5&#x5206;&#x949F;&#xFF0C;15&#x5206;&#x949F;&#xFF0C;30&#x5206;&#x949F;&#xFF0C;60&#x5206;&#x949F;&#xFF0C;&#x65E5;k&#xFF0C;Tick&#x7EA7;&#x522B;&#xFF0C;count&#x4E3A;&#x63D0;&#x524D;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x76EE;</span>
            <span class="hljs-string">&apos;prepared_bars&apos;</span><span class="hljs-symbol">:</span> [{<span class="hljs-string">&apos;interval&apos;</span><span class="hljs-symbol">:</span> ETimeSpan.MIN_5, <span class="hljs-string">&apos;count&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">100</span>}],
            <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x8BBE;&#x7F6E;&#x64AE;&#x5408;&#x53C2;&#x6570; interval&#x4E3A;&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF0C;time_ranges&#x4E3A;&#x65E5;&#x5185;&#x64AE;&#x5408;&#x65F6;&#x95F4;&#x6BB5;&#xFF0C;&#x5C06;&#x53EA;&#x5728;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x6BB5;&#x4EE5;interval&#x5468;&#x671F;&#x56DE;&#x8C03;on_bar&#x6216;on_handle_date</span>
            <span class="hljs-string">&apos;match_param&apos;</span><span class="hljs-symbol">:</span> {
                <span class="hljs-string">&apos;interval&apos;</span><span class="hljs-symbol">:</span> ETimeSpan.MIN_5,
                <span class="hljs-comment"># &apos;time_ranges&apos;: [(&apos;12:00&apos;, &apos;14:45&apos;), (&apos;10:10&apos;, &apos;11:00&apos;)]</span>
            },

            <span class="hljs-string">&apos;mode&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&apos;both&apos;</span>,                       <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x4E3A;group_only&#xFF0C;&#x5219;&#x53EA;&#x54CD;&#x5E94;on_handle_data&#xFF1B;&#x4E3A;single_only&#xFF0C;&#x5219;&#x53EA;&#x54CD;&#x5E94;on_bar&#xFF1B;&#x4E3A;both&#xFF0C;&#x5219;&#x4E24;&#x4E2A;&#x56DE;&#x8C03;&#x540C;&#x65F6;&#x54CD;&#x5E94;</span>
            <span class="hljs-string">&apos;commission&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>.<span class="hljs-number">0002</span>,                       <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x8BBE;&#x7F6E;&#x624B;&#x7EED;&#x8D39;</span>

            <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x4EC5;&#x56DE;&#x6D4B;&#x751F;&#x6548;&#x7684;&#x9879;&#xFF0C;&#x4E0D;&#x8BBE;&#x7F6E;&#x65F6;&#x4EE5;web&#x9875;&#x9762;&#x4E0A;&#x7684;&#x8BBE;&#x7F6E;&#x4E3A;&#x51C6;</span>
            <span class="hljs-string">&apos;backtest&apos;</span><span class="hljs-symbol">:</span> {
                <span class="hljs-string">&apos;start_date&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">20180629</span>,                 <span class="hljs-comment"># &#x56DE;&#x6D4B;&#x5F00;&#x59CB;&#x65E5;&#x671F;</span>
                <span class="hljs-string">&apos;end_date&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">20181228</span>,                   <span class="hljs-comment"># &#x56DE;&#x6D4B;&#x7ED3;&#x675F;&#x65E5;&#x671F;</span>
                <span class="hljs-string">&apos;slippage&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>,                          <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x6ED1;&#x70B9;,&#x53D6;&#x503C;&#x4E3A;&#x6574;&#x6570;,&#x6807;&#x7684;&#x4EF7;&#x683C;&#x6D6E;&#x52A8;&#x6700;&#x5C0F;&#x5355;&#x4F4D;&#x503C;&#x7684;&#x6574;&#x6570;&#x500D;</span>
                <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x8D26;&#x6237;&#x521D;&#x59CB;&#x8D44;&#x91D1;</span>
                <span class="hljs-string">&apos;cash&apos;</span><span class="hljs-symbol">:</span> {
                    <span class="hljs-string">&apos;CS&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">0</span>,                            <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x8D26;&#x6237;&#x8D44;&#x91D1;</span>
                    <span class="hljs-string">&apos;CF&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1000000</span>                      <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x671F;&#x8D27;&#x8D26;&#x6237;&#x8D44;&#x91D1;</span>
                }
            },

            <span class="hljs-comment"># &#x9009;&#x586B;&#xFF1A;&#x4EC5;&#x6A21;&#x62DF;&#x76D8;/&#x5B9E;&#x76D8;&#x751F;&#x6548;&#x7684;&#x9879;</span>
            <span class="hljs-string">&apos;realtime&apos;</span><span class="hljs-symbol">:</span> {
                <span class="hljs-string">&apos;pre_market_time&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&apos;19:00&apos;</span>,            <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F00;&#x76D8;&#x524D;&#x56DE;&#x8C03;on_before_market_open&#x54CD;&#x5E94;&#x4E8B;&#x4EF6;&#x65F6;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;web&#x9875;&#x9762;&#x4E0A;&#x8BBE;&#x7F6E;&#x7684;&#x65F6;&#x95F4;</span>
                <span class="hljs-string">&apos;closing_time&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&apos;14:55&apos;</span>,               <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x6536;&#x76D8;&#x524D;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x56DE;&#x8C03;on_bar&#x6216;on_handle_data&#x54CD;&#x5E94;&#x4E8B;&#x4EF6;&#x65F6;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;web&#x9875;&#x9762;&#x4E0A;&#x8BBE;&#x7F6E;&#x7684;&#x65F6;&#x95F4;</span>
                <span class="hljs-string">&apos;group_timeout&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">10000</span>,                <span class="hljs-comment"># &#x8BBE;&#x7F6E;group&#x6A21;&#x5F0F;&#x4E0B;&#x7684;&#x7EC4;&#x64AD;&#xFF0C;&#x7B49;&#x5F85;&#x591A;&#x5C11;ms&#x5219;&#x5F3A;&#x5236;&#x54CD;&#x5E94;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;5000ms</span>
                <span class="hljs-string">&apos;timer_cycle&apos;</span><span class="hljs-symbol">:</span> <span class="hljs-number">60000</span>                   <span class="hljs-comment"># &#x8BBE;&#x7F6E;onTimer&#x54CD;&#x5E94;&#x65F6;&#x95F4;(ms), &#x4E3A;0&#x5219;&#x4E0D;&#x54CD;&#x5E94;onTimer&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x56DE;&#x8C03;onTimer</span>
            }
        }
    }

    etasdk.load_config_json(config).start()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_before_market_open</span><span class="hljs-params">(api, date_now)</span></span><span class="hljs-symbol">:</span>
    print(date_now.date)
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x5FC5;&#x8981;&#xFF1A;&#x6BCF;&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x56DE;&#x6D4B;/&#x6A21;&#x62DF;/&#x5B9E;&#x76D8;&#x524D;&#x9700;&#x8981;&#x54CD;&#x5E94;&#x7684;&#x4E8B;&#x4EF6;
    :param api:
    :param trade_now:
    :return:
    &quot;</span><span class="hljs-string">&quot;&quot;</span>
    api.futures_code = api.get_continuous_symbol(<span class="hljs-string">&quot;IFZ0.CF&quot;</span>)  <span class="hljs-comment"># &#x83B7;&#x5F97;&#x5F53;&#x524D;&#x4EA4;&#x6613;&#x65E5;IF&#x4E3B;&#x529B;&#x5408;&#x7EA6;&#x4EE3;&#x7801;</span>
    print(api.futures_code)
    api.context.pool.focus = [api.futures_code, <span class="hljs-string">&apos;IFZ0.CF&apos;</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_handle_data</span><span class="hljs-params">(api, time_now)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x4EC5;&#x5F53;mode&#x4E3A;group_only&#x548C;both&#x65F6;&#x54CD;&#x5E94;&#x8BE5;&#x4E8B;&#x4EF6;
    on_handle_data&#x5728;Focus&#x6807;&#x7684;&#x6536;&#x9F50;&#x65F6;&#x6216;&#x8005;&#x8D85;&#x65F6;&#x65F6;&#x54CD;&#x5E94;
    &#x5FC5;&#x8981;&#xFF1A;&#x6BCF;&#x5929;&#x56DE;&#x6D4B;/&#x4EA4;&#x6613; &#x7B56;&#x7565; &#x53EF;&#x9009;&#x62E9;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;  on_bar/on_handle_data
    &#x7B56;&#x7565;&#x903B;&#x8F91;&#xFF1A;&#x5982;&#x679C;&#x4EF7;&#x683C;&#x4F4E;&#x4E8E;&#x524D;&#x4E00;&#x65E5;&#x6536;&#x76D8;&#x4EF7;&#x7684;0.2%&#x5219;&#x5F00;&#x591A;&#xFF0C;&#x6B62;&#x76C8;0.5%&#x6B62;&#x635F;0.3%
    :param api:
    :param time_now: EtaTime
    :return:
    &quot;</span><span class="hljs-string">&quot;&quot;</span>

    print(<span class="hljs-string">&apos;------------------%s-------------------&apos;</span> % time_now[<span class="hljs-string">&quot;%Y%m%d %H:%M&quot;</span>])

    symbol_positions = api.get_symbol_positions()  <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6301;&#x4ED3;&#x6807;&#x7684;&#x4FE1;&#x606F;</span>
    bars = api.get_bars_history(symbol=api.futures_code, time_span=ETimeSpan.MIN_5, count=<span class="hljs-number">1</span>,
                              price_mode=EPriceMode.FORMER, skip_suspended=<span class="hljs-number">0</span>)   <span class="hljs-comment"># &#x83B7;&#x5F97;&#x5408;&#x7EA6;&#x5F53;&#x524D;bar&#x6570;&#x636E;</span>
    factor = bars[<span class="hljs-string">&apos;preClose&apos;</span>] / bars[<span class="hljs-string">&apos;open&apos;</span>]  <span class="hljs-comment"># &#x5F53;&#x524D;&#x5F00;&#x76D8;&#x4EF7;&#x4E0E;&#x6628;&#x65E5;&#x6536;&#x76D8;&#x4EF7;&#x4E4B;&#x6BD4;</span>
    <span class="hljs-comment"># print(factor, bars[&apos;preClose&apos;], bars[&apos;open&apos;])</span>
    <span class="hljs-comment"># print(symbol_positions)</span>
    <span class="hljs-keyword">if</span> <span class="hljs-symbol">symbol_positions:</span>  <span class="hljs-comment"># &#x5982;&#x679C;&#x6709;&#x6301;&#x4ED3;</span>
        <span class="hljs-keyword">if</span> api.futures_code == symbol_positions[<span class="hljs-number">0</span>].<span class="hljs-symbol">symbol:</span>  <span class="hljs-comment"># &#x5F53;&#x524D;&#x6301;&#x4ED3;&#x4E3A;&#x4E3B;&#x529B;&#x5408;&#x7EA6;</span>
            <span class="hljs-comment"># &#x6B62;&#x76C8;0.3%&#x6B62;&#x635F;0.5%</span>
            <span class="hljs-keyword">if</span> symbol_positions[<span class="hljs-number">0</span>].posHigh / symbol_positions[<span class="hljs-number">0</span>].posPrice &gt; <span class="hljs-number">1.03</span> \
                <span class="hljs-keyword">or</span> symbol_positions[<span class="hljs-number">0</span>].posLow / symbol_positions[<span class="hljs-number">0</span>].posPrice &lt; <span class="hljs-number">0</span>.<span class="hljs-number">95</span><span class="hljs-symbol">:</span>
                <span class="hljs-comment"># &#x5E73;&#x4ED3;</span>
                print(api.context.time.trade_now.date, <span class="hljs-string">&quot;target position 0!&quot;</span>)  <span class="hljs-comment"># &#x5F55;&#x5165;&#x65E5;&#x5FD7;</span>
                api.target_position(symbol=symbol_positions[<span class="hljs-number">0</span>].symbol, qty=<span class="hljs-number">0</span>,
                                    side=EPositionSide.SHORT)  <span class="hljs-comment"># &#x5356;&#x51FA; &#xFF0C;symbol = &#x6301;&#x4ED3;&#x6807;&#x7684;&#xFF0C;&#x6570;&#x91CF;&#x53D8;&#x4E3A;0</span>
        <span class="hljs-comment"># &#x5F53;&#x524D;&#x6301;&#x4ED3;&#x975E;&#x4E3B;&#x529B;&#x5408;&#x7EA6; &#x5219;&#x6362;&#x4ED3;&#x4E3A;&#x4E3B;&#x529B;&#x5408;&#x7EA6;</span>
        <span class="hljs-symbol">else:</span>
            print(api.context.time.trade_now.date, symbol_positions[<span class="hljs-number">0</span>].symbol, <span class="hljs-string">&quot;&#x6362;&#x5408;&#x7EA6;&quot;</span>, api.futures_code, )
            api.target_position(symbol=symbol_positions[<span class="hljs-number">0</span>].symbol, qty=<span class="hljs-number">0</span>, side=EPositionSide.SHORT)
            api.target_position(symbol=api.futures_code, qty=<span class="hljs-number">2</span>, side=EPositionSide.SHORT)
    <span class="hljs-symbol">else:</span>
        <span class="hljs-keyword">if</span> factor[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0</span>.<span class="hljs-number">97</span><span class="hljs-symbol">:</span>
            print(api.context.time.trade_now.date, <span class="hljs-string">&quot;target position 2&quot;</span>)  <span class="hljs-comment"># &#x975E;&#x5FC5;&#x8981;&#xFF1A; &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span>
            api.target_position(symbol=api.futures_code, qty=<span class="hljs-number">2</span>, side=EPositionSide.SHORT)  <span class="hljs-comment"># &#x4E70;&#x5165; symbol = &#x9009;&#x4E2D;&#x6807;&#x7684;&#x5F00;&#x7A7A;&#xFF0C;&#x76F4;&#x81F3;&#x6301;&#x4ED3;&#x6570;&#x8FBE;2&#x624B;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_timer</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x5B9A;&#x65F6;&#x5668;&#x4E8B;&#x4EF6;&#xFF0C;&#x6A21;&#x62DF;&#x76D8;&#x54CD;&#x5E94;&#xFF1B;&#x56DE;&#x6D4B;&#x65F6;&#x53EF;&#x5FFD;&#x7565;
    :param api:
    &quot;</span><span class="hljs-string">&quot;&quot;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_order_update</span><span class="hljs-params">(api, order)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x8BA2;&#x5355;&#x66F4;&#x65B0;&#x4E8B;&#x4EF6;
    :param api:
    :param order:
    &quot;</span><span class="hljs-string">&quot;&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_terminate</span><span class="hljs-params">(api, exit_info)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x7B56;&#x7565;&#x7EC8;&#x6B62;&#x65F6;&#x54CD;&#x5E94;&#xFF1B;&#x8FD0;&#x884C;&#x7EC8;&#x6B62;&#x65F6;&#x4F1A;&#x8C03;&#x7528;&#x4E00;&#x6B21;
    :param api:
    :param exit_info:&#x7EC8;&#x6B62;&#x6D88;&#x606F;
    &quot;</span><span class="hljs-string">&quot;&quot;</span>

    log.info(<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
    <span class="hljs-comment"># &#x8F93;&#x51FA;&#x65E5;&#x5FD7;</span>
    api.save_object(<span class="hljs-string">&apos;exit_info&apos;</span>, api.props(exit_info))
</code></pre>
<h3 id="ma-&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="ma-&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#ma-&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>MA-&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<p>&#x672C;&#x793A;&#x4F8B;&#x6F14;&#x793A;&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF0C;&#x80A1;&#x7968;&#x6C60;&#x4E3A;&#x6CAA;&#x6DF1;300&#xFF0C;&#x5B9E;&#x73B0;&#x903B;&#x8F91;&#x4E3A;&#xFF1A;&#x5F53;5&#x65E5;&#x5747;&#x7EBF;&#x4E0A;&#x7A7F;60&#x65E5;&#x5747;&#x7EBF;&#xFF0C;&#x4E70;&#x5165;&#xFF1B;&#x5F53;5&#x65E5;&#x5747;&#x7EBF;&#x4E0B;&#x7A7F;60&#x65E5;&#x5747;&#x7EBF;&#xFF0C;&#x5356;&#x51FA;</p>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

from etasdk import *
import time
from datetime import datetime
from etasdk.utils.time_util import TimeUtil
import numpy as np

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
#&#x672C;&#x793A;&#x4F8B;&#x6F14;&#x793A;&#x53CC;&#x5747;&#x7EBF;&#x7B56;&#x7565;&#xFF0C;&#x80A1;&#x7968;&#x6C60;&#x4E3A;&#x4E0A;&#x8BC1;50
#&#x7B56;&#x7565;&#x903B;&#x8F91;&#xFF1A;
#1.&#x5F53;5&#x65E5;&#x5747;&#x7EBF;&#x4E0A;&#x7A7F;60&#x65E5;&#x5747;&#x7EBF;&#xFF0C;&#x4E70;&#x5165;
#2.&#x5F53;5&#x65E5;&#x5747;&#x7EBF;&#x4E0B;&#x7A7F;60&#x65E5;&#x5747;&#x7EBF;&#xFF0C;&#x5356;&#x51FA;
&#x56DE;&#x6D4B;&#x6807;&#x7684;&#xFF1A;&#x4E0A;&#x8BC1;50
&#x56DE;&#x6D4B;&#x5468;&#x671F;&#xFF1A;20180702-20181101
&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;&#x65E5;K

&apos;</span><span class="hljs-string">&apos;&apos;</span>

long_period = <span class="hljs-number">60</span>
short_period = <span class="hljs-number">5</span>
coefficient=<span class="hljs-number">0</span>.<span class="hljs-number">06</span>

<span class="hljs-comment">#&#x521D;&#x59CB;&#x5316;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x8BA1;&#x7B97;MACD&#x9700;&#x8981;&#x7684;&#x5386;&#x53F2;K&#x7EBF;&#xFF0C;&#x4E3A;&#x65E5;K&#xFF0C;&#x6700;&#x591A;&#x5386;&#x53F2;&#x4E0A;30&#x6839;</span>
    api.setRequireBars(ETimeSpan.DAY_1,long_period);
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x5B89;&#x7EC4;&#x56DE;&#x8C03;&#x6A21;&#x5F0F;&#xFF0C;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x4E3A; 10S</span>
    api.setGroupMode(<span class="hljs-number">10000</span>);
    <span class="hljs-comment">#&#x8BBE;&#x8BA1;&#x6A21;&#x62DF;&#x76D8;Timer&#x51FD;&#x6570;&#x7684;&#x5B9A;&#x65F6;&#x56DE;&#x8C03;</span>
    api.setTimerCycle(<span class="hljs-number">60000</span>)
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x6C60;&#x4E3A;&#x6CAA;&#x6DF1;300</span>
    api.setSymbolPool(instsets=[<span class="hljs-string">&quot;000016.IDX&quot;</span>])

<span class="hljs-comment">#&#x76D8;&#x524D;&#x8FD0;&#x884C;&#xFF0C;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#xFF0C;&#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x5F53;&#x65E5;&#x5173;&#x6CE8;&#x7684;&#x6807;&#x7684;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api,tradeDate)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment">#&#x53D6;&#x51FA;&#x80A1;&#x7968;&#x6C60;</span>
    symbolPool=api.getSymbolPool()

    <span class="hljs-comment"># &#x5907;&#x9009;&#x4E70;&#x5165;&#x6E05;&#x5355;</span>
    buy_list = []
    <span class="hljs-comment"># &#x5356;&#x51FA;&#x6E05;&#x5355;</span>
    sell_list = []

    <span class="hljs-comment">#&#x904D;&#x5386;&#x80A1;&#x7968;&#x6C60;&#xFF0C;&#x5206;&#x522B;&#x83B7;&#x53D6;5&#x548C;60 &#x7684;K&#x7EBF;</span>
    <span class="hljs-keyword">for</span> i, symbol <span class="hljs-keyword">in</span> enumerate(symbolPool)<span class="hljs-symbol">:</span>
        bars = api.getBarsHistory(symbol, ETimeSpan.DAY_1, long_period,priceMode=EPriceMode.FORMER, df=True,fields=[<span class="hljs-string">&apos;close&apos;</span>]);
        <span class="hljs-keyword">if</span> len(bars) == <span class="hljs-symbol">long_period:</span>
            bar_close_long = bars[<span class="hljs-number">0</span><span class="hljs-symbol">:long_period</span>]
            bar_close_short = bars[long_period-<span class="hljs-symbol">short_period:</span>long_period]
            long_mean =  np.mean( np.array(bar_close_long[<span class="hljs-string">&apos;close&apos;</span>]) )<span class="hljs-comment"># &#x8BA1;&#x7B97;60&#x65E5;&#x5747;&#x7EBF;</span>
            short_mean = np.mean( np.array(bar_close_short[<span class="hljs-string">&apos;close&apos;</span>]) )<span class="hljs-comment"># &#x8BA1;&#x7B97;5&#x65E5;&#x5747;&#x7EBF;</span>

            <span class="hljs-comment">#print data , symbol,short_mean,long_mean ,&quot;|&quot;,(short_mean - long_mean) ,coefficient* long_mean</span>
            <span class="hljs-comment">#&#x5982;&#x679C;</span>
            buy_flag = True <span class="hljs-keyword">if</span> (short_mean - long_mean) &gt; coefficient* long_mean <span class="hljs-keyword">else</span> False
            <span class="hljs-keyword">if</span> <span class="hljs-symbol">buy_flag:</span>
                buy_list.append(symbol)
            <span class="hljs-symbol">else:</span>
                sell_list.append(symbol)
    <span class="hljs-comment"># &#x5173;&#x6CE8;&#x5F53;&#x524D;&#x7684;buy_list&#x5373;&#x53EF;&#xFF0C;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x6709;&#x6301;&#x4ED3;&#x4F1A;&#x81EA;&#x52A8;&#x5173;&#x6CE8;</span>
    api.setFocusSymbols(buy_list);
    <span class="hljs-comment">#&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6301;&#x4ED3;&#x7684;&#x6807;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x5356;&#x51FA;&#xFF0C;&#x5219;&#x5E73;&#x4ED3;</span>
    position_symbols = api.getPositionSymbols();

    <span class="hljs-comment"># &#x8F93;&#x51FA;&#x5F53;&#x524D;&#x4EA4;&#x6613;&#x65E5;</span>
    LOG.INFO  (<span class="hljs-string">&quot;[%s] buy list = [%s]&quot;</span> ,tradeDate,buy_list)
    LOG.INFO  (<span class="hljs-string">&quot;[%s] position_symbols list = [%s]&quot;</span> , tradeDate,position_symbols)

    <span class="hljs-comment">#&#x5982;&#x679C;&#x4E70;&#x5165;&#x5217;&#x8868;&#x7684;&#x6807;&#x7684;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#x5219;&#x4E70;&#x5165;</span>
    <span class="hljs-keyword">for</span> i, buy_symbol <span class="hljs-keyword">in</span> enumerate(buy_list)<span class="hljs-symbol">:</span>
        <span class="hljs-keyword">if</span> buy_symbol <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-symbol">position_symbols:</span>
            LOG.INFO(<span class="hljs-string">&quot;[%s] target position long 1000![%s]&quot;</span>, tradeDate,buy_symbol);
            api.targetPosition(symbol=buy_symbol, qty=<span class="hljs-number">1000</span>)

    <span class="hljs-comment">#&#x5356;&#x51FA;&#x6709;&#x5356;&#x51FA;&#x4FE1;&#x53F7;&#x7684;&#x6807;&#x7684;</span>
    <span class="hljs-keyword">for</span> i, pos_symbol <span class="hljs-keyword">in</span> enumerate(position_symbols)<span class="hljs-symbol">:</span>
        <span class="hljs-keyword">if</span> pos_symbol <span class="hljs-keyword">in</span> <span class="hljs-symbol">sell_list:</span>
            LOG.INFO(<span class="hljs-string">&quot;[%s] target position short 0![%s]&quot;</span>, tradeDate,pos_symbol);
            api.targetPosition(symbol=pos_symbol, qty=<span class="hljs-number">0</span>);

<span class="hljs-comment">#Bar&#x56DE;&#x8C03;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHandleData</span><span class="hljs-params">(api,bar)</span></span><span class="hljs-symbol">:</span>
    pass;

<span class="hljs-comment">#&#x5B9A;&#x65F6;&#x5668;&#xFF0C;&#x6A21;&#x62DF;&#x76D8;&#x54CD;&#x5E94;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTimer</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    pass;

<span class="hljs-comment">#&#x7B56;&#x7565;&#x7EC8;&#x6B62;&#x65F6;&#x54CD;&#x5E94;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api,exitInfo)</span></span><span class="hljs-symbol">:</span>
    LOG.INFO (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
</code></pre>
<h2 id="&#x8FDB;&#x9636;&#x80A1;&#x7968;&#x7B56;&#x7565;"><a name="&#x8FDB;&#x9636;&#x80A1;&#x7968;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#&#x8FDB;&#x9636;&#x80A1;&#x7968;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8FDB;&#x9636;&#x80A1;&#x7968;&#x7B56;&#x7565;</h2>
<h3 id="buydemo-&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E70;&#x5165;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="buydemo-&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E70;&#x5165;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#buydemo-&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E70;&#x5165;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>buyDemo-&#x5E26;&#x53C2;&#x6570;&#x7684;&#x4E70;&#x5165;&#x7B56;&#x7565;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<p>&#x672C;&#x7B56;&#x7565;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4E0B;&#x5355;&#x7B56;&#x7565;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4F53;&#x73B0;&#x5982;&#x4F55;&#x8C03;&#x7528;&#x7B56;&#x7565;&#x53C2;&#x6570; &#xFF0C;&#x65B9;&#x4FBF;&#x7B56;&#x7565;&#x53C2;&#x6570;&#x8F83;&#x591A;&#x65F6;&#x65E0;&#x9700;&#x4FEE;&#x6539;&#x7B56;&#x7565;&#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x5408;&#x7406;&#x7684;&#x53C2;&#x6570;&#x4F18;&#x5316;&#x7BA1;&#x7406;&#x3002;
&#x9700;&#x8981;&#x5728;web&#x5E73;&#x53F0;&#x4E2D;&#x7B56;&#x7565;&#x4E2D;&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#xFF0C;&#x5177;&#x4F53;&#x6B65;&#x9AA4;&#x4E3A;&#xFF1A;&#x7B56;&#x7565;&#x7BA1;&#x7406;&gt;-&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&gt;-&#x6DFB;&#x52A0;&#x57FA;&#x7840;&#x53C2;&#x6570;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;
<img src="cdn.upchina.com/uptest/201901/1547119539211_20190110192539_1d8758084721f16a.jpg" alt=""></p>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment">#&#x56DE;&#x6D4B;&#x5468;&#x671F;&#x4E3A;20180702-20180719</span>
<span class="hljs-comment">#&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;&#x65E5;K</span>
from etasdk import *
import time
from datetime import datetime

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;onInitialize&quot;</span>)
    <span class="hljs-comment">#&#x83B7;&#x53D6;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;</span>
    api.bar_len = <span class="hljs-number">10</span>
    api.setRequireData(
        symbols=[<span class="hljs-string">&apos;000001.CS&apos;</span>],
        bars=[ (ETimeSpan.DAY_1, api.bar_len)]
    )
    <span class="hljs-comment">#&#x83B7;&#x53D6;&#x7B56;&#x7565;&#x53C2;&#x6570;</span>
    <span class="hljs-comment">#&#x9700;&#x5728;web&#x5E73;&#x53F0;&#x7B56;&#x7565;&#x7BA1;&#x7406;&gt;-&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&gt;-&#x6DFB;&#x52A0;&#x57FA;&#x7840;&#x53C2;&#x6570;  </span>
    <span class="hljs-comment"># &#x53C2;&#x6570;&#x540D;&#x79F0;&#xFF1A;capital &#xFF1B; &#x53C2;&#x6570;&#x7C7B;&#x578B; SFT_LONG&#xFF1B;  &#x9ED8;&#x8BA4;&#x503C;&#xFF08;&#x81EA;&#x884C;&#x9009;&#x62E9;&#xFF09;10000000&#xFF1B;&#x662F;&#x5426;&#x5FC5;&#x586B;&#xFF08;&#x81EA;&#x884C;&#x9009;&#x62E9;&#xFF09;&#x975E;&#x5FC5;&#x586B; </span>
    api.capital = api.getValueAsDouble(field=<span class="hljs-string">&quot;capital&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api, data)</span></span><span class="hljs-symbol">:</span>
    time = api.timeNow()
    print(<span class="hljs-string">&quot;time----&quot;</span>,data)
    symbolPool = api.getSymbolPool()
    api.setFocusSymbols(symbolPool)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBar</span><span class="hljs-params">(api, bar)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;onbar: %d&quot;</span>%bar.tradeDate)
    hisBar=api.getBarsHistory(bar.symbol, ETimeSpan.DAY_1, api.bar_len, skipSuspended=<span class="hljs-number">1</span>, df=True,priceMode = EPriceMode.FORMER)
    close=hisBar[<span class="hljs-string">&quot;close&quot;</span>].mean()
    current_price = hisBar[<span class="hljs-string">&quot;close&quot;</span>][api.bar_len-<span class="hljs-number">1</span>]
    cash=api.capital
    <span class="hljs-comment">#&#x7528;&#x83B7;&#x53D6;&#x7684;&#x8D44;&#x91D1;&#x8BA1;&#x7B97;&#x53EF;&#x4E0B;&#x5355;&#x6570;&#x91CF;&#xFF0C;&#x53D6;100&#x7684;&#x6574;&#x6570;&#x500D;</span>
    qty = int(<span class="hljs-number">0</span>.<span class="hljs-number">8</span> * cash / current_price / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
    <span class="hljs-keyword">if</span> current_price &gt;<span class="hljs-symbol">close:</span>
        api.targetPosition(bar.symbol, qty)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api, exit_info)</span></span><span class="hljs-symbol">:</span>
    LOG.INFO(<span class="hljs-string">&quot;onTerminate&quot;</span>)
    print(exit_info)
</code></pre>
<h3 id="multifactor-&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="multifactor-&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#multifactor-&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>multiFactor-&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<p>&#x672C;&#x7B56;&#x7565;&#x4E3A;&#x80A1;&#x7968;&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;&#xFF0C;&#x901A;&#x8FC7;Fama-French&#x4E09;&#x56E0;&#x5B50;&#x6A21;&#x578B;&#x5BF9;&#x6BCF;&#x53EA;&#x80A1;&#x7968;&#x8FDB;&#x884C;&#x56DE;&#x5F52;&#xFF0C;&#x5F97;&#x5230;&#x5176;alpha&#x503C;, &#x4E70;&#x5165;alpha&#x4E3A;&#x8D1F;&#x7684;&#x80A1;&#x7968;</p>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

from etasdk import *
import numpy as np
import pandas as pd
import math
<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x80A1;&#x7968;&#x7B56;&#x7565;&#xFF1A;&#x591A;&#x56E0;&#x5B50;&#x9009;&#x80A1;
&#x672C;&#x7B56;&#x7565;&#x6839;&#x636E;Fama-French&#x4E09;&#x56E0;&#x5B50;&#x6A21;&#x578B;&#x5BF9;&#x6BCF;&#x53EA;&#x80A1;&#x7968;&#x8FDB;&#x884C;&#x56DE;&#x5F52;&#xFF0C;&#x5F97;&#x5230;&#x5176;alpha&#x503C;, &#x4E70;&#x5165;alpha&#x4E3A;&#x8D1F;&#x7684;&#x80A1;&#x7968;&#x3002;
&#x7B56;&#x7565;&#x601D;&#x8DEF;&#xFF1A;
&#x8BA1;&#x7B97;&#x5E02;&#x573A;&#x6536;&#x76CA;&#x7387;,&#x5E76;&#x5BF9;&#x4E2A;&#x80A1;&#x7684;&#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;&#x548C;&#x5E02;&#x503C;&#x8FDB;&#x884C;&#x5206;&#x7C7B;,
&#x6839;&#x636E;&#x5206;&#x7C7B;&#x5F97;&#x5230;&#x7684;&#x7EC4;&#x5408;&#x8BA1;&#x7B97;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x6536;&#x76CA;&#x7387;&#x3001;SMB&#x548C;HML. 
&#x5BF9;&#x5404;&#x4E2A;&#x80A1;&#x7968;&#x8FDB;&#x884C;&#x56DE;&#x5F52;(&#x65E0;&#x98CE;&#x9669;&#x6536;&#x76CA;&#x7387;&#x7B49;&#x4E8E;0)&#x5F97;&#x5230;alpha&#x503C;.
&#x9009;&#x53D6;alpha&#x503C;&#x5C0F;&#x4E8E;0&#x5E76;&#x4E3A;&#x6700;&#x5C0F;&#x7684;10&#x53EA;&#x80A1;&#x7968;&#x8FDB;&#x5165;&#x6807;&#x7684;&#x6C60;
&#x7B49;&#x6743;&#x4E70;&#x5165;&#x5728;&#x6807;&#x7684;&#x6C60;&#x7684;&#x80A1;&#x7968;&#x5E76;&#x5356;&#x51FA;&#x4E0D;&#x5728;&#x6807;&#x7684;&#x6C60;&#x7684;&#x80A1;&#x7968;
&#x56DE;&#x6D4B;&#x6570;&#x636E;:000300.IDX&#x7684;&#x6210;&#x4EFD;&#x80A1;
&#x56DE;&#x6D4B;&#x533A;&#x95F4;&#xFF1A;2018-07-01 &#x5230;2018-10-01
&#x56DE;&#x6D4B;&#x5468;&#x671F;&#xFF1A;&#x65E5;K
&apos;</span><span class="hljs-string">&apos;&apos;</span>

<span class="hljs-comment">#&#x521D;&#x59CB;&#x5316;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x6570;&#x636E;&#x6ED1;&#x7A97;</span>
    api.dataWindow = <span class="hljs-number">20</span>
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F00;&#x4ED3;&#x7684;&#x6700;&#x5927;&#x8D44;&#x91D1;&#x91CF;</span>
    api.ratio = <span class="hljs-number">0</span>.<span class="hljs-number">8</span>
    <span class="hljs-comment"># &#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;&#x7684;&#x5927;/&#x4E2D;/&#x5C0F;&#x5206;&#x7C7B;</span>
    api.BM_BIG = <span class="hljs-number">3.0</span>
    api.BM_MID = <span class="hljs-number">2.0</span>
    api.BM_SMA = <span class="hljs-number">1.0</span>
    <span class="hljs-comment"># &#x5E02;&#x503C;&#x5927;/&#x5C0F;&#x5206;&#x7C7B;</span>
    api.MV_BIG = <span class="hljs-number">2.0</span>
    api.MV_SMA = <span class="hljs-number">1.0</span>
    <span class="hljs-comment"># &#x6301;&#x4ED3;&#x80A1;&#x7968;</span>
    api.symbols_pool = []
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x6C60;&#xFF0C;&#x56E0;&#x5B50;&#x4EE5;&#x53CA;K&#x7EBF;&#x7C7B;&#x578B;</span>
    api.setRequireData(instsets=[<span class="hljs-string">&quot;000300.IDX&quot;</span>], <span class="hljs-comment"># 000300&#x6210;&#x5206;&#x80A1;</span>
                       fields=[<span class="hljs-string">&apos;MKT_CAP&apos;</span>, <span class="hljs-string">&quot;PB&quot;</span>],
                       bars=[(ETimeSpan.DAY_1, api.dataWindow + <span class="hljs-number">10</span>)]
                       )
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x6309;&#x7EC4;&#x56DE;&#x8C03;</span>
    api.setGroupMode(timeOutMs=<span class="hljs-number">10000</span>,onlyGroup = False);

<span class="hljs-comment">#&#x76D8;&#x524D;&#x8FD0;&#x884C;&#xFF0C;&#x7528;&#x4E8E;&#x9009;&#x80A1;&#x903B;&#x8F91;&#xFF1B;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#xFF0C;&#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x5F53;&#x65E5;&#x5173;&#x6CE8;&#x7684;&#x6807;&#x7684;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api,tradeDate)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;on date&quot;</span>, tradeDate)
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x80A1;&#x7968;&#x6C60;</span>
    symbolPool = api.getSymbolPool()

    fundamentalDf = pd.DataFrame(columns=[<span class="hljs-string">&quot;symbol&quot;</span>, <span class="hljs-string">&apos;MKT_CAP&apos;</span>, <span class="hljs-string">&quot;PB&quot;</span>])
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x57FA;&#x672C;&#x9762;&#x6570;&#x636E;</span>
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolPool:</span>
        <span class="hljs-comment"># &#x68C0;&#x67E5;&#x80A1;&#x7968;&#x662F;&#x5426;&#x505C;&#x724C;&#xFF0C;&#x4E0D;&#x4EA4;&#x6613;&#x505C;&#x724C;&#x80A1;&#x7968;</span>
        <span class="hljs-keyword">if</span> api.isSuspend(symbol, tradeDate)<span class="hljs-symbol">:</span>
            continue
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x57FA;&#x672C;&#x9762;&#x6570;&#x636E;</span>
        fundamentals = api.getFieldsCountDays(symbol=symbol, fields=[<span class="hljs-string">&apos;MKT_CAP&apos;</span>, <span class="hljs-string">&quot;PB&quot;</span>], count=api.dataWindow + <span class="hljs-number">1</span>)
        fundamentalDf.loc[len(fundamentalDf)] = {<span class="hljs-string">&quot;symbol&quot;</span><span class="hljs-symbol">:</span> symbol, <span class="hljs-string">&quot;MKT_CAP&quot;</span><span class="hljs-symbol">:</span> fundamentals.MKT_CAP.values[<span class="hljs-number">0</span>],
                                                 <span class="hljs-string">&quot;PB&quot;</span><span class="hljs-symbol">:</span> fundamentals.PB.values[<span class="hljs-number">0</span>]}

    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;, PB&#x5012;&#x6570;</span>
    fundamentalDf[<span class="hljs-string">&quot;PB&quot;</span>] = (fundamentalDf[<span class="hljs-string">&apos;PB&apos;</span>] ** -<span class="hljs-number">1</span>)

    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x5E02;&#x503C;&#x7684;50%&#x7684;&#x5206;&#x4F4D;&#x70B9;, &#x7528;&#x4E8E;&#x5206;&#x7C7B;</span>
    sizeGate = fundamentalDf[<span class="hljs-string">&apos;MKT_CAP&apos;</span>].quantile(<span class="hljs-number">0</span>.<span class="hljs-number">50</span>)

    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;&#x7684;30%&#x548C;70%&#x5206;&#x4F4D;&#x70B9;,&#x7528;&#x4E8E;&#x5206;&#x7C7B;</span>
    bm_gate = [fundamentalDf[<span class="hljs-string">&apos;PB&apos;</span>].quantile(<span class="hljs-number">0</span>.<span class="hljs-number">30</span>), fundamentalDf[<span class="hljs-string">&apos;PB&apos;</span>].quantile(<span class="hljs-number">0</span>.<span class="hljs-number">70</span>)]
    fundamentalDf.index = fundamentalDf.symbol
    x_return = []
    <span class="hljs-comment"># &#x8BA1;&#x7B97;return</span>
    tickerCloseValues = {}
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> fundamentalDf.symbol.<span class="hljs-symbol">values:</span>
        price = api.getBarsHistory(symbol, timeSpan=ETimeSpan.DAY_1, count=api.dataWindow + <span class="hljs-number">1</span>, df=True, \
                                   priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> len(price) &lt; api.<span class="hljs-symbol">dataWindow:</span>
            continue
        price.fillna(method=<span class="hljs-string">&quot;ffill&quot;</span>)

        stockReturn = price.close.values[-<span class="hljs-number">1</span>] / price.close.values[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>
        pb = fundamentalDf[<span class="hljs-string">&apos;PB&apos;</span>][symbol]
        market_value = fundamentalDf[<span class="hljs-string">&apos;MKT_CAP&apos;</span>][symbol]
        tickerCloseValues[symbol] = price.close.values[-<span class="hljs-number">1</span>]
        <span class="hljs-comment"># &#x83B7;&#x53D6;[&#x80A1;&#x7968;&#x4EE3;&#x7801;. &#x80A1;&#x7968;&#x6536;&#x76CA;&#x7387;, &#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;&#x7684;&#x5206;&#x7C7B;, &#x5E02;&#x503C;&#x7684;&#x5206;&#x7C7B;, &#x6D41;&#x901A;&#x5E02;&#x503C;]</span>
        <span class="hljs-keyword">if</span> pb &lt; bm_gate[<span class="hljs-number">0</span>]<span class="hljs-symbol">:</span>
            <span class="hljs-keyword">if</span> market_value &lt; <span class="hljs-symbol">sizeGate:</span>
                label = [symbol, stockReturn, api.BM_SMA, api.MV_SMA, market_value]
            <span class="hljs-symbol">else:</span>
                label = [symbol, stockReturn, api.BM_SMA, api.MV_BIG, market_value]
        elif pb &lt; bm_gate[<span class="hljs-number">1</span>]<span class="hljs-symbol">:</span>
            <span class="hljs-keyword">if</span> market_value &lt; <span class="hljs-symbol">sizeGate:</span>
                label = [symbol, stockReturn, api.BM_MID, api.MV_SMA, market_value]
            <span class="hljs-symbol">else:</span>
                label = [symbol, stockReturn, api.BM_MID, api.MV_BIG, market_value]
        elif market_value &lt; <span class="hljs-symbol">sizeGate:</span>
            label = [symbol, stockReturn, api.BM_BIG, api.MV_SMA, market_value]
        <span class="hljs-symbol">else:</span>
            label = [symbol, stockReturn, api.BM_BIG, api.MV_BIG, market_value]

        <span class="hljs-keyword">if</span> len(x_return) == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            x_return = label
        <span class="hljs-symbol">else:</span>
            x_return = np.vstack([x_return, label])

    stocks = pd.DataFrame(data=x_return, columns=[<span class="hljs-string">&apos;symbol&apos;</span>, <span class="hljs-string">&apos;return&apos;</span>, <span class="hljs-string">&apos;BM&apos;</span>, <span class="hljs-string">&apos;MKT_CAP&apos;</span>, <span class="hljs-string">&apos;mv&apos;</span>])
    stocks.index = stocks.symbol
    columns = [<span class="hljs-string">&apos;return&apos;</span>, <span class="hljs-string">&apos;BM&apos;</span>, <span class="hljs-string">&apos;MKT_CAP&apos;</span>, <span class="hljs-string">&apos;mv&apos;</span>]
    <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> <span class="hljs-symbol">columns:</span>
        stocks[column] = stocks[column].astype(np.float64)

    <span class="hljs-comment"># &#x8BA1;&#x7B97;SMB.HML&#x548C;&#x5E02;&#x573A;&#x6536;&#x76CA;&#x7387;</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5C0F;&#x5E02;&#x503C;&#x7EC4;&#x5408;&#x7684;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x7EC4;&#x5408;&#x6536;&#x76CA;&#x7387;</span>
    smb_s = (market_weighted_return(stocks, api.MV_SMA, api.BM_SMA) +
             market_weighted_return(stocks, api.MV_SMA, api.BM_MID) +
             market_weighted_return(stocks, api.MV_SMA, api.BM_BIG)) / <span class="hljs-number">3</span>

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5927;&#x5E02;&#x503C;&#x7EC4;&#x5408;&#x7684;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x7EC4;&#x5408;&#x6536;&#x76CA;&#x7387;</span>
    smb_b = (market_weighted_return(stocks, api.MV_BIG, api.BM_SMA) +
             market_weighted_return(stocks, api.MV_BIG, api.BM_MID) +
             market_weighted_return(stocks, api.MV_BIG, api.BM_BIG)) / <span class="hljs-number">3</span>

    smb = smb_s - smb_b
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5927;&#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;&#x7EC4;&#x5408;&#x7684;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x7EC4;&#x5408;&#x6536;&#x76CA;&#x7387;</span>
    hml_b = (market_weighted_return(stocks, api.MV_SMA, <span class="hljs-number">3</span>) +
             market_weighted_return(stocks, api.MV_BIG, api.BM_BIG)) / <span class="hljs-number">2</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5C0F;&#x8D26;&#x9762;&#x5E02;&#x503C;&#x6BD4;&#x7EC4;&#x5408;&#x7684;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x7EC4;&#x5408;&#x6536;&#x76CA;&#x7387;</span>
    hml_s = (market_weighted_return(stocks, api.MV_SMA, api.BM_SMA) +
             market_weighted_return(stocks, api.MV_BIG, api.BM_SMA)) / <span class="hljs-number">2</span>

    hml = hml_b - hml_s
    close = api.getBarsHistory(symbol, timeSpan=ETimeSpan.DAY_1, count=api.dataWindow + <span class="hljs-number">1</span>, df=True, \
                                   priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">1</span>)[<span class="hljs-string">&quot;close&quot;</span>].values
    market_return = close[-<span class="hljs-number">1</span>] / close[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>
    coff_pool = []

    <span class="hljs-comment"># &#x5BF9;&#x6BCF;&#x53EA;&#x80A1;&#x7968;&#x8FDB;&#x884C;&#x56DE;&#x5F52;&#x83B7;&#x53D6;&#x5176;alpha&#x503C;</span>
    <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> stocks.<span class="hljs-symbol">index:</span>
        <span class="hljs-keyword">if</span> math.isnan(float(market_return)) <span class="hljs-keyword">or</span> math.isnan(float(smb)) <span class="hljs-keyword">or</span> math.isnan(float(hml)) <span class="hljs-keyword">or</span> math.isnan(float(stocks[<span class="hljs-string">&apos;return&apos;</span>][stock]))<span class="hljs-symbol">:</span>
            coff_pool.append(np.NaN)
            continue
        x_value = np.array([[market_return], [smb], [hml], [<span class="hljs-number">1.0</span>]])
        y_value = np.array([stocks[<span class="hljs-string">&apos;return&apos;</span>][stock]])
        <span class="hljs-comment"># OLS&#x4F30;&#x8BA1;&#x7CFB;&#x6570;</span>
        coff = np.linalg.lstsq(x_value.T, y_value)[<span class="hljs-number">0</span>][<span class="hljs-number">3</span>]
        coff_pool.append(coff)

    <span class="hljs-comment"># &#x83B7;&#x53D6;alpha&#x6700;&#x5C0F;&#x5E76;&#x4E14;&#x5C0F;&#x4E8E;0&#x7684;10&#x53EA;&#x7684;&#x80A1;&#x7968;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;(&#x82E5;&#x5C11;&#x4E8E;10&#x53EA;&#x5219;&#x5168;&#x90E8;&#x4E70;&#x5165;)</span>
    stocks[<span class="hljs-string">&apos;alpha&apos;</span>] = coff_pool
    stocks = stocks[stocks.alpha &lt; <span class="hljs-number">0</span>].sort_values(by=<span class="hljs-string">&apos;alpha&apos;</span>).head(<span class="hljs-number">10</span>)
    api.symbols_pool = stocks.index.tolist()

    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F53;&#x5929;&#x9700;&#x8981;&#x4EA4;&#x6613;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x5982;&#x679C;&#x5386;&#x53F2;&#x4E0A;&#x6709;&#x8FC7;&#x6301;&#x4ED3;&#x4E86;&#xFF0C;&#x5219;&#x7CFB;&#x7EDF;&#x4F1A;&#x9ED8;&#x8BA4;&#x81EA;&#x52A8;&#x5173;&#x6CE8;</span>
    api.setFocusSymbols(api.symbols_pool )

    <span class="hljs-comment"># &#x6839;&#x636E;&#x6301;&#x4ED3;&#x4FE1;&#x606F;&#xFF0C;&#x5904;&#x7406;&#x6301;&#x4ED3;&#x80A1;&#x7968;&#x3002;&#x5E73;&#x6389;&#x4E0D;&#x5728;&#x4FE1;&#x53F7;&#x6C60;&#x4E2D;&#x7684;&#x80A1;&#x7968;</span>
    symbolpositions = api.getSymbolPositions()
    print(<span class="hljs-string">&quot;symbol before close&quot;</span>, len(symbolpositions))
    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
        <span class="hljs-keyword">if</span> api.isSuspend(position.symbol, api.getCurrTradeDate())<span class="hljs-symbol">:</span>
            continue
        <span class="hljs-keyword">if</span> position.symbol <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> api.<span class="hljs-symbol">symbols_pool:</span>
            api.targetPosition(symbol=position.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,
                               remark=<span class="hljs-string">&quot;not in signal pool&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHandleData</span><span class="hljs-params">(api, timeExch)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x6839;&#x636E;&#x5269;&#x4F59;&#x53EF;&#x7528;&#x73B0;&#x91D1;&#x548C;&#x6301;&#x4ED3;&#x4FE1;&#x606F;&#xFF0C;&#x8BA1;&#x7B97;&#x65B0;&#x5F00;&#x4ED3;&#x91CF;</span>
    ratio_by_index = <span class="hljs-number">0</span>.<span class="hljs-number">9</span>  <span class="hljs-comment"># %90%&#x4ED3;&#x4F4D;&#xFF0C;&#x53EF;&#x6839;&#x636E;&#x5927;&#x76D8;&#x8D70;&#x52BF;&#x8FDB;&#x884C;&#x8C03;&#x6574;</span>
    account = api.getAccount(<span class="hljs-string">&quot;000001.CS&quot;</span>)
    capital = account.totAssets * ratio_by_index - account.marketValue
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6B62;&#x635F;&#x548C;&#x5E73;&#x4ED3;&#x540E;&#x7684;&#x6301;&#x4ED3;</span>
    holdingPos = []
    symbolpositions = api.getSymbolPositions()
    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
        holdingPos.append(position.symbol)
    newSymbols = list(set(api.symbols_pool) - set(holdingPos))
    <span class="hljs-comment"># &#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x65B0;&#x6807;&#x7684;&#x9700;&#x8981;&#x4E70;&#x5165;</span>
    <span class="hljs-keyword">if</span> len(newSymbols) == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">return</span>
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x4E2A;&#x80A1;capital</span>
    eachTickerCapital = capital / len(newSymbols)
    <span class="hljs-comment"># &#x6839;&#x636E;&#x4E2A;&#x80A1;capital&#x4E0B;&#x5355;</span>
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> <span class="hljs-symbol">newSymbols:</span>
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6807;&#x7684;&#x5F53;&#x524D;&#x4EF7;&#x683C;</span>
        price = api.getBarsHistory(symbol, timeSpan=ETimeSpan.DAY_1, count=<span class="hljs-number">1</span>, df=True,\
                                   priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> len(price) &lt;= <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            continue
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6807;&#x7684;&#x6301;&#x4ED3;&#x4FE1;&#x606F;</span>
        symbolPosition = api.getSymbolPosition(symbol)
        targetQty = int(eachTickerCapital / price.close.values[-<span class="hljs-number">1</span>])
        deltaQty = targetQty - symbolPosition.posQty
        <span class="hljs-comment">#&#x4E0B;&#x5355;&#x624B;&#x6570;&#x53D6;&#x6574;</span>
        finalQty = symbolPosition.posQty + int(deltaQty / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
        finalQty = max(finalQty, <span class="hljs-number">0</span>)

        api.targetPosition(symbol=symbol, qty=finalQty, positionSide=EPositionSide.LONG, remark=<span class="hljs-string">&quot;open new&quot;</span>)
        print(<span class="hljs-string">&quot;open  new long postion:&quot;</span>, symbol, finalQty)
        LOG.INFO(<span class="hljs-string">&quot;open  new long postion:&quot;</span> + str(symbol) + <span class="hljs-string">&quot; &quot;</span> + str(finalQty))


<span class="hljs-comment">#&#x7B56;&#x7565;&#x7EC8;&#x6B62;&#x65F6;&#x54CD;&#x5E94;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api,exitInfo)</span></span><span class="hljs-symbol">:</span>
    LOG.INFO (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
    print (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)

<span class="hljs-comment"># &#x8BA1;&#x7B97;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x7684;&#x6536;&#x76CA;&#x7387;,MV&#x4E3A;&#x5E02;&#x503C;&#x7684;&#x5206;&#x7C7B;,BM&#x4E3A;&#x8D26;&#x76EE;&#x5E02;&#x503C;&#x6BD4;&#x7684;&#x5206;&#x7C7B;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">market_weighted_return</span><span class="hljs-params">(stocksValues, MV_class, BM_class)</span></span><span class="hljs-symbol">:</span>
    select = stocksValues[(stocksValues.MKT_CAP == MV_class) &amp; (stocksValues.BM == BM_class)]
    marketValue = select[<span class="hljs-string">&apos;mv&apos;</span>].values
    mvTotal = np.sum(marketValue)
    mvWeighted = [mv / mvTotal <span class="hljs-keyword">for</span> mv <span class="hljs-keyword">in</span> marketValue]
    stock_return = select[<span class="hljs-string">&apos;return&apos;</span>].values
    <span class="hljs-comment"># &#x8FD4;&#x56DE;&#x5E02;&#x503C;&#x52A0;&#x6743;&#x7684;&#x6536;&#x76CA;&#x7387;&#x7684;&#x548C;</span>
    returnTotal = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(mvWeighted))<span class="hljs-symbol">:</span>
        returnTotal.append(mvWeighted[i] * stock_return[i])
    return_total = np.sum(returnTotal)
    <span class="hljs-keyword">return</span> return_total
</code></pre>
<h3 id="stocktiming-&#x80A1;&#x7968;&#x62E9;&#x65F6;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="stocktiming-&#x80A1;&#x7968;&#x62E9;&#x65F6;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#stocktiming-&#x80A1;&#x7968;&#x62E9;&#x65F6;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>stockTiming-&#x80A1;&#x7968;&#x62E9;&#x65F6;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment"># coding=utf-8</span>
from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals, division
import numpy as np
from etasdk import *
from talib import EMA

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x672C;&#x7B56;&#x7565;&#x4E3A;&#x80A1;&#x7968;&#x4E2A;&#x80A1;&#x62E9;&#x65F6;&#xFF0C;&#x7B49;&#x8D44;&#x91D1;&#x5206;&#x914D;&#x4ED3;&#x4F4D;&#x3002;
&#x56DE;&#x6D4B;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#xFF1A;
1&#x3001;&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#xFF1A;2014-01-06&#x5230;2018-11-08&#xFF1B;
2&#x3001;&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;&#x65E5;K&#xFF1B;
3&#x3001;&#x8D39;&#x7387;&#xFF1A;&#x4E07;3
4&#x3001;&#x6ED1;&#x70B9;&#xFF1A;1&#x4E2A;tick
5&#x3001;&#x80A1;&#x7968;&#x521D;&#x59CB;&#x8D44;&#x91D1;&#xFF1A;100&#x4E07;
6&#x3001;&#x80A1;&#x7968;&#x6C60;&#xFF1A;&#x4E0A;&#x8BC1;50
&apos;</span><span class="hljs-string">&apos;&apos;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">capital_lots</span><span class="hljs-params">(close, capital,ratio_by_index)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment">## &#x8BA1;&#x7B97;&#x4E0B;&#x5355;&#x80A1;&#x6570;</span>
    <span class="hljs-comment"># input:&#x4EF7;&#x683C;&#x3001;&#x8D44;&#x91D1;&#x548C;&#x4ED3;&#x4F4D;&#x6BD4;&#x4F8B;&#xFF08;0-100%&#xFF09;</span>
    volume = {}
    capitalSingle = ratio_by_index * capital / len(close)  <span class="hljs-comment"># &#x5747;&#x5206;&#x540E;&#x6839;&#x636E;&#x6307;&#x6570;&#x8BA1;&#x7B97;&#x4ED3;&#x4F4D;&#x6BD4;&#x4F8B;</span>
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> close.keys()<span class="hljs-symbol">:</span>
        volume[symbol] =  max(<span class="hljs-number">100</span>*int(capitalSingle / (close[symbol] * <span class="hljs-number">100</span>.)),<span class="hljs-number">100</span>)  <span class="hljs-comment"># &#x4E0D;&#x8DB3;1&#x624B;&#xFF0C;&#x8865;&#x9F50;1&#x624B;</span>
    <span class="hljs-keyword">return</span> volume

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment">## &#x8BBE;&#x7F6E;&#x6807;&#x7684;</span>
    api.index = str(<span class="hljs-string">&quot;000016.IDX&quot;</span>) <span class="hljs-comment"># &#x4EE5;&#x4E0A;&#x8BC1;50&#x80A1;&#x7968;&#x6C60;&#x4E3A;&#x4F8B;</span>
    api.setSymbolPool(instsets=[api.index], symbols=[api.index])
    api.setGroupMode(<span class="hljs-number">50000</span>, True)

    <span class="hljs-comment">##  &#x5168;&#x5C40;&#x53C2;&#x6570;</span>
    api.dataLen = <span class="hljs-number">200</span>  <span class="hljs-comment"># &#x6BCF;&#x6B21;&#x4E0B;&#x8F7D;&#x7684;&#x6570;&#x636E;&#x957F;&#x5EA6;</span>
    api.setRequireBars(ETimeSpan.DAY_1, api.dataLen)
    account = api.getAccount(symbol=api.index, market=MARKET_CHINASTOCK)
    api.capital = account.cashAvailable  <span class="hljs-comment"># &#x8D26;&#x6237;&#x521D;&#x59CB;&#x8D44;&#x91D1;&#xFF08;100&#x4E07;&#xFF09;</span>

    <span class="hljs-comment">## &#x65F6;&#x95F4;&#x7A97;&#x53E3;&#x53C2;&#x6570;</span>
    api.windows_SMA        = <span class="hljs-number">5</span>   <span class="hljs-comment"># &#x77ED;&#x671F;&#x79FB;&#x52A8;&#x5E73;&#x5747;&#x7A97;&#x53E3;</span>
    api.windows_LMA        = <span class="hljs-number">20</span>  <span class="hljs-comment"># &#x957F;&#x671F;&#x79FB;&#x52A8;&#x5E73;&#x5747;&#x7A97;&#x53E3;</span>
    api.windows_LLMA       = <span class="hljs-number">120</span>  <span class="hljs-comment"># &#x66F4;&#x957F;&#x5468;&#x671F;&#x79FB;&#x52A8;&#x5E73;&#x5747;&#x7A97;&#x53E3;</span>

    <span class="hljs-comment">## &#x4E34;&#x754C;&#x503C;&#x7C7B;</span>
    api.stop_method = <span class="hljs-number">1</span>

    <span class="hljs-comment">## &#x884C;&#x60C5;&#x6570;&#x636E;&#x7C7B;</span>
    api.tradeday = [] <span class="hljs-comment"># &#x4EA4;&#x6613;&#x65E5;</span>
    api.symbolPool = []
    api.price = None <span class="hljs-comment"># &#x4EA4;&#x6613;&#x4FE1;&#x53F7;</span>

    print(<span class="hljs-string">&quot;initialize successly.&quot;</span>)
    LOG.INFO(<span class="hljs-string">&quot;initialize successly.&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api, trade_date)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;-------------------&quot;</span>)
    print(<span class="hljs-string">&quot;tradingday:&quot;</span>, trade_date)
    LOG.INFO(<span class="hljs-string">&quot;tradingday:%s&quot;</span>, trade_date)

    api.tradeday.append(trade_date)
    api.symbolPool = api.getSymbolPool()

    <span class="hljs-comment">## &#x6B62;&#x635F;&#x5E73;&#x4ED3;</span>
    stop_loss(api)

    <span class="hljs-comment">## 1&#x3001;&#x62E9;&#x65F6;&#x4E0E;&#x9009;&#x80A1;</span>
    api.price = timeAlgorithm(api) <span class="hljs-comment"># &#x4FEE;&#x6539;&#x62E9;&#x65F6;&#x7B97;&#x6CD5;&#xFF0C;&#x8FD4;&#x56DE;&#x9009;&#x80A1;&#x7684;&#x4EF7;&#x683C;&#xFF08;&#x5B57;&#x5178;&#x5F62;&#x5F0F;&#xFF09;</span>
    print(<span class="hljs-string">&quot;trade symbol:&quot;</span>, api.price.keys())

    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F53;&#x5929;&#x9700;&#x8981;&#x4EA4;&#x6613;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x5982;&#x679C;&#x5386;&#x53F2;&#x4E0A;&#x6709;&#x8FC7;&#x6301;&#x4ED3;&#x4E86;&#xFF0C;&#x5219;&#x7CFB;&#x7EDF;&#x4F1A;&#x9ED8;&#x8BA4;&#x81EA;&#x52A8;&#x5173;&#x6CE8;</span>
    api.setFocusSymbols(api.price.keys())

    <span class="hljs-comment"># &#x6839;&#x636E;&#x6301;&#x4ED3;&#x4FE1;&#x606F;&#xFF0C;&#x5904;&#x7406;&#x6301;&#x4ED3;&#x80A1;&#x7968;&#x3002;&#x5E73;&#x6389;&#x4E0D;&#x5728;&#x4FE1;&#x53F7;&#x6C60;&#x4E2D;&#x7684;&#x80A1;&#x7968;</span>
    symbolpositions = api.getSymbolPositions()
    print(<span class="hljs-string">&quot;symbol before close&quot;</span>, len(symbolpositions))
    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
        <span class="hljs-keyword">if</span> api.isSuspend(position.symbol, api.getCurrTradeDate())<span class="hljs-symbol">:</span>
            continue
        <span class="hljs-keyword">if</span> position.symbol <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> api.price.keys()<span class="hljs-symbol">:</span>
            api.targetPosition(symbol=position.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,
                               remark=<span class="hljs-string">&quot;not in signal pool&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHandleData</span><span class="hljs-params">(api, timeExch)</span></span><span class="hljs-symbol">:</span>

    <span class="hljs-comment"># &#x5F53;&#x524D;&#x4FE1;&#x53F7;&#x4E0D;&#x4E3A;&#x7A7A;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api.price <span class="hljs-keyword">or</span> len(api.price) == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x6839;&#x636E;&#x5269;&#x4F59;&#x53EF;&#x7528;&#x73B0;&#x91D1;&#x548C;&#x6301;&#x4ED3;&#x4FE1;&#x606F;&#xFF0C;&#x8BA1;&#x7B97;&#x65B0;&#x5F00;&#x4ED3;&#x91CF;</span>
    ratio_by_index = <span class="hljs-number">0</span>.<span class="hljs-number">9</span>  <span class="hljs-comment"># %90%&#x4ED3;&#x4F4D;&#xFF0C;&#x53EF;&#x6839;&#x636E;&#x5927;&#x76D8;&#x8D70;&#x52BF;&#x8FDB;&#x884C;&#x8C03;&#x6574;</span>
    account = api.getAccount(symbol=api.index, market=MARKET_CHINASTOCK)
    capital = account.totAssets * ratio_by_index - account.marketValue
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6B62;&#x635F;&#x548C;&#x5E73;&#x4ED3;&#x540E;&#x7684;&#x6301;&#x4ED3;</span>
    holdingPos = []
    symbolpositions = api.getSymbolPositions()
    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
        holdingPos.append(position.symbol)
    newSymbols = list(set(api.price.keys()) - set(holdingPos))
    <span class="hljs-comment"># &#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x65B0;&#x6807;&#x7684;&#x9700;&#x8981;&#x4E70;&#x5165;</span>
    <span class="hljs-keyword">if</span> len(newSymbols) == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">return</span>
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x4E2A;&#x80A1;capital</span>
    eachTickerCapital = capital / len(newSymbols)
    <span class="hljs-comment"># &#x6839;&#x636E;&#x4E2A;&#x80A1;capital&#x4E0B;&#x5355;</span>
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> <span class="hljs-symbol">newSymbols:</span>
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6807;&#x7684;&#x5F53;&#x524D;&#x4EF7;&#x683C;</span>
        price = api.getBarsHistory(symbol, timeSpan=ETimeSpan.DAY_1, count=<span class="hljs-number">1</span>, df=True,\
                                   priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> len(price) &lt;= <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            continue
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6807;&#x7684;&#x6301;&#x4ED3;&#x4FE1;&#x606F;</span>
        symbolPosition = api.getSymbolPosition(symbol)
        targetQty = int(eachTickerCapital / price.close.values[-<span class="hljs-number">1</span>])
        deltaQty = targetQty - symbolPosition.posQty
        <span class="hljs-comment">#&#x4E0B;&#x5355;&#x624B;&#x6570;&#x53D6;&#x6574;</span>
        finalQty = symbolPosition.posQty + int(deltaQty / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
        finalQty = max(finalQty, <span class="hljs-number">0</span>)

        api.targetPosition(symbol=symbol, qty=finalQty, positionSide=EPositionSide.LONG, remark=<span class="hljs-string">&quot;open new&quot;</span>)
        print(<span class="hljs-string">&quot;open  new long postion:&quot;</span>, symbol, finalQty)
        LOG.INFO(<span class="hljs-string">&quot;open  new long postion:&quot;</span> + str(symbol) + <span class="hljs-string">&quot; &quot;</span> + str(finalQty))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api, exit_info)</span></span><span class="hljs-symbol">:</span>
    pass

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">timeAlgorithm</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    price = {}
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> api.<span class="hljs-symbol">symbolPool:</span>
        <span class="hljs-comment">## &#x4E0B;&#x8F7D;&#x884C;&#x60C5;&#x6570;&#x636E;</span>
        HQData = api.getBarsHistory(symbol, timeSpan=ETimeSpan.DAY_1, count=api.dataLen, df=True, \
                               priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># &#x65B0;&#x80A1;&#x6392;&#x9664;</span>
        <span class="hljs-keyword">if</span> len(HQData) &lt;= <span class="hljs-number">120</span><span class="hljs-symbol">:</span>
            continue

        <span class="hljs-comment"># &#x68C0;&#x67E5;&#x6807;&#x7684;&#x662F;&#x5426;&#x505C;&#x724C;</span>
        <span class="hljs-keyword">if</span> api.isSuspend(symbol, api.getCurrTradeDate())<span class="hljs-symbol">:</span>
            continue

        <span class="hljs-comment"># &#x6839;&#x636E;&#x6A21;&#x578B;&#x8BA1;&#x7B97;&#x5F00;&#x4ED3;&#x4FE1;&#x53F7;</span>
        <span class="hljs-keyword">if</span> calculateSignal(api, HQData) == <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
            price[symbol] = HQData.close.values[-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">return</span> price
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculateSignal</span><span class="hljs-params">(api,HQData)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-keyword">if</span> np.isnan(HQData.close.values[-<span class="hljs-number">1</span>])<span class="hljs-symbol">:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    close = HQData.close.values
    closeSMA = EMA(close, api.windows_SMA)[-<span class="hljs-number">1</span>]
    closeLMA = EMA(close, api.windows_LMA)[-<span class="hljs-number">1</span>]

    signal01 = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> (closeSMA &gt; closeLMA) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

    volume = HQData.volume.values
    volumeMA = EMA(volume[<span class="hljs-symbol">:-</span><span class="hljs-number">1</span>],<span class="hljs-number">20</span>)
    closeSMADouble08 = EMA(EMA(close, <span class="hljs-number">8</span>), <span class="hljs-number">8</span>)
    dailyRet = np.log(closeSMADouble08[-<span class="hljs-number">1</span>]) - np.log(closeSMADouble08[-<span class="hljs-number">2</span>])
    signal = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> (volume[-<span class="hljs-number">1</span>] &gt; <span class="hljs-number">2</span>.*volumeMA[-<span class="hljs-number">1</span>]) <span class="hljs-keyword">and</span> (dailyRet&gt;<span class="hljs-number">0</span>) <span class="hljs-keyword">else</span> signal01
    <span class="hljs-keyword">return</span> signal

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop_loss</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x79FB;&#x52A8;&#x6B62;&#x635F;&#x6B62;&#x76C8;</span>
    positionQty, positionHigh, positionClose = queryPosition(api)
    <span class="hljs-keyword">for</span> ind <span class="hljs-keyword">in</span> positionQty.keys()<span class="hljs-symbol">:</span>
        <span class="hljs-comment"># &#x68C0;&#x67E5;&#x6807;&#x7684;&#x662F;&#x5426;&#x505C;&#x724C;</span>
        <span class="hljs-keyword">if</span> api.isSuspend(ind, api.getCurrTradeDate())<span class="hljs-symbol">:</span>
            continue
        hist_data = api.getBarsHistory(ind, timeSpan=ETimeSpan.DAY_1, count=<span class="hljs-number">90</span>, df=True,
                                       priceMode=EPriceMode.FORMER)
        <span class="hljs-keyword">if</span> len(hist_data) &gt;= <span class="hljs-number">60</span><span class="hljs-symbol">:</span>
            close = hist_data.close.values
            <span class="hljs-keyword">if</span> api.stop_method == <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
                <span class="hljs-comment"># &#x6B62;&#x635F;</span>
                drawdown = np.log(positionHigh[ind] / positionClose[ind])
                <span class="hljs-keyword">if</span> drawdown &lt; <span class="hljs-number">0</span>.<span class="hljs-number">10</span><span class="hljs-symbol">:</span>
                    dropline = positionHigh[ind] * <span class="hljs-number">0</span>.<span class="hljs-number">90</span>
                <span class="hljs-symbol">else:</span>
                    dropline = positionHigh[ind] * <span class="hljs-number">0</span>.<span class="hljs-number">94</span>
                <span class="hljs-keyword">if</span> (close[-<span class="hljs-number">1</span>] &lt;= dropline)<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=ind, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,remark=<span class="hljs-string">&quot;stop loss&quot;</span>)
                    print(api.tradeday[-<span class="hljs-number">1</span>], <span class="hljs-string">&quot;,stop loss:&quot;</span>, ind)
                <span class="hljs-comment"># &#x6B62;&#x76C8;</span>
                <span class="hljs-keyword">if</span> (((close[-<span class="hljs-number">1</span>] / positionClose[ind]) - <span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>.<span class="hljs-number">15</span>)<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=ind, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
                    print(api.tradeday[-<span class="hljs-number">1</span>], <span class="hljs-string">&quot;,stop return&quot;</span>, ind)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">queryPosition</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># #  &#x67E5;&#x8BE2;&#x6301;&#x4ED3;</span>
    positionQty = {}
    positionHigh = {}
    positionClose = {}
    symbolpositions = api.getSymbolPositions()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-symbol">symbolpositions:</span>
        <span class="hljs-keyword">return</span> positionQty,positionHigh,positionClose
    <span class="hljs-symbol">else:</span>
        <span class="hljs-keyword">for</span> ind <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
            positionQty[ind.symbol] = ind.posQty
            positionHigh[ind.symbol] = ind.posHigh
            positionClose[ind.symbol] = ind.posPrice
        <span class="hljs-keyword">return</span> positionQty,positionHigh,positionClose
</code></pre>
<h3 id="industryrotation-&#x884C;&#x4E1A;&#x8F6E;&#x52A8;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="industryrotation-&#x884C;&#x4E1A;&#x8F6E;&#x52A8;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#industryrotation-&#x884C;&#x4E1A;&#x8F6E;&#x52A8;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>industryRotation-&#x884C;&#x4E1A;&#x8F6E;&#x52A8;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>


from etasdk import *
import numpy as np
from operator import itemgetter
from collections import OrderedDict

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x80A1;&#x7968;&#x7B56;&#x7565;&#xFF1A;&#x884C;&#x4E1A;&#x8F6E;&#x52A8;
&#x672C;&#x7B56;&#x7565;&#x6BCF;&#x5929;&#x8BA1;&#x7B97;&quot;880008.PLA&quot;, &quot;880023.PLA&quot;, &quot;880030.PLA&quot;, &quot;880035.PLA&quot;, &quot;880046.PLA&quot;, &quot;880064.PLA&quot;
(&#x5316;&#x5B66;&#x5236;&#x54C1;.&#x7535;&#x5B50;.&#x7EBA;&#x7EC7;&#x670D;&#x88C5;.&#x533B;&#x836F;.&#x623F;&#x5730;&#x4EA7;.&#x56FD;&#x9632;&#x519B;&#x5DE5;)&#x8FD9;&#x51E0;&#x4E2A;&#x884C;&#x4E1A;&#x6307;&#x6570;&#x8FC7;&#x53BB;
20&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x7684;&#x6536;&#x76CA;&#x7387;,&#x9009;&#x53D6;&#x6536;&#x76CA;&#x7387;&#x6700;&#x9AD8;&#x7684;&#x6307;&#x6570;&#x7684;&#x6210;&#x4EFD;&#x80A1;&#x4E2D;&#x6D41;&#x901A;&#x5E02;&#x503C;&#x6700;&#x5927;&#x7684;5&#x53EA;&#x80A1;&#x7968;&#x4F5C;&#x4E3A;&#x4E0B;&#x671F;&#x7684;&#x6301;&#x4ED3;&#x80A1;&#x7968;
&#x5BF9;&#x4E0D;&#x5728;&#x80A1;&#x7968;&#x6C60;&#x7684;&#x80A1;&#x7968;&#x5E73;&#x4ED3;&#x5E76;&#x7B49;&#x6743;&#x914D;&#x7F6E;&#x80A1;&#x7968;&#x6C60;&#x7684;&#x6807;&#x7684;
&#x56DE;&#x6D4B;&#x533A;&#x95F4;&#xFF1A;2018-07-01 &#x5230;2018-10-01
&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;&#x65E5;K
&apos;</span><span class="hljs-string">&apos;&apos;</span>
<span class="hljs-comment">#&#x521D;&#x59CB;&#x5316;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x9009;&#x53D6;&#x884C;&#x4E1A;&#x677F;&#x5757;</span>
    <span class="hljs-comment"># &#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9009;&#x62E9; &#x5316;&#x5B66;&#x5236;&#x54C1;&#xFF08;880008.PLA&#xFF09;&#xFF0C; &#x7535;&#x5B50;&#xFF08;&quot;880023.PLA&quot;&#xFF09;&#xFF0C;&#x7EBA;&#x7EC7;&#x670D;&#x88C5;&#xFF08;&quot;880030.PLA&quot;&#xFF09;&#xFF0C; &#x533B;&#x836F;&#xFF08;&quot;880035.PLA&quot;)&#xFF0C;&#x623F;&#x5730;&#x4EA7;&#xFF08;&quot;880046.PLA&quot;&#xFF09;&#xFF0C;&#x56FD;&#x9632;&#x519B;&#x5DE5;&#xFF08;&quot;880064.PLA&quot;&#xFF09;</span>
    api.industries = [<span class="hljs-string">&quot;880008.PLA&quot;</span>, <span class="hljs-string">&quot;880023.PLA&quot;</span>, <span class="hljs-string">&quot;880030.PLA&quot;</span>, <span class="hljs-string">&quot;880035.PLA&quot;</span>, <span class="hljs-string">&quot;880046.PLA&quot;</span>, <span class="hljs-string">&quot;880064.PLA&quot;</span>]
    api.returnWindow = <span class="hljs-number">20</span>
    api.capitalRatio = <span class="hljs-number">0</span>.<span class="hljs-number">8</span>
    api.numberOfChosenTickers = <span class="hljs-number">5</span>
    api.chosenTickers = []

    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x6C60;&#xFF0C;&#x56E0;&#x5B50;&#x4EE5;&#x53CA;K&#x7EBF;&#x7C7B;&#x578B;</span>
    api.setRequireData(instsets=api.industries,
                       symbols=api.industries, <span class="hljs-comment"># &#x5355;&#x72EC;&#x8BA2;&#x9605;&#x884C;&#x60C5;&#x6570;&#x636E;</span>
                       fields=[<span class="hljs-string">&apos;MKT_CAP&apos;</span>],
                       bars=[(ETimeSpan.DAY_1, api.returnWindow + <span class="hljs-number">10</span>)]
                       )
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x6309;&#x7EC4;&#x56DE;&#x8C03;</span>
    api.setGroupMode(timeOutMs=<span class="hljs-number">10000</span>,onlyGroup = False);

<span class="hljs-comment">#&#x76D8;&#x524D;&#x8FD0;&#x884C;&#xFF0C;&#x7528;&#x4E8E;&#x9009;&#x80A1;&#x903B;&#x8F91;&#xFF1B;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#xFF0C;&#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x5F53;&#x65E5;&#x5173;&#x6CE8;&#x7684;&#x6807;&#x7684;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api,tradeDate)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;on date&quot;</span>, tradeDate)
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x5404;&#x4E2A;&#x884C;&#x4E1A;&#x6307;&#x6570;&#x7684;return</span>
    return_index = []

    <span class="hljs-keyword">for</span> industry <span class="hljs-keyword">in</span> api.<span class="hljs-symbol">industries:</span>
        bars = api.getBarsHistory(industry, timeSpan=ETimeSpan.DAY_1, count=api.returnWindow + <span class="hljs-number">1</span>, df=True, priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
        bars.fillna(method=<span class="hljs-string">&quot;ffill&quot;</span>)
        <span class="hljs-keyword">if</span> len(bars) &lt; api.<span class="hljs-symbol">returnWindow:</span>
            continue
        return_index.append(bars.close.values[-<span class="hljs-number">1</span>] / bars.close.values[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>)

    <span class="hljs-comment"># &#x627E;&#x5230;return&#x6700;&#x9AD8;&#x7684;&#x884C;&#x4E1A;</span>
    chosenIndustry = api.industries[np.argmax(return_index)]
    print(<span class="hljs-string">&quot;chosenIndustry&quot;</span>, chosenIndustry)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x884C;&#x4E1A;&#x6210;&#x5206;&#x80A1;</span>
    industrySymbols = api.getConstituentSymbols(chosenIndustry)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x80A1;&#x7968;&#x7684;&#x5E02;&#x503C;</span>
    symbolMarketCaps = {}
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> <span class="hljs-symbol">industrySymbols:</span>
        <span class="hljs-comment"># &#x68C0;&#x67E5;&#x80A1;&#x7968;&#x662F;&#x5426;&#x505C;&#x724C;&#xFF0C;&#x4E0D;&#x4EA4;&#x6613;&#x505C;&#x724C;&#x80A1;&#x7968;</span>
        <span class="hljs-keyword">if</span> api.isSuspend(symbol, tradeDate)<span class="hljs-symbol">:</span>
            continue
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5355;&#x4E2A;&#x6807;&#x7684;&#x7684;&#x5E02;&#x503C;</span>
        marketCapital = api.getFieldsCountDays(symbol=symbol, fields=[<span class="hljs-string">&quot;MKT_CAP&quot;</span>], count=<span class="hljs-number">1</span>)
        symbolMarketCaps[symbol] = marketCapital.MKT_CAP.values[-<span class="hljs-number">1</span>]

    <span class="hljs-comment"># &#x6309;&#x7167;&#x5E02;&#x503C;&#x5BF9;&#x80A1;&#x7968;&#x6392;&#x5E8F;</span>
    orderedDict = OrderedDict(sorted(symbolMarketCaps.items(), key=itemgetter(<span class="hljs-number">1</span>), reverse=True))
    api.chosenTickers = [item[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> orderedDict.items()][<span class="hljs-symbol">:api</span>.numberOfChosenTickers]
    print(<span class="hljs-string">&quot;chosenTickers&quot;</span>, api.chosenTickers)

    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F53;&#x5929;&#x9700;&#x8981;&#x4EA4;&#x6613;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x5982;&#x679C;&#x5386;&#x53F2;&#x4E0A;&#x6709;&#x8FC7;&#x6301;&#x4ED3;&#x4E86;&#xFF0C;&#x5219;&#x7CFB;&#x7EDF;&#x4F1A;&#x9ED8;&#x8BA4;&#x81EA;&#x52A8;&#x5173;&#x6CE8;</span>
    api.setFocusSymbols(api.chosenTickers)

    <span class="hljs-comment"># &#x6839;&#x636E;&#x6301;&#x4ED3;&#x4FE1;&#x606F;&#xFF0C;&#x5904;&#x7406;&#x6301;&#x4ED3;&#x80A1;&#x7968;&#x3002;&#x5E73;&#x6389;&#x4E0D;&#x5728;&#x4FE1;&#x53F7;&#x6C60;&#x4E2D;&#x7684;&#x80A1;&#x7968;</span>
    symbolpositions = api.getSymbolPositions()
    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
        <span class="hljs-keyword">if</span> api.isSuspend(position.symbol, api.getCurrTradeDate())<span class="hljs-symbol">:</span>
            continue
        <span class="hljs-keyword">if</span> position.symbol <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> api.<span class="hljs-symbol">chosenTickers:</span>
            api.targetPosition(symbol=position.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,
                               remark=<span class="hljs-string">&quot;not in signal pool&quot;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHandleData</span><span class="hljs-params">(api, timeExch)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x6839;&#x636E;&#x5269;&#x4F59;&#x53EF;&#x7528;&#x73B0;&#x91D1;&#x548C;&#x6301;&#x4ED3;&#x4FE1;&#x606F;&#xFF0C;&#x8BA1;&#x7B97;&#x65B0;&#x5F00;&#x4ED3;&#x91CF;</span>
    ratio_by_index = <span class="hljs-number">0</span>.<span class="hljs-number">9</span>  <span class="hljs-comment"># %90%&#x4ED3;&#x4F4D;&#xFF0C;&#x53EF;&#x6839;&#x636E;&#x5927;&#x76D8;&#x8D70;&#x52BF;&#x8FDB;&#x884C;&#x8C03;&#x6574;</span>
    account = api.getAccount(api.chosenTickers[<span class="hljs-number">0</span>])
    capital = account.totAssets * ratio_by_index - account.marketValue
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6B62;&#x635F;&#x548C;&#x5E73;&#x4ED3;&#x540E;&#x7684;&#x6301;&#x4ED3;</span>
    holdingPos = []
    symbolpositions = api.getSymbolPositions()
    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbolpositions:</span>
        holdingPos.append(position.symbol)
    newSymbols = list(set(api.chosenTickers) - set(holdingPos))
    <span class="hljs-comment"># &#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x65B0;&#x6807;&#x7684;&#x9700;&#x8981;&#x4E70;&#x5165;</span>
    <span class="hljs-keyword">if</span> len(newSymbols) == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">return</span>
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x4E2A;&#x80A1;capital</span>
    eachTickerCapital = capital / len(newSymbols)
    <span class="hljs-comment"># &#x6839;&#x636E;&#x4E2A;&#x80A1;capital&#x4E0B;&#x5355;</span>
    <span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> <span class="hljs-symbol">newSymbols:</span>
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6807;&#x7684;&#x5F53;&#x524D;&#x4EF7;&#x683C;</span>
        price = api.getBarsHistory(symbol, timeSpan=ETimeSpan.DAY_1, count=<span class="hljs-number">1</span>, df=True, \
                                   priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> len(price) &lt;= <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            continue
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6807;&#x7684;&#x6301;&#x4ED3;&#x4FE1;&#x606F;</span>
        symbolPosition = api.getSymbolPosition(symbol)
        targetQty = int(eachTickerCapital / price.close.values[-<span class="hljs-number">1</span>])
        deltaQty = targetQty - symbolPosition.posQty
        <span class="hljs-comment"># &#x4E0B;&#x5355;&#x624B;&#x6570;&#x53D6;&#x6574;</span>
        finalQty = symbolPosition.posQty + int(deltaQty / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
        finalQty = max(finalQty, <span class="hljs-number">0</span>)

        api.targetPosition(symbol=symbol, qty=finalQty, positionSide=EPositionSide.LONG, remark=<span class="hljs-string">&quot;open new&quot;</span>)
        print(<span class="hljs-string">&quot;open  new long postion:&quot;</span>, symbol, finalQty)
        LOG.INFO(<span class="hljs-string">&quot;open  new long postion:&quot;</span> + str(symbol) + <span class="hljs-string">&quot; &quot;</span> + str(finalQty))


<span class="hljs-comment">#&#x7B56;&#x7565;&#x7EC8;&#x6B62;&#x65F6;&#x54CD;&#x5E94;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api,exitInfo)</span></span><span class="hljs-symbol">:</span>
    LOG.INFO (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
    print (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
</code></pre>
<h3 id="indexhedgealpha-&#x6307;&#x6570;&#x5BF9;&#x51B2;&#xFF08;&#x80A1;&#x7968;&#x671F;&#x8D27;&#xFF09;"><a name="indexhedgealpha-&#x6307;&#x6570;&#x5BF9;&#x51B2;&#xFF08;&#x80A1;&#x7968;&#x671F;&#x8D27;&#xFF09;" class="anchor-navigation-ex-anchor" href="#indexhedgealpha-&#x6307;&#x6570;&#x5BF9;&#x51B2;&#xFF08;&#x80A1;&#x7968;&#x671F;&#x8D27;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>index_hedge_alpha-&#x6307;&#x6570;&#x5BF9;&#x51B2;&#xFF08;&#x80A1;&#x7968;+&#x671F;&#x8D27;&#xFF09;</h3>
<pre><code class="lang-Ruby">#!/usr/bin/env python
# -*- coding: utf-8 -*-
from __future__ import print_function, absolute_import, unicode_literals,division
from etasdk import *

&apos;&apos;&apos; 
&#x6307;&#x6570;&#x5BF9;&#x51B2;&#x7B56;&#x7565;
&#x7B56;&#x7565;&#x57FA;&#x672C;&#x601D;&#x60F3;&#xFF1A;&#x672C;&#x7B56;&#x7565;&#x4E3A;&#x80A1;&#x7968;&#x5E02;&#x573A;&#x4E2D;&#x6027;&#x7B56;&#x7565;&#xFF0C;&#x5373;&#x80A1;&#x7968;&#x591A;&#x5934;+&#x80A1;&#x6307;&#x671F;&#x8D27;&#x7A7A;&#x5934;&#xFF0C;&#x4E8C;&#x8005;&#x5728;&#x6362;&#x4ED3;&#x65E5;&#x4FDD;&#x6301;&#x5E02;&#x503C;&#x76F8;&#x7B49;&#x3002;
&#x7B56;&#x7565;&#x4EA4;&#x6613;&#x9891;&#x7387;&#xFF1A;&#x6BCF;&#x6708;&#x6362;&#x4ED3;&#x4E00;&#x6B21;
&#x4EA4;&#x6613;&#x6216;&#x8BA2;&#x9605;&#x6807;&#x7684;&#xFF1A;&#x6CAA;&#x6DF1;300&#x6307;&#x6570;&#x7684;&#x6210;&#x5206;&#x80A1;&#x548C;&#x6CAA;&#x6DF1;300&#x6307;&#x6570;&#x671F;&#x8D27;&#xFF0C;&#x4ECE;&#x6CAA;&#x6DF1;300&#x6307;&#x6570;&#x6210;&#x5206;&#x80A1;&#x4E2D;&#x6309;&#x7167;&#x52A8;&#x91CF;&#x548C;&#x4F30;&#x503C;&#x9009;&#x51FA;30&#x53EA;&#x8F83;&#x5F3A;&#x7684;&#x80A1;&#x7968;&#x3002;
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#xFF1A;2016-12-01 &#x5230;2017-12-29
&#x64AE;&#x5408;&#x9891;&#x7387;&#xFF1A;&#x65E5;K
&#x521D;&#x59CB;&#x8D44;&#x91D1;&#xFF1A;A&#x80A1;200&#x4E07;&#xFF0C;&#x671F;&#x8D27;200&#x4E07;
&apos;&apos;&apos;
def onInitialize(api):
    #&#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x6C60;
    api.setSymbolPool(instsets=[&quot;IF.PRD&quot;,&quot;000300.IDX&quot;])
    # &#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x4E0B;&#x8F7D;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;
    api.setGroupMode(500, True)
    # &#x8BBE;&#x7F6E;&#x884C;&#x60C5;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x6761;&#x6570;
    api.data_len = 21
    api.setRequireBars(ETimeSpan.DAY_1,api.data_len)
    # &#x8BBE;&#x7F6E;&#x7F13;&#x5B58;&#x65E5;&#x9891;&#x56E0;&#x5B50;&#x6570;&#x636E;
    api.setRequireFields(fields=[&quot;PE&quot;])

    api.stock_num = 30
    api.trade_day_now = 0
    api.trade_day_last = 0
    api.lots_stock = {}
    api.futures_code = []
    api.lots_futures = 0

def onBeforeMarketOpen(api,trade_date):
    print (&quot;date&#xFF1A;&quot;,trade_date)
    # &#x8BA2;&#x9605;&#x7684;&#x6807;&#x7684;&#x4EE3;&#x7801;
    symbol_subscribe = api.getSymbolPool()
    data_code   = [ind01 for ind01 in symbol_subscribe if &quot;CS&quot; in ind01]
    api.futures_code =  api.getContinuousSymbol(&quot;IFZ0.CF&quot;, trade_date)

    data_code.append(str(api.futures_code))
    # &#x5173;&#x6CE8;&#x76F8;&#x5173;&#x80A1;&#x7968;&#x548C;&#x80A1;&#x6307;&#x671F;&#x8D27;
    # api.setFocusSymbols(data_code)
    # &#x5F53;&#x524D;&#x80A1;&#x6307;&#x671F;&#x8D27;&#x4E3B;&#x529B;&#x5408;&#x7EA6;&#x4EE3;&#x7801;
    api.futures_code =  api.getContinuousSymbol(&quot;IFZ0.CF&quot;, trade_date)

    # &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4EA4;&#x6613;&#x65E5;
    api.trade_day_now  = api.getCurrTradeDate()
    # &#x83B7;&#x53D6;&#x4E0A;&#x4E00;&#x4EA4;&#x6613;&#x65E5;
    api.trade_day_last = api.getPrevTradeDate(trade_date)

    # &#x5982;&#x679C;&#x5F53;&#x524D;&#x662F;&#x6BCF;&#x6708;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x5373;&#x9009;&#x80A1;&#x8C03;&#x4ED3;&#x5E76;&#x6267;&#x884C;&#x5BF9;&#x51B2;
    # if str(api.trade_day_now)[4:6] == str(api.trade_day_last)[4:6]: return
    # &#x83B7;&#x53D6;&#x80A1;&#x7968;&#x7684;PE&#x6307;&#x6807;&#x6570;&#x636E;
    findata = api.getFieldsOneDay(data_code[:-1], [&quot;PE&quot;],api.trade_day_last, df=True)
    findata.index = findata[&quot;symbol&quot;]
    # &#x83B7;&#x53D6;&#x5386;&#x53F2;&#x884C;&#x60C5;&#x6570;&#x636E;
    close = {}
    for ind03 in data_code:
        bars = api.getBarsHistory(ind03, ETimeSpan.DAY_1, count=api.data_len, priceMode=EPriceMode.FORMER, df=True)
        if (len(bars) &gt;= api.data_len) and (bars.ix[api.data_len-1,&quot;isSuspended&quot;] == 0):
            close[ind03] = bars.ix[api.data_len - 1, &quot;close&quot;]
            if (&quot;CS&quot; in ind03):
                findata.ix[ind03,&quot;momentum01&quot;] = (bars.ix[api.data_len-1,&quot;close&quot;]/bars.ix[0,&quot;close&quot;])-1
    # &#x5148;&#x6309;&#x7167;&#x4F30;&#x503C;PE&#x548C;&#x52A8;&#x91CF;&#x6392;&#x5E8F;&#x9009;&#x51FA;&#x524D;30&#x53EA;&#x80A1;&#x7968;
    findata[[&quot;ranks_pe&quot;,&quot;rank_mom&quot;]] = findata.rank()[[&quot;PE&quot;,&quot;momentum01&quot;]]
    findata[&quot;score&quot;]  = findata[&quot;rank_mom&quot;]-findata[&quot;ranks_pe&quot;]
    findata_sorted = findata.sort_values(&quot;score&quot;,ascending=False)[:api.stock_num]
    symbol_stock = list(findata_sorted.index.values)
    symbol_stock.append(api.futures_code)
    # &#x5173;&#x6CE8;&#x76F8;&#x5173;&#x80A1;&#x7968;&#x548C;&#x80A1;&#x6307;&#x671F;&#x8D27;
    api.setFocusSymbols(symbol_stock)

    symbolpositions = api.getSymbolPositions()

    # &#x6BCF;&#x5929;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x6362;&#x4ED3;

    for ind in symbolpositions:
        if ind.symbol not in symbol_stock:
            if ind.positionSide == EPositionSide.LONG:  # &#x80A1;&#x7968;&#x4E0D;&#x5728;&#x5173;&#x6CE8;&#x7684;&#x6807;&#x7684;&#x4E2D;&#xFF0C;&#x5356;&#x51FA;
                api.targetPosition(symbol=ind.symbol, qty=0, positionSide=EPositionSide.LONG)
            elif ind.positionSide == EPositionSide.SHORT:  # &#x671F;&#x8D27;&#x5728;&#x6362;&#x6708;&#x65F6;&#x523B;&#xFF0C;&#x8FD1;&#x6708;&#x5408;&#x7EA6;&#x5E73;&#x4ED3;
                api.targetPosition(symbol=ind.symbol, qty=0, positionSide=EPositionSide.SHORT)
                api.targetPosition(symbol=api.futures_code, qty=ind.posQty, positionSide=EPositionSide.SHORT)
                print(&quot;Shifting positions for months&#xFF0C;close market positions&#xFF1A;&quot;, ind.symbol)

    # &#x5E73;&#x5747;&#x5206;&#x914D;&#x6BCF;&#x53EA;&#x80A1;&#x7968;&#x8D44;&#x91D1;&#xFF0C;&#x8BA1;&#x7B97;&#x6BCF;&#x53EA;&#x80A1;&#x7968;&#x4ED3;&#x4F4D;
    api.lots_stock = {}
    account_stock   = api.getAccount(data_code[0])
    capital = account_stock.cashAvailable + account_stock.marketValue
    for ind05 in close.keys():
        if (&quot;CS&quot; in ind05) and (ind05 in symbol_stock):
            api.lots_stock[ind05] = int(capital*0.70/close[ind05]/api.stock_num/100.0)*100
        elif (&quot;CF&quot; in ind05) :
            api.lots_futures = int(capital*0.70/close[ind05]/300.0)

    # 1&#x3001;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4ED3;&#x4F4D;&#x6362;&#x4ED3;
    for ind04 in symbolpositions:
        symbol_last = ind04.symbol
        # &#x4E0D;&#x5728;&#x6807;&#x7684;&#x7684;&#x80A1;&#x7968;&#x5C06;&#x5356;&#x51FA;
        if (&quot;CS&quot; in symbol_last) and (symbol_last not in symbol_stock):
            api.targetPosition(symbol=symbol_last, qty=0)
            print(&quot;not in symbolPool&#xFF0C;close market positions&#xFF1A;&quot;, symbol_last)

def onHandleData(api, timeExch):
    # &#x5982;&#x679C;&#x5F53;&#x524D;&#x662F;&#x6BCF;&#x6708;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x5373;&#x9009;&#x80A1;&#x8C03;&#x4ED3;&#x5E76;&#x6267;&#x884C;&#x5BF9;&#x51B2;
    if str(api.trade_day_now)[4:6] == str(api.trade_day_last)[4:6]:
        return
        # 2&#x3001;&#x4E70;&#x5165;&#x6807;&#x7684;&#x6C60;&#x80A1;&#x7968;
    for ind06 in api.lots_stock.keys():
        # &#x5982;&#x679C;&#x80A1;&#x7968;&#x6709;&#x5206;&#x7EA2;&#x9001;&#x80A1;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x589E;&#x52A0;&#x4ED3;&#x4F4D;&#x4E5F;&#x9700;&#x8981;&#x65F6; 100 &#x7684;&#x6574;&#x6570;&#x500D;
        currentShares = api.getSymbolPosition(ind06).posQty
        addShares = ((api.lots_stock[ind06] - currentShares + 50) // 100) * 100
        totalShares = currentShares + addShares
        api.targetPosition(symbol=ind06, qty=totalShares)
        print(&quot;open market positions&#xFF1A;&quot;, ind06, totalShares)
    # &#x5F00;&#x7A7A;&#x80A1;&#x6307;&#x671F;&#x8D27;&#x5BF9;&#x51B2;
    api.targetPosition(symbol=api.futures_code, qty=api.lots_futures, positionSide=EPositionSide.SHORT)
    print(&quot;open market short positions&#xFF1A;&quot;, api.futures_code)

def onTerminate(api,exitInfo):
    print(&quot;onTerminate&quot;)
</code></pre>
<h2 id="&#x7CBE;&#x901A;&#x80A1;&#x7968;&#x7B56;&#x7565;"><a name="&#x7CBE;&#x901A;&#x80A1;&#x7968;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#&#x7CBE;&#x901A;&#x80A1;&#x7968;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7CBE;&#x901A;&#x80A1;&#x7968;&#x7B56;&#x7565;</h2>
<h3 id="machinelearning-&#x673A;&#x5668;&#x5B66;&#x4E60;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="machinelearning-&#x673A;&#x5668;&#x5B66;&#x4E60;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#machinelearning-&#x673A;&#x5668;&#x5B66;&#x4E60;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>machineLearning-&#x673A;&#x5668;&#x5B66;&#x4E60;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

from __future_<span class="hljs-number">_</span> import print_function, absolute_import
from etasdk import *
import numpy as np
from datetime import datetime
import sys
<span class="hljs-symbol">try:</span>
    from sklearn import svm
<span class="hljs-symbol">except:</span>
    print(<span class="hljs-string">&apos;please install scikit-learn and numpy with mkl&apos;</span>)
    sys.exit(-<span class="hljs-number">1</span>)

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x80A1;&#x7968;&#x7B56;&#x7565;&#xFF1A;&#x673A;&#x5668;&#x5B66;&#x4E60;
&#x672C;&#x7B56;&#x7565;&#x9009;&#x53D6;&#x4E86;&#x4E03;&#x4E2A;&#x7279;&#x5F81;&#x53D8;&#x91CF;&#x7EC4;&#x6210;&#x4E86;&#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x957F;&#x5EA6;&#x4E3A;20&#x5929;&#x7684;&#x8BAD;&#x7EC3;&#x96C6;, &#x8BAD;&#x7EC3;&#x4E86;&#x4E00;&#x4E2A;&#x4E8C;&#x5206;&#x7C7B;&#x7684;&#x652F;&#x6301;&#x5411;&#x91CF;&#x673A;&#x6A21;&#x578B;&#x6765;&#x9884;&#x6D4B;&#x80A1;&#x7968;&#x7684;&#x4E0A;&#x6DA8;&#x548C;&#x4E0B;&#x8DCC;.
&#x82E5;&#x6BCF;&#x4E2A;&#x661F;&#x671F;&#x4E00;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#x5219;&#x8BA1;&#x7B97;&#x6807;&#x7684;&#x80A1;&#x7968;&#x8FD1;20&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x7684;&#x7279;&#x5F81;&#x53D8;&#x91CF;&#x8FDB;&#x884C;&#x9884;&#x6D4B;,&#x5E76;&#x5728;&#x9884;&#x6D4B;&#x7ED3;&#x679C;&#x4E3A;&#x4E0A;&#x6DA8;&#x7684;&#x65F6;&#x5019;&#x8D2D;&#x4E70;&#x6807;&#x7684;.
&#x82E5;&#x5DF2;&#x7ECF;&#x6301;&#x6709;&#x4ED3;&#x4F4D;&#x5219;&#x5728;&#x76C8;&#x5229;&#x5927;&#x4E8E;10%&#x7684;&#x65F6;&#x5019;&#x6B62;&#x76C8;,&#x5728;&#x661F;&#x671F;&#x4E94;&#x635F;&#x5931;&#x5927;&#x4E8E;2%&#x7684;&#x65F6;&#x5019;&#x6B62;&#x635F;.
&#x7279;&#x5F81;&#x4E3A;:1.&#x6536;&#x76D8;&#x4EF7;/&#x5747;&#x503C;2.&#x73B0;&#x91CF;/&#x5747;&#x91CF;3.&#x6700;&#x9AD8;&#x4EF7;/&#x5747;&#x4EF7;4.&#x6700;&#x4F4E;&#x4EF7;/&#x5747;&#x4EF7;5.&#x73B0;&#x91CF;6.&#x533A;&#x95F4;&#x6536;&#x76CA;&#x7387;7.&#x533A;&#x95F4;&#x6807;&#x51C6;&#x5DEE;
&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#x4E3A;:600036.CS&#x62DB;&#x5546;&#x94F6;&#x884C;,&#x65F6;&#x95F4;&#x4ECE;20170507&#x5230;20171107
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#x4E3A;:20171108-20181101
&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;&#x65E5;K
&apos;</span><span class="hljs-string">&apos;&apos;</span>

<span class="hljs-comment">#&#x521D;&#x59CB;&#x5316;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x6570;&#x636E;&#x6ED1;&#x7A97;</span>
    <span class="hljs-comment"># &#x56DE;&#x6D4B;&#x65F6;&#x95F4;20171108-20181101</span>
    api.train_start_date = <span class="hljs-number">20170507</span>
    api.train_end_date = <span class="hljs-number">20171107</span>
    api.trainFinished = False
    api.symbol = <span class="hljs-string">&quot;600036.CS&quot;</span> <span class="hljs-comment"># &#x8BA2;&#x9605;&#x62DB;&#x5546;&#x94F6;&#x884C;&#x80A1;&#x7968;</span>
    api.ratio = <span class="hljs-number">0</span>.<span class="hljs-number">8</span>
    api.dataWindow = <span class="hljs-number">20</span>
    api.clf = None
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x6C60;&#xFF0C;&#x56E0;&#x5B50;&#x4EE5;&#x53CA;K&#x7EBF;&#x7C7B;&#x578B;</span>
    api.setRequireData(symbols=[api.symbol],
                       bars=[(ETimeSpan.DAY_1, <span class="hljs-number">1000</span>)])
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x6309;&#x7EC4;&#x56DE;&#x8C03;</span>
    api.setGroupMode(timeOutMs=<span class="hljs-number">10000</span>, onlyGroup = False);

<span class="hljs-comment"># train</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">trainHistoryData</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x76EE;&#x6807;&#x80A1;&#x7968;&#x7684;daily&#x5386;&#x53F2;&#x884C;&#x60C5;</span>
    recent_data = api.getBarsHistory(api.symbol, timeSpan=ETimeSpan.DAY_1, count=<span class="hljs-number">1000</span>, df=True, \
                                   priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
    recent_data.fillna(method=<span class="hljs-string">&quot;ffill&quot;</span>)
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x76EE;&#x6807;&#x80A1;&#x7968;&#x7684;&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#x96C6;</span>
    recent_data = recent_data[(recent_data[<span class="hljs-string">&quot;tradeDate&quot;</span>] &gt;= api.train_start_date) &amp; (recent_data[<span class="hljs-string">&quot;tradeDate&quot;</span>] &lt;= api.train_end_date)]
    days_value = recent_data[<span class="hljs-string">&apos;tradeDate&apos;</span>].values
    days_close = recent_data[<span class="hljs-string">&apos;close&apos;</span>].values
    days = []
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x884C;&#x60C5;&#x65E5;&#x671F;&#x5217;&#x8868;</span>
    print(<span class="hljs-string">&apos;prepare training data for SVM&apos;</span>, api.train_start_date, <span class="hljs-string">&quot; - &quot;</span>, api.train_end_date)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(days_value))<span class="hljs-symbol">:</span>
        days.append(days_value[i])

    x_all = []
    y_all = []
    <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(api.dataWindow, (len(days) - <span class="hljs-number">5</span>))<span class="hljs-symbol">:</span>
        <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x4E00;&#x4E2A;&#x6708;&#x5171;20&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x76F8;&#x5173;&#x6570;&#x636E;</span>
        start_day = days[index - api.dataWindow]
        end_day = days[index]
        data = recent_data[(recent_data[<span class="hljs-string">&quot;tradeDate&quot;</span>] &gt;= start_day) &amp;(recent_data[<span class="hljs-string">&quot;tradeDate&quot;</span>] &lt;= end_day)]
        close = data[<span class="hljs-string">&apos;close&apos;</span>].values
        max_x = data[<span class="hljs-string">&apos;high&apos;</span>].values
        min_n = data[<span class="hljs-string">&apos;low&apos;</span>].values
        amount = data[<span class="hljs-string">&apos;totalVolume&apos;</span>].values
        volume = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(close))<span class="hljs-symbol">:</span>
            volume_temp = amount[i] / close[i]
            volume.append(volume_temp)

        close_mean = close[-<span class="hljs-number">1</span>] / np.mean(close)  <span class="hljs-comment"># &#x6536;&#x76D8;&#x4EF7;/&#x5747;&#x503C;</span>
        volume_mean = volume[-<span class="hljs-number">1</span>] / np.mean(volume)  <span class="hljs-comment"># &#x73B0;&#x91CF;/&#x5747;&#x91CF;</span>
        max_mean = max_x[-<span class="hljs-number">1</span>] / np.mean(max_x)  <span class="hljs-comment"># &#x6700;&#x9AD8;&#x4EF7;/&#x5747;&#x4EF7;</span>
        min_mean = min_n[-<span class="hljs-number">1</span>] / np.mean(min_n)  <span class="hljs-comment"># &#x6700;&#x4F4E;&#x4EF7;/&#x5747;&#x4EF7;</span>
        vol = volume[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># &#x73B0;&#x91CF;</span>
        return_now = close[-<span class="hljs-number">1</span>] / close[<span class="hljs-number">0</span>]  <span class="hljs-comment"># &#x533A;&#x95F4;&#x6536;&#x76CA;&#x7387;</span>
        std = np.std(np.array(close), axis=<span class="hljs-number">0</span>)  <span class="hljs-comment"># &#x533A;&#x95F4;&#x6807;&#x51C6;&#x5DEE;</span>

        <span class="hljs-comment"># &#x5C06;&#x8BA1;&#x7B97;&#x51FA;&#x7684;&#x6307;&#x6807;&#x6DFB;&#x52A0;&#x5230;&#x8BAD;&#x7EC3;&#x96C6;X</span>
        <span class="hljs-comment"># features&#x7528;&#x4E8E;&#x5B58;&#x653E;&#x56E0;&#x5B50;</span>
        features = [close_mean, volume_mean, max_mean, min_mean, vol, return_now, std]
        x_all.append(features)

    <span class="hljs-comment"># &#x51C6;&#x5907;&#x7B97;&#x6CD5;&#x9700;&#x8981;&#x7528;&#x5230;&#x7684;&#x6570;&#x636E;</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(days_close) - api.dataWindow - <span class="hljs-number">5</span>)<span class="hljs-symbol">:</span>
        <span class="hljs-keyword">if</span> days_close[i + api.dataWindow + <span class="hljs-number">5</span>] &gt; days_close[i + api.dataWindow]<span class="hljs-symbol">:</span>
            label = <span class="hljs-number">1</span>
        <span class="hljs-symbol">else:</span>
            label = <span class="hljs-number">0</span>
        y_all.append(label)

    x_train = x_all[<span class="hljs-symbol">:</span> -<span class="hljs-number">1</span>]
    y_train = y_all[<span class="hljs-symbol">:</span> -<span class="hljs-number">1</span>]
    <span class="hljs-comment"># &#x8BAD;&#x7EC3;SVM</span>
    api.clf = svm.SVC(C=<span class="hljs-number">1.0</span>, kernel=str(<span class="hljs-string">&apos;rbf&apos;</span>), degree=<span class="hljs-number">3</span>, gamma=str(<span class="hljs-string">&apos;auto&apos;</span>), coef<span class="hljs-number">0</span>=<span class="hljs-number">0</span>.<span class="hljs-number">0</span>, shrinking=True, probability=False,
                          tol=<span class="hljs-number">0</span>.<span class="hljs-number">001</span>, cache_size=<span class="hljs-number">400</span>, verbose=False, max_iter=-<span class="hljs-number">1</span>,
                          decision_function_shape=str(<span class="hljs-string">&apos;ovr&apos;</span>), random_state=None)
    print(x_train, y_train)
    api.clf.fit(x_train, y_train)
    <span class="hljs-comment">#print(&apos;finished training!&apos;)</span>

<span class="hljs-comment">#&#x76D8;&#x524D;&#x8FD0;&#x884C;&#xFF0C;&#x7528;&#x4E8E;&#x9009;&#x80A1;&#x903B;&#x8F91;&#xFF1B;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#xFF0C;&#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x5F53;&#x65E5;&#x5173;&#x6CE8;&#x7684;&#x6807;&#x7684;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api,tradeDate)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;on date&quot;</span>, tradeDate)
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5F53;&#x5929;&#x9700;&#x8981;&#x4EA4;&#x6613;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x5982;&#x679C;&#x5386;&#x53F2;&#x4E0A;&#x6709;&#x8FC7;&#x6301;&#x4ED3;&#x4E86;&#xFF0C;&#x5219;&#x7CFB;&#x7EDF;&#x4F1A;&#x9ED8;&#x8BA4;&#x81EA;&#x52A8;&#x5173;&#x6CE8;</span>
    api.setFocusSymbols(api.symbol)
    <span class="hljs-comment"># firstly time to run, need to train the system</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api.<span class="hljs-symbol">trainFinished:</span>
        trainHistoryData(api)
        api.trainFinished = True

    <span class="hljs-comment"># &#x5F53;&#x524D;&#x5DE5;&#x4F5C;&#x65E5;</span>
    weekday = datetime.strptime(str(tradeDate), <span class="hljs-string">&apos;%Y%m%d&apos;</span>).isoweekday()
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6301;&#x4ED3;</span>
    symbolposition = api.getSymbolPosition(api.symbol)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x9884;&#x6D4B;&#x7528;&#x7684;&#x5386;&#x53F2;&#x6570;&#x636E;</span>
    data = api.getBarsHistory(api.symbol, timeSpan=ETimeSpan.DAY_1, count=api.dataWindow, df=True, \
                              priceMode=EPriceMode.FORMER, skipSuspended=<span class="hljs-number">0</span>)
    data.fillna(method=<span class="hljs-string">&quot;ffill&quot;</span>)
    <span class="hljs-comment"># &#x5982;&#x679C;&#x662F;&#x65B0;&#x7684;&#x661F;&#x671F;&#x4E00;&#x4E14;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#x5219;&#x5F00;&#x59CB;&#x9884;&#x6D4B;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> symbolposition <span class="hljs-keyword">or</span> symbolposition.posQty == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> weekday == <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
        close = data[<span class="hljs-string">&apos;close&apos;</span>].values
        train_max_x = data[<span class="hljs-string">&apos;high&apos;</span>].values
        train_min_n = data[<span class="hljs-string">&apos;low&apos;</span>].values
        train_amount = data[<span class="hljs-string">&apos;totalVolume&apos;</span>].values
        volume = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(close))<span class="hljs-symbol">:</span>
            volume_temp = train_amount[i] / close[i]
            volume.append(volume_temp)

        close_mean = close[-<span class="hljs-number">1</span>] / np.mean(close)
        volume_mean = volume[-<span class="hljs-number">1</span>] / np.mean(volume)
        max_mean = train_max_x[-<span class="hljs-number">1</span>] / np.mean(train_max_x)
        min_mean = train_min_n[-<span class="hljs-number">1</span>] / np.mean(train_min_n)
        vol = volume[-<span class="hljs-number">1</span>]
        return_now = close[-<span class="hljs-number">1</span>] / close[<span class="hljs-number">0</span>]
        std = np.std(np.array(close), axis=<span class="hljs-number">0</span>)

        <span class="hljs-comment"># &#x5F97;&#x5230;&#x672C;&#x6B21;&#x8F93;&#x5165;&#x6A21;&#x578B;&#x7684;&#x56E0;&#x5B50;</span>
        features = [close_mean, volume_mean, max_mean, min_mean, vol, return_now, std]
        features = np.array(features).reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> api.<span class="hljs-symbol">clf:</span>
            prediction = api.clf.predict(features)[<span class="hljs-number">0</span>]
        <span class="hljs-symbol">else:</span>
            print(<span class="hljs-string">&quot;[ERR]: train model is None&quot;</span>)

        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8D26;&#x6237;&#x4FE1;&#x606F;</span>
        account = api.getAccount(api.symbol)
        totAssets = account.totAssets
        eachTickerCapital = totAssets * api.ratio
        <span class="hljs-comment"># &#x82E5;&#x9884;&#x6D4B;&#x503C;&#x4E3A;&#x4E0A;&#x6DA8;&#x5219;&#x5F00;&#x4ED3;</span>
        <span class="hljs-keyword">if</span> prediction == <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
            <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6628;&#x6536;&#x76D8;&#x4EF7;</span>
            price = close[-<span class="hljs-number">1</span>]
            <span class="hljs-comment"># &#x5F00;&#x4ED3;</span>
            qty = int(eachTickerCapital / price / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
            api.targetPosition(symbol=api.symbol, qty=qty)
            print(api.symbol, <span class="hljs-string">&apos;open positions for qty of&apos;</span>, qty)

    <span class="hljs-comment"># &#x5F53;&#x6DA8;&#x5E45;&#x5927;&#x4E8E;10%,&#x5E73;&#x6389;&#x6240;&#x6709;&#x4ED3;&#x4F4D;&#x6B62;&#x76C8;</span>
    elif symbolposition <span class="hljs-keyword">and</span> data.close.values[-<span class="hljs-number">1</span>] / symbolposition.posPrice &gt;= <span class="hljs-number">1.10</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">if</span> symbolposition.posQty != <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=api.symbol, qty=<span class="hljs-number">0</span>)
            print(<span class="hljs-string">&apos;stop win, close positions for&apos;</span>, api.symbol)

    <span class="hljs-comment"># &#x5F53;&#x65F6;&#x95F4;&#x4E3A;&#x5468;&#x4E94;&#x5E76;&#x4E14;&#x8DCC;&#x5E45;&#x5927;&#x4E8E;2%&#x65F6;,&#x5E73;&#x6389;&#x6240;&#x6709;&#x4ED3;&#x4F4D;&#x6B62;&#x635F;</span>
    elif symbolposition <span class="hljs-keyword">and</span> data.close.values[-<span class="hljs-number">1</span>] / symbolposition.posPrice &lt; <span class="hljs-number">1.02</span> <span class="hljs-keyword">and</span> weekday == <span class="hljs-number">5</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">if</span> symbolposition.posQty != <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=api.symbol, qty=<span class="hljs-number">0</span>)
            print(<span class="hljs-string">&apos;stop loss, close positions for&apos;</span>, api.symbol)

<span class="hljs-comment">#&#x7B56;&#x7565;&#x7EC8;&#x6B62;&#x65F6;&#x54CD;&#x5E94;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api,exitInfo)</span></span><span class="hljs-symbol">:</span>
    LOG.INFO (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
    print (<span class="hljs-string">&quot;***************onTerminate*********&quot;</span>)
</code></pre>
<h3 id="intradaystocktrade-&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><a name="intradaystocktrade-&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#xFF08;&#x80A1;&#x7968;&#xFF09;" class="anchor-navigation-ex-anchor" href="#intradaystocktrade-&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#xFF08;&#x80A1;&#x7968;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>intradayStockTrade-&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#xFF08;&#x80A1;&#x7968;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals,division
from etasdk import *
import numpy as np
from pandas import DataFrame
import sys
<span class="hljs-symbol">try:</span>
    import talib
<span class="hljs-symbol">except:</span>
    print(<span class="hljs-string">&apos;please install TA-Lib&apos;</span>)
    sys.exit(-<span class="hljs-number">1</span>)

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x672C;&#x7B56;&#x7565;&#x4E3A;&#x80A1;&#x7968;&#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x4EA4;&#x6613;&#x3002;
1&#x3001;&#x9996;&#x5148;&#x4E70;&#x5165;600000.CS&#x80A1;&#x7968;10000&#x80A1;&#x5E95;&#x4ED3;&#xFF1B;
2&#x3001;&#x6839;&#x636E;&#x5206;&#x949F;&#x6570;&#x636E;&#x8BA1;&#x7B97;MACD(12,26,9)&#xFF1A;
&#x5728;MACD&gt;0&#x7684;&#x65F6;&#x5019;&#x4E70;&#x5165;100&#x80A1;;&#x5728;MACD&lt;0&#x7684;&#x65F6;&#x5019;&#x5356;&#x51FA;100&#x80A1;
3&#x3001;&#x6BCF;&#x65E5;&#x64CD;&#x4F5C;&#x7684;&#x80A1;&#x7968;&#x6570;&#x4E0D;&#x8D85;&#x8FC7;&#x539F;&#x6709;&#x4ED3;&#x4F4D;,&#x5E76;&#x4E8E;&#x6536;&#x76D8;&#x524D;&#x628A;&#x4ED3;&#x4F4D;&#x8C03;&#x6574;&#x81F3;&#x5F00;&#x76D8;&#x524D;&#x7684;&#x4ED3;&#x4F4D;
&#x64AE;&#x5408;&#x5468;&#x671F;&#x4E3A;:600000.CS&#x5206;&#x949F;&#x6570;&#x636E;
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#x4E3A;:2018-09-03 &#x5230;2018-10-01
&#x5176;&#x4ED6;&#x53C2;&#x6570;&#xFF1A;&#x6309;&#x7CFB;&#x7EDF;&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;
&apos;</span><span class="hljs-string">&apos;&apos;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment">## &#x5168;&#x5C40;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;</span>
    print(<span class="hljs-string">&quot;SDK version:&quot;</span>,GlobalConfig.getVersion())
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x6807;&#x7684;&#x80A1;&#x7968;</span>
    api.symbol = <span class="hljs-string">&apos;600000.CS&apos;</span>
    <span class="hljs-comment"># &#x8BA2;&#x9605;&#x6807;&#x7684;</span>
    api.setSymbolPool(instsets=[], symbols=[api.symbol])
    api.setGroupMode(<span class="hljs-number">1000</span>, False)
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x884C;&#x60C5;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x6761;&#x6570;</span>
    api.init_data_len = <span class="hljs-number">120</span>  <span class="hljs-comment"># &#x6570;&#x636E;&#x957F;&#x5EA6;</span>
    api.setRequireBars(ETimeSpan.MIN_1, api.init_data_len)

    <span class="hljs-comment"># &#x5E95;&#x4ED3;</span>
    api.total = <span class="hljs-number">10000</span>
    <span class="hljs-comment"># &#x7528;&#x4E8E;&#x5224;&#x5B9A;&#x7B2C;&#x4E00;&#x4E2A;&#x4ED3;&#x4F4D;&#x662F;&#x5426;&#x6210;&#x529F;&#x5F00;&#x4ED3;</span>
    api.first = <span class="hljs-number">0</span>
    <span class="hljs-comment"># &#x65E5;&#x5185;&#x56DE;&#x8F6C;&#x6BCF;&#x6B21;&#x4EA4;&#x6613;100&#x80A1;</span>
    api.trade_n = <span class="hljs-number">100</span>
    <span class="hljs-comment"># &#x4EA4;&#x6613;&#x65E5;</span>
    api.tradeDate = [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
    <span class="hljs-comment"># &#x6BCF;&#x65E5;&#x4ED3;&#x4F4D;</span>
    api.turnaround = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
    <span class="hljs-comment"># &#x7528;&#x4E8E;&#x5224;&#x65AD;&#x662F;&#x5426;&#x89E6;&#x53D1;&#x4E86;&#x56DE;&#x8F6C;&#x903B;&#x8F91;&#x7684;&#x8BA1;&#x65F6;</span>
    api.ending = <span class="hljs-number">0</span>
    <span class="hljs-comment"># &#x5F53;&#x65E5;&#x53EF;&#x5E73;&#x4ED3;&#x6570;&#x91CF;</span>
    api.availableQty = <span class="hljs-number">0</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api,trade_date)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;tradingday: &quot;</span>,trade_date)
    <span class="hljs-comment"># &#x6BCF;&#x65E5;&#x5F00;&#x76D8;&#x524D;&#x8BA2;&#x9605;&#x884C;&#x60C5;</span>
    api.setFocusSymbols(api.symbol)
    print(<span class="hljs-string">&quot;Focus symbols: %s&quot;</span> <span class="hljs-string">%(api.symbol)</span>)
    <span class="hljs-comment"># &#x67E5;&#x8BE2;&#x5F53;&#x65E5;&#x53EF;&#x5E73;&#x4ED3;&#x6570;&#x91CF;</span>
    api.availableQty = api.getSymbolPosition(symbol=api.symbol, positionSide=EPositionSide.LONG)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBar</span><span class="hljs-params">(api, bar)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-keyword">if</span> api.first == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
        <span class="hljs-comment"># &#x8D2D;&#x4E70;10000&#x80A1;&apos;600000.CS&apos;&#x80A1;&#x7968;</span>
        api.targetPosition(symbol=bar.symbol, qty=api.total, positionSide=EPositionSide.LONG, remark=<span class="hljs-string">&quot;open new position&quot;</span>)
        print(<span class="hljs-string">&quot;open in new long postion by market order:&quot;</span>, bar.symbol)
        api.first = <span class="hljs-number">1</span>.
        api.tradeDate[-<span class="hljs-number">1</span>] = bar.tradeDate
        <span class="hljs-comment"># &#x6BCF;&#x5929;&#x7684;&#x4ED3;&#x4F4D;&#x64CD;&#x4F5C;</span>
        api.turnaround = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># &#x66F4;&#x65B0;&#x6700;&#x65B0;&#x7684;&#x65E5;&#x671F;</span>
    api.tradeDate[<span class="hljs-number">0</span>] = bar.tradeDate
    <span class="hljs-comment"># &#x82E5;&#x4E3A;&#x65B0;&#x7684;&#x4E00;&#x5929;,&#x83B7;&#x53D6;&#x53EF;&#x7528;&#x4E8E;&#x56DE;&#x8F6C;&#x7684;&#x6628;&#x4ED3;</span>
    <span class="hljs-keyword">if</span> api.tradeDate[<span class="hljs-number">0</span>] != api.tradeDate[-<span class="hljs-number">1</span>]<span class="hljs-symbol">:</span>
        api.ending = <span class="hljs-number">0</span>
        api.turnaround = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
    <span class="hljs-keyword">if</span> api.ending == <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># &#x82E5;&#x6709;&#x53EF;&#x7528;&#x7684;&#x6628;&#x4ED3;&#x5219;&#x64CD;&#x4F5C;</span>
    <span class="hljs-keyword">if</span> api.total &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> api.availableQty.availableQty &gt; <span class="hljs-number">0</span> <span class="hljs-symbol">:</span>
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x65F6;&#x95F4;&#x5E8F;&#x5217;&#x6570;&#x636E;</span>
        recent_data = api.getBarsHistory(api.symbol, timeSpan=ETimeSpan.MIN_1, count=api.init_data_len, df=True,priceMode=EPriceMode.FORMER,skipSuspended=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># &#x8BA1;&#x7B97;MACD&#x7EBF;</span>
        macd = talib.MACD(recent_data[<span class="hljs-string">&apos;close&apos;</span>].values)[<span class="hljs-number">0</span>][-<span class="hljs-number">1</span>]
        <span class="hljs-comment"># &#x6839;&#x636E;MACD&gt;0&#x5219;&#x5F00;&#x4ED3;,&#x5C0F;&#x4E8E;0&#x5219;&#x5E73;&#x4ED3;</span>
        <span class="hljs-keyword">if</span> macd &gt; <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            <span class="hljs-comment"># &#x591A;&#x7A7A;&#x5355;&#x5411;&#x64CD;&#x4F5C;&#x90FD;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;&#x6628;&#x4ED3;&#x4F4D;,&#x5426;&#x5219;&#x6700;&#x540E;&#x65E0;&#x6CD5;&#x8C03;&#x56DE;&#x539F;&#x4ED3;&#x4F4D;</span>
            <span class="hljs-keyword">if</span> api.turnaround[<span class="hljs-number">0</span>] + api.trade_n &lt; api.<span class="hljs-symbol">total:</span>
                <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x7D2F;&#x8BA1;&#x4ED3;&#x4F4D;</span>
                api.turnaround[<span class="hljs-number">0</span>] += api.trade_n
                volume = api.total+api.turnaround[<span class="hljs-number">0</span>]-api.turnaround[<span class="hljs-number">1</span>]
                api.targetPosition(symbol=bar.symbol, qty=volume, positionSide=EPositionSide.LONG,
                                   remark=<span class="hljs-string">&quot;open new position&quot;</span>)
                print(<span class="hljs-string">&quot;open in new long postion by market order:%s : %i&quot;</span> <span class="hljs-string">%(bar.symbol,api.trade_n)</span>)
        elif macd &lt; <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            <span class="hljs-keyword">if</span> api.turnaround[<span class="hljs-number">1</span>] + api.trade_n &lt; api.<span class="hljs-symbol">total:</span>
                api.turnaround[<span class="hljs-number">1</span>] += api.trade_n
                volume = api.total + api.turnaround[<span class="hljs-number">0</span>] - api.turnaround[<span class="hljs-number">1</span>]
                api.targetPosition(symbol=bar.symbol, qty=volume, positionSide=EPositionSide.LONG,
                                   remark=<span class="hljs-string">&quot;close position&quot;</span>)
                print(<span class="hljs-string">&quot;close long postion by market order:%s : %i&quot;</span> <span class="hljs-string">%(bar.symbol, api.trade_n)</span>)
        <span class="hljs-comment"># &#x4E34;&#x8FD1;&#x6536;&#x76D8;&#x65F6;&#x82E5;&#x4ED3;&#x4F4D;&#x6570;&#x4E0D;&#x7B49;&#x4E8E;&#x6628;&#x4ED3;&#x5219;&#x56DE;&#x590D;&#x6240;&#x6709;&#x4ED3;&#x4F4D;</span>
        <span class="hljs-keyword">if</span> int(bar.timeStr[<span class="hljs-number">9</span><span class="hljs-symbol">:</span><span class="hljs-number">13</span>]) &gt;= <span class="hljs-number">1455</span><span class="hljs-symbol">:</span>
            print(<span class="hljs-string">&quot;recover position before close.&quot;</span>)
            symbolposition = api.getSymbolPosition (symbol=api.symbol,positionSide=EPositionSide.LONG)
            <span class="hljs-keyword">if</span> symbolposition.posQty != api.<span class="hljs-symbol">total:</span>
                api.targetPosition(symbol=bar.symbol, qty=api.total, positionSide=EPositionSide.LONG,
                                   remark=<span class="hljs-string">&quot;target position&quot;</span>)
                print(<span class="hljs-string">&quot;To target position:%d&quot;</span> <span class="hljs-string">%(api.total)</span>)
                api.ending = <span class="hljs-number">1</span>
        <span class="hljs-comment"># &#x66F4;&#x65B0;&#x8FC7;&#x53BB;&#x7684;&#x65E5;&#x671F;&#x6570;&#x636E;</span>
        api.tradeDate[-<span class="hljs-number">1</span>] = api.tradeDate[<span class="hljs-number">0</span>]
</code></pre>
<h2 id="&#x9AD8;&#x9636;&#x7ECF;&#x5178;&#x671F;&#x8D27;&#x7B56;&#x7565;"><a name="&#x9AD8;&#x9636;&#x7ECF;&#x5178;&#x671F;&#x8D27;&#x7B56;&#x7565;" class="anchor-navigation-ex-anchor" href="#&#x9AD8;&#x9636;&#x7ECF;&#x5178;&#x671F;&#x8D27;&#x7B56;&#x7565;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9AD8;&#x9636;&#x7ECF;&#x5178;&#x671F;&#x8D27;&#x7B56;&#x7565;</h2>
<h3 id="nettrade-&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><a name="nettrade-&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;" class="anchor-navigation-ex-anchor" href="#nettrade-&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>net_trade-&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;</h3>
<p>&#x672C;&#x7B56;&#x7565;&#x4E3A;&#x7ECF;&#x5178;&#x7684;&#x671F;&#x8D27;&#x65E5;&#x5185;&#x7B56;&#x7565;&#xFF08;&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF09;&#xFF0C;&#x8BBE;&#x7F6E;&#x4E0D;&#x540C;&#x7684;&#x4E34;&#x754C;&#x7EBF;&#xFF0C;&#x5E76;&#x5206;&#x914D;&#x4E0D;&#x540C;&#x7684;&#x8D44;&#x91D1;&#x4ED3;&#x4F4D;</p>
<pre><code class="lang-Ruby"><span class="hljs-comment"># coding=utf-8</span>
from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals,division
from etasdk import *
import numpy as np
import pandas as pd
<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x7B56;&#x7565;&#x57FA;&#x672C;&#x601D;&#x60F3;&#xFF1A;&#x672C;&#x7B56;&#x7565;&#x4E3A;&#x7ECF;&#x5178;&#x7684;&#x671F;&#x8D27;&#x65E5;&#x5185;&#x7B56;&#x7565;&#xFF08;&#x7F51;&#x683C;&#x4EA4;&#x6613;&#xFF09;&#xFF0C;&#x8BBE;&#x7F6E;&#x4E0D;&#x540C;&#x7684;&#x4E34;&#x754C;&#x7EBF;&#xFF0C;&#x5E76;&#x5206;&#x914D;&#x4E0D;&#x540C;&#x7684;&#x8D44;&#x91D1;&#x4ED3;&#x4F4D;&#x3002;
&#x7B56;&#x7565;&#x4EA4;&#x6613;&#x9891;&#x7387;&#xFF1A;1&#x5206;&#x949F;
&#x4EA4;&#x6613;&#x6216;&#x8BA2;&#x9605;&#x6807;&#x7684;&#xFF1A;rb1801
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#xFF1A;2017-12-01 &#x5230;2017-12-29
&apos;</span><span class="hljs-string">&apos;&apos;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment">#&#x8BBE;&#x7F6E;&#x80A1;&#x7968;&#x6C60;</span>
    api.setSymbolPool(symbols=[<span class="hljs-string">&quot;rb1801.CF&quot;</span>])
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x884C;&#x60C5;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x6761;&#x6570;</span>
    api.data_len = <span class="hljs-number">100</span>
    api.setRequireBars(ETimeSpan.MIN_1,api.data_len)
    api.trade_product = str(<span class="hljs-string">&quot;rb1801.CF&quot;</span>)
    <span class="hljs-comment"># &#x67E5;&#x8BE2;&#x521D;&#x59CB;&#x8D44;&#x91D1;</span>
    account = api.getAccount(api.trade_product)
    api.capital = account.cashAvailable
    <span class="hljs-comment"># &#x4EA4;&#x6613;&#x53C2;&#x6570;&#x8BBE;&#x5B9A;</span>
    api.k1 = [-<span class="hljs-number">40.0</span>,-<span class="hljs-number">3.0</span>,-<span class="hljs-number">2.0</span>,<span class="hljs-number">2.0</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">40.0</span>]
    api.weight = [<span class="hljs-number">0</span>.<span class="hljs-number">5</span>,<span class="hljs-number">0</span>.<span class="hljs-number">3</span>, <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, <span class="hljs-number">0</span>.<span class="hljs-number">3</span>, <span class="hljs-number">0</span>.<span class="hljs-number">5</span>]
    api.trade_peroid = <span class="hljs-number">60</span> <span class="hljs-comment"># &#x6BCF;&#x5C0F;&#x65F6;&#x66F4;&#x65B0;&#x4E00;&#x6B21;&#x7F51;&#x683C;&#x4E34;&#x754C;&#x7EBF;</span>
    api.minute_num = <span class="hljs-number">0</span>
    api.level  = <span class="hljs-number">3.0</span>
    api.volume = []
    api.band   = []
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api, trade_date)</span></span><span class="hljs-symbol">:</span>
    print(trade_date)
    api.tradeday = trade_date
    <span class="hljs-comment">##  &#x8BA2;&#x9605;&#x884C;&#x60C5;</span>
    api.setFocusSymbols( api.trade_product)
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBar</span><span class="hljs-params">(api,data)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-keyword">if</span> (api.minute_num % api.trade_peroid) == <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
        <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8FC7;&#x53BB;300&#x4E2A;&#x6570;&#x636E;&#x8BA1;&#x7B97;&#x4E34;&#x754C;&#x7EBF;</span>
        data01 = api.getBarsHistory(data.symbol, timeSpan=ETimeSpan.MIN_1, count=api.data_len, df=False)
        close = []
        <span class="hljs-keyword">for</span> ind01 <span class="hljs-keyword">in</span> <span class="hljs-symbol">data01:</span>
            close.append(ind01.close)
        api.band = np.mean(close)+np.array(api.k1)*np.std(close)
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x7F51;&#x683C;&#x72B6;&#x6001;</span>
    grid = pd.cut([data.close],api.band,labels=[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>])[<span class="hljs-number">0</span>]
    print(grid)
    <span class="hljs-comment"># &#x66F4;&#x65B0;&#x8BA1;&#x7B97;&#x4EA4;&#x6613;&#x91CF;</span>
    api.volume = []
    <span class="hljs-keyword">for</span> weight <span class="hljs-keyword">in</span> api.<span class="hljs-symbol">weight:</span>
        api.volume.append(lots(api, data, weight))
    api.minute_num += <span class="hljs-number">1</span>
    <span class="hljs-comment"># &#x67E5;&#x8BE2;&#x6301;&#x4ED3;</span>
    position_long = api.getSymbolPosition(symbol=data.symbol, positionSide=EPositionSide.LONG)
    position_short = api.getSymbolPosition(symbol=data.symbol, positionSide=EPositionSide.SHORT)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> position_short.posQty <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> position_long.posQty <span class="hljs-keyword">and</span> grid != <span class="hljs-number">2</span><span class="hljs-symbol">:</span>
        <span class="hljs-keyword">if</span> grid &gt;= <span class="hljs-number">3</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=api.volume[grid], positionSide=EPositionSide.LONG)
            print(<span class="hljs-string">&quot;open market long positions 1&#xFF1A;&quot;</span>, data.symbol)
        <span class="hljs-keyword">if</span> grid &lt;= <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=api.volume[grid], positionSide=EPositionSide.SHORT)
            print(<span class="hljs-string">&quot;open market short positions 1&#xFF1A;&quot;</span>, data.symbol)
    elif position_long.<span class="hljs-symbol">posQty:</span>
        <span class="hljs-keyword">if</span> grid &gt;= <span class="hljs-number">3</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=api.volume[grid], positionSide=EPositionSide.LONG)
            print(<span class="hljs-string">&quot;open market long positions 2&#xFF1A;&quot;</span>, data.symbol)
        elif grid == <span class="hljs-number">2</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
            print(<span class="hljs-string">&quot;close market long positions&#xFF1A;&quot;</span>, data.symbol)
        elif grid &lt;= <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
            api.targetPosition(symbol=data.symbol, qty=api.volume[grid], positionSide=EPositionSide.SHORT)
            print(<span class="hljs-string">&quot;close market long and open market short positions&#xFF1A;&quot;</span>, data.symbol)
    elif position_short.<span class="hljs-symbol">posQty:</span>
        <span class="hljs-keyword">if</span> grid &lt;= <span class="hljs-number">1</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=api.volume[grid], positionSide=EPositionSide.SHORT)
            print(<span class="hljs-string">&quot;open market short positions 2&#xFF1A;&quot;</span>, data.symbol)
        elif grid == <span class="hljs-number">2</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            print(<span class="hljs-string">&quot;close market short positions&#xFF1A;&quot;</span>, data.symbol)
        elif grid &gt;= <span class="hljs-number">3</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=data.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            api.targetPosition(symbol=data.symbol, qty=api.volume[grid], positionSide=EPositionSide.LONG)
            print(<span class="hljs-string">&quot;close market short and open market long positions&#xFF1A;&quot;</span>, data.symbol)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lots</span><span class="hljs-params">(api, data,weight)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8D26;&#x6237;&#x8D44;&#x91D1;&#x8BA1;&#x7B97;&#x4E0B;&#x5355;&#x624B;&#x6570;</span>
    refdata = api.getRefData(data.symbol)
    multiper = refdata.valuePerUnit
    <span class="hljs-keyword">return</span> (int(api.capital * api.level*weight / data.close / multiper))
</code></pre>
<h3 id="turtletradingrule-&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><a name="turtletradingrule-&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;&#xFF08;&#x671F;&#x8D27;&#xFF09;" class="anchor-navigation-ex-anchor" href="#turtletradingrule-&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>turtleTradingRule-&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;&#xFF08;&#x671F;&#x8D27;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals

import sys
import numpy as np

<span class="hljs-symbol">try:</span>
    import talib
<span class="hljs-symbol">except:</span>
    print(<span class="hljs-string">&apos;please Install TA-Lib&apos;</span>)
    sys.exit(-<span class="hljs-number">1</span>)
from etasdk import *

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x671F;&#x8D27;&#x7B56;&#x7565;&#xFF1A;&#x6D77;&#x9F9F;&#x4EA4;&#x6613;&#x6CD5;
&#x672C;&#x7B56;&#x7565;&#x901A;&#x8FC7;&#x8BA1;&#x7B97;FG801.CF&#x548C;rb1801.CF&#x7684;ATR.&#x5510;&#x5947;&#x5B89;&#x901A;&#x9053;&#x548C;MA&#x7EBF;,
-- &#x5F53;&#x4EF7;&#x683C;&#x4E0A;&#x7A7F;&#x5510;&#x5947;&#x5B89;&#x901A;&#x9053;&#x4E14;&#x77ED;MA&#x5728;&#x957F;MA&#x4E0A;&#x65B9;&#x65F6;&#x5F00;&#x591A;&#x4ED3;;
-- &#x5F53;&#x4EF7;&#x683C;&#x4E0B;&#x7A7F;&#x5510;&#x5947;&#x5B89;&#x901A;&#x9053;&#x4E14;&#x77ED;MA&#x5728;&#x957F;MA&#x4E0B;&#x65B9;&#x65F6;&#x5F00;&#x7A7A;&#x4ED3;(8&#x624B;)
&#x82E5;&#x6709;&#x591A;&#x4ED3;&#x5219;&#x5728;&#x4EF7;&#x683C;&#x8DCC;&#x7834;&#x5510;&#x5947;&#x5B89;&#x5E73;&#x4ED3;&#x901A;&#x9053;&#x4E0B;&#x8F68;&#x7684;&#x65F6;&#x5019;&#x5168;&#x5E73;&#x4ED3;&#x4F4D;,&#x5426;&#x5219;&#x6839;&#x636E;&#x8DCC;&#x7834;
&#x6301;&#x4ED3;&#x5747;&#x4EF7; - x(x=0.5,1,1.5,2)&#x500D;ATR&#x628A;&#x4ED3;&#x4F4D;&#x5E73;&#x81F3;6/4/2/0&#x624B;
&#x82E5;&#x6709;&#x7A7A;&#x4ED3;&#x5219;&#x5728;&#x4EF7;&#x683C;&#x6DA8;&#x7834;&#x5510;&#x5947;&#x5B89;&#x5E73;&#x4ED3;&#x901A;&#x9053;&#x4E0A;&#x8F68;&#x7684;&#x65F6;&#x5019;&#x5168;&#x5E73;&#x4ED3;&#x4F4D;,&#x5426;&#x5219;&#x6839;&#x636E;&#x6DA8;&#x7834;
&#x6301;&#x4ED3;&#x5747;&#x4EF7; + x(x=0.5,1,1.5,2)&#x500D;ATR&#x628A;&#x4ED3;&#x4F4D;&#x5E73;&#x81F3;6/4/2/0&#x624B;
&#x64AE;&#x5408;&#x5468;&#x671F;&#x4E3A;:1&#x5206;&#x949F;
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#x4E3A;:2017-09-15 &#x5230;2017-10-01
&apos;</span><span class="hljs-string">&apos;&apos;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;analyzer initialize&quot;</span>)
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x54CD;&#x5E94;&#x6A21;&#x5F0F;</span>
    api.setGroupMode(<span class="hljs-number">5000</span>, False)
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x5173;&#x6CE8;&#x7684;&#x5408;&#x7EA6;&#x6807;&#x7684;</span>
    api.tickersCode = [<span class="hljs-string">&quot;FG1801.CF&quot;</span>, <span class="hljs-string">&quot;rb1801.CF&quot;</span>]

    <span class="hljs-comment"># api.parameter &#x5206;&#x522B;&#x4E3A;&#x5510;&#x5947;&#x5B89;&#x5F00;&#x4ED3;&#x901A;&#x9053;.&#x5510;&#x5947;&#x5B89;&#x5E73;&#x4ED3;&#x901A;&#x9053;.&#x77ED;ma.&#x957F;ma.ATR&#x7684;&#x53C2;&#x6570;</span>
    api.parameter = [<span class="hljs-number">55</span>, <span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60</span>, <span class="hljs-number">20</span>]
    api.tar = api.parameter[<span class="hljs-number">4</span>]

    api.data_len = <span class="hljs-number">600</span>

    api.setSymbolPool(symbols=api.tickersCode)
    api.setRequireBars(ETimeSpan.MIN_1, api.data_len)

    <span class="hljs-comment"># &#x521D;&#x59CB;&#x8D44;&#x91D1;&#x548C;&#x6570;&#x636E;&#x6D4B;&#x8BD5;</span>
    account = api.getAccount(symbol=api.tickersCode[<span class="hljs-number">0</span>], market=MARKET_CHINAFUTURE)
    api.capital = account.cashAvailable  <span class="hljs-comment"># &#x8D26;&#x6237;&#x521D;&#x59CB;&#x8D44;&#x91D1;</span>
    api.canTrade = True


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api, tradeDate)</span></span><span class="hljs-symbol">:</span>
    api.trading_day = tradeDate
    <span class="hljs-comment"># &#x8BA2;&#x9605;&#x884C;&#x60C5;</span>
    api.setFocusSymbols(api.tickersCode)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x8D26;&#x6237;&#x76C8;&#x4E8F;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x4E8F;&#x635F;&#x8D85;&#x8FC7;&#x521D;&#x59CB;&#x8D44;&#x91D1;&#x4E00;&#x534A;&#xFF0C;&#x4E0D;&#x518D;&#x5F00;&#x4ED3;</span>
    getStrategyPnL = api.getStrategyPnL()
    cumpnl_raw = api.capital + getStrategyPnL.overallPnL

    <span class="hljs-keyword">if</span> cumpnl_raw &lt; <span class="hljs-number">0</span>.<span class="hljs-number">5</span> * api.<span class="hljs-symbol">capital:</span>
        api.canTrade = False
        print(<span class="hljs-string">&quot;Losing more than half of the initial funds, closing all positions!&quot;</span>)
        symbol_positions = api.getSymbolPositions()
        <span class="hljs-keyword">for</span> symbol_obj <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbol_positions:</span>
            <span class="hljs-keyword">if</span> symbol_obj.positionSide == EPositionSide.<span class="hljs-symbol">SHORT:</span>
                api.targetPosition(symbol=symbol_obj.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            elif symbol_obj.positionSide == EPositionSide.<span class="hljs-symbol">LONG:</span>
                api.targetPosition(symbol=symbol_obj.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBar</span><span class="hljs-params">(api, bar)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-keyword">if</span> api.<span class="hljs-symbol">canTrade:</span>
        bar_data = api.getBarsHistory(symbol=bar.symbol, timeSpan=ETimeSpan.MIN_1, count=api.data_len,
                                      priceMode=EPriceMode.FORMER, fields=None, df=True)
        close = bar_data[<span class="hljs-string">&quot;close&quot;</span>].values[-<span class="hljs-number">1</span>]
        <span class="hljs-comment"># &#x8BA1;&#x7B97;ATR</span>
        atr = talib.ATR(bar_data[<span class="hljs-string">&quot;high&quot;</span>].values, bar_data[<span class="hljs-string">&quot;low&quot;</span>].values, bar_data[<span class="hljs-string">&quot;close&quot;</span>].values,
                        timeperiod=api.tar)[-<span class="hljs-number">1</span>]

        <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x5510;&#x5947;&#x5B89;&#x5F00;&#x4ED3;&#x548C;&#x5E73;&#x4ED3;&#x901A;&#x9053;</span>
        api.don_open = api.parameter[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>
        upper_band = talib.MAX(bar_data[<span class="hljs-string">&apos;close&apos;</span>].values[<span class="hljs-symbol">:-</span><span class="hljs-number">1</span>], timeperiod=api.don_open)[-<span class="hljs-number">1</span>]
        api.don_close = api.parameter[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>
        lower_band = talib.MIN(bar_data[<span class="hljs-string">&apos;close&apos;</span>].values[<span class="hljs-symbol">:-</span><span class="hljs-number">1</span>], timeperiod=api.don_close)[-<span class="hljs-number">1</span>]

        <span class="hljs-comment"># &#x82E5;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#x5219;&#x5F00;&#x4ED3;</span>
        position_long = api.getSymbolPosition(symbol=bar.symbol, positionSide=EPositionSide.LONG)
        position_short = api.getSymbolPosition(symbol=bar.symbol, positionSide=EPositionSide.SHORT)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> position_long.posQty <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> position_short.<span class="hljs-symbol">posQty:</span>
            <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x957F;&#x77ED;ma&#x7EBF;.DIF</span>
            ma_short = talib.MA(bar_data[<span class="hljs-string">&apos;close&apos;</span>].values, timeperiod=(api.parameter[<span class="hljs-number">2</span>] + <span class="hljs-number">1</span>))[-<span class="hljs-number">1</span>]
            ma_long = talib.MA(bar_data[<span class="hljs-string">&apos;close&apos;</span>].values, timeperiod=(api.parameter[<span class="hljs-number">3</span>] + <span class="hljs-number">1</span>))[-<span class="hljs-number">1</span>]

            diff = ma_short - ma_long

            <span class="hljs-comment"># &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x4EF7;&#x683C;</span>
            <span class="hljs-comment"># &#x4E0A;&#x7A7F;&#x5510;&#x5947;&#x5B89;&#x901A;&#x9053;&#x4E14;&#x77ED;ma&#x5728;&#x957F;ma&#x4E0A;&#x65B9;&#x5219;&#x5F00;&#x591A;&#x4ED3;</span>
            <span class="hljs-keyword">if</span> bar.close &gt; upper_band <span class="hljs-keyword">and</span> (diff &gt; <span class="hljs-number">0</span>)<span class="hljs-symbol">:</span>
                api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">8</span>, positionSide=EPositionSide.LONG)
                print(bar.symbol, <span class="hljs-string">&apos;Open 8 Long-shares at market position&apos;</span>)
            <span class="hljs-comment"># &#x4E0B;&#x7A7F;&#x5510;&#x5947;&#x5B89;&#x901A;&#x9053;&#x4E14;&#x77ED;ma&#x5728;&#x957F;ma&#x4E0B;&#x65B9;&#x5219;&#x5F00;&#x7A7A;&#x4ED3;</span>
            <span class="hljs-keyword">if</span> bar.low &lt; lower_band <span class="hljs-keyword">and</span> (diff &lt; <span class="hljs-number">0</span>)<span class="hljs-symbol">:</span>
                api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">8</span>, positionSide=EPositionSide.SHORT)
                print(bar.symbol, <span class="hljs-string">&apos;Open 8 Short-shares at market position&apos;</span>)

        elif position_long.<span class="hljs-symbol">posQty:</span>
            <span class="hljs-comment"># &#x4EF7;&#x683C;&#x8DCC;&#x7834;&#x5510;&#x5947;&#x5B89;&#x5E73;&#x4ED3;&#x901A;&#x9053;&#x5168;&#x5E73;&#x4ED3;&#x4F4D;&#x6B62;&#x635F;</span>
            <span class="hljs-keyword">if</span> close &lt; <span class="hljs-symbol">lower_band:</span>
                api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
                print(bar.symbol, <span class="hljs-string">&apos;Close all Long-positions&apos;</span>)
            <span class="hljs-symbol">else:</span>
                <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6301;&#x4ED3;&#x5747;&#x4EF7;</span>
                vwap = position_long.posPrice
                <span class="hljs-comment"># &#x6839;&#x636E;&#x6301;&#x4ED3;&#x4EE5;&#x6765;&#x7684;&#x6700;&#x9AD8;&#x4EF7;&#x8BA1;&#x7B97;&#x4E0D;&#x540C;&#x7684;&#x6B62;&#x635F;&#x4EF7;&#x683C;&#x5E26;</span>
                band = vwap - np.array([<span class="hljs-number">2</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>.<span class="hljs-number">5</span>]) * atr
                <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x6700;&#x65B0;&#x5E94;&#x6301;&#x4ED3;&#x4F4D;</span>
                <span class="hljs-keyword">if</span> bar.close &lt;= band[<span class="hljs-number">0</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
                    print(bar.symbol, <span class="hljs-string">&apos;Long target positions to 0 shares&apos;</span>)
                elif band[<span class="hljs-number">0</span>] &lt; bar.close &lt;= band[<span class="hljs-number">1</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">2</span>, positionSide=EPositionSide.LONG)
                    print(bar.symbol, <span class="hljs-string">&apos;Long target positions to 2 shares&apos;</span>)
                elif band[<span class="hljs-number">1</span>] &lt; bar.close &lt;= band[<span class="hljs-number">2</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">4</span>, positionSide=EPositionSide.LONG)
                    print(bar.symbol, <span class="hljs-string">&apos;Long target positions to 4 shares&apos;</span>)
                elif band[<span class="hljs-number">2</span>] &lt; bar.close &lt;= band[<span class="hljs-number">3</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">6</span>, positionSide=EPositionSide.LONG)
                    print(bar.symbol, <span class="hljs-string">&apos;Long target positions to 6 shares&apos;</span>)

        elif position_short.<span class="hljs-symbol">posQty:</span>
            <span class="hljs-comment"># &#x4EF7;&#x683C;&#x6DA8;&#x7834;&#x5510;&#x5947;&#x5B89;&#x5E73;&#x4ED3;&#x901A;&#x9053;&#x6216;&#x4EF7;&#x683C;&#x6DA8;&#x7834;&#x6301;&#x4ED3;&#x5747;&#x4EF7;&#x52A0;&#x4E24;&#x500D;ATR&#x5E73;&#x7A7A;&#x4ED3;</span>
            <span class="hljs-keyword">if</span> close &gt; <span class="hljs-symbol">upper_band:</span>
                api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
                print(bar.symbol, <span class="hljs-string">&apos;Close all Short-positions&apos;</span>)
            <span class="hljs-symbol">else:</span>
                <span class="hljs-comment"># &#x83B7;&#x53D6;&#x6301;&#x4ED3;&#x5747;&#x4EF7;</span>
                vwap = position_long.posPrice
                <span class="hljs-comment"># &#x6839;&#x636E;&#x6301;&#x4ED3;&#x4EE5;&#x6765;&#x7684;&#x6700;&#x9AD8;&#x4EF7;&#x8BA1;&#x7B97;&#x4E0D;&#x540C;&#x7684;&#x6B62;&#x635F;&#x4EF7;&#x683C;&#x5E26;</span>
                band = vwap + np.array([<span class="hljs-number">2</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>.<span class="hljs-number">5</span>]) * atr
                <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x6700;&#x65B0;&#x5E94;&#x6301;&#x4ED3;&#x4F4D;</span>
                <span class="hljs-keyword">if</span> bar.close &gt;= band[<span class="hljs-number">0</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
                    print(bar.symbol, <span class="hljs-string">&apos;Short target positions to 0 shares&apos;</span>)
                elif band[<span class="hljs-number">0</span>] &gt; bar.close &gt;= band[<span class="hljs-number">1</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">2</span>, positionSide=EPositionSide.SHORT)
                    print(bar.symbol, <span class="hljs-string">&apos;Short target positions to 2 shares&apos;</span>)
                elif band[<span class="hljs-number">1</span>] &gt; bar.close &gt;= band[<span class="hljs-number">2</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">4</span>, positionSide=EPositionSide.SHORT)
                    print(bar.symbol, <span class="hljs-string">&apos;Short target positions to 4 shares&apos;</span>)
                elif band[<span class="hljs-number">2</span>] &gt; bar.close &gt;= band[<span class="hljs-number">3</span>]<span class="hljs-symbol">:</span>
                    api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">6</span>, positionSide=EPositionSide.SHORT)
                    print(bar.symbol, <span class="hljs-string">&apos;Short target positions to 6 shares&apos;</span>)
    <span class="hljs-symbol">else:</span>
        print(<span class="hljs-string">&quot;Accumulated losses exceed half of the initial funds, no longer open positions!&quot;</span>)
        <span class="hljs-keyword">return</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api, exit_info)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;Finished test&quot;</span>)
    pass
</code></pre>
<h3 id="intercommodityspread-&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><a name="intercommodityspread-&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;" class="anchor-navigation-ex-anchor" href="#intercommodityspread-&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>interCommoditySpread-&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment"># coding=utf-8</span>
from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals
import datetime
from etasdk import *
import numpy as np

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x671F;&#x8D27;&#x7B56;&#x7565;&#xFF1A;&#x8DE8;&#x5E02;&#x573A;&#x5957;&#x5229;
&#x672C;&#x7B56;&#x7565;&#x9996;&#x5148;&#x6EDA;&#x52A8;&#x8BA1;&#x7B97;&#x8FC7;&#x53BB;30&#x4E2A;1min&#x6536;&#x76D8;&#x4EF7;&#x7684;&#x5747;&#x503C;,&#x7136;&#x540E;&#x7528;&#x5747;&#x503C;&#x52A0;&#x51CF;2&#x4E2A;&#x6807;&#x51C6;&#x5DEE;&#x5F97;&#x5230;&#x5E03;&#x6797;&#x7EBF;.
&#x82E5;&#x65E0;&#x4ED3;&#x4F4D;,&#x5728;&#x6700;&#x65B0;&#x4EF7;&#x5DEE;&#x4E0A;&#x7A7F;&#x4E0A;&#x8F68;&#x65F6;&#x505A;&#x7A7A;&#x4EF7;&#x5DEE;;&#x4E0B;&#x7A7F;&#x4E0B;&#x8F68;&#x65F6;&#x505A;&#x591A;&#x4EF7;&#x5DEE;
&#x82E5;&#x6709;&#x4ED3;&#x4F4D;&#x5219;&#x5728;&#x6700;&#x65B0;&#x4EF7;&#x5DEE;&#x56DE;&#x5F52;&#x81F3;&#x4E0A;&#x4E0B;&#x8F68;&#x6C34;&#x5E73;&#x5185;&#x65F6;&#x5E73;&#x4ED3;
&#x56DE;&#x6D4B;&#x6570;&#x636E;&#x4E3A;:rb1801&#x548C;hc1801&#x7684;1min&#x6570;&#x636E;
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#x4E3A;:2017-09-01 &#x5230;2017-09-29
&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;1&#x5206;&#x949F;
&#x521D;&#x59CB;&#x8D44;&#x91D1;&#xFF08;&#x671F;&#x8D27;&#xFF09;&#xFF1A;10&#x4E07;
&apos;</span><span class="hljs-string">&apos;&apos;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x54CD;&#x5E94;&#x6A21;&#x5F0F;</span>
    api.setGroupMode(<span class="hljs-number">5000</span>, False)
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;bar&#x957F;&#x5EA6;</span>
    api.data_len = <span class="hljs-number">30</span>
    <span class="hljs-comment"># &#x8FDB;&#x884C;&#x5957;&#x5229;&#x7684;&#x54C1;&#x79CD;</span>
    api.tickersCode = [<span class="hljs-string">&apos;rb1801.CF&apos;</span>, <span class="hljs-string">&apos;hc1801.CF&apos;</span>]        <span class="hljs-comment"># &quot;rb1801.CF&quot;---&#x87BA;&#x7EB9;1801&#x5408;&#x7EA6;</span>
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x884C;&#x60C5;&#x6570;&#x636E;&#x7F13;&#x5B58;</span>
    api.setRequireData(instsets=[<span class="hljs-string">&apos;rb.PRD&apos;</span>, <span class="hljs-string">&apos;hc.PRD&apos;</span>], symbols=api.tickersCode, fields=[], bars=[(ETimeSpan.MIN_1, <span class="hljs-number">300</span>)])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api,tradeDate)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># print(tradeDate)</span>
    api.trading_day = tradeDate
    <span class="hljs-comment"># &#x8BA2;&#x9605;&#x884C;&#x60C5;</span>
    api.setFocusSymbols(api.tickersCode)

    symbol_positions = api.getSymbolPositions()
    print(<span class="hljs-string">&quot;symbol_positions:&quot;</span>, symbol_positions)

    position_rb_long = api.getSymbolPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], positionSide=EPositionSide.LONG)
    position_rb_short = api.getSymbolPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], positionSide=EPositionSide.SHORT)



<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHandleData</span><span class="hljs-params">(api, timeExch)</span></span><span class="hljs-symbol">:</span>
    api.trade_date = datetime.datetime.fromtimestamp(timeExch / <span class="hljs-number">1000</span>)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x4E24;&#x4E2A;&#x54C1;&#x79CD;&#x7684;&#x65F6;&#x95F4;&#x5E8F;&#x5217;</span>
    data_rb = api.getBarsHistory(symbol=api.tickersCode[<span class="hljs-number">0</span>], timeSpan=ETimeSpan.MIN_1, count=api.data_len+<span class="hljs-number">1</span>,
                                 priceMode=EPriceMode.FORMER, fields=None, df=True)
    close_rb = data_rb[<span class="hljs-string">&quot;close&quot;</span>].values

    data_hc = api.getBarsHistory(symbol=api.tickersCode[<span class="hljs-number">1</span>], timeSpan=ETimeSpan.MIN_1, count=api.data_len+<span class="hljs-number">1</span>,
                                 priceMode=EPriceMode.FORMER, fields=None, df=True)
    close_hc = data_hc[<span class="hljs-string">&quot;close&quot;</span>].values

    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x4EF7;&#x5DEE;</span>
    spread = close_rb[<span class="hljs-symbol">:-</span><span class="hljs-number">1</span>] - close_hc[<span class="hljs-symbol">:-</span><span class="hljs-number">1</span>]
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x5E03;&#x6797;&#x5E26;&#x7684;&#x4E0A;&#x4E0B;&#x8F68;</span>
    up = np.mean(spread) + <span class="hljs-number">2</span> * np.std(spread)
    down = np.mean(spread) - <span class="hljs-number">2</span> * np.std(spread)
    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x6700;&#x65B0;&#x4EF7;&#x5DEE;</span>
    spread_now = close_rb[-<span class="hljs-number">1</span>] - close_hc[-<span class="hljs-number">1</span>]

    <span class="hljs-comment"># &#x65E0;&#x4EA4;&#x6613;&#x65F6;&#x82E5;&#x4EF7;&#x5DEE;&#x4E0A;(&#x4E0B;)&#x7A7F;&#x5E03;&#x6797;&#x5E26;&#x4E0A;(&#x4E0B;)&#x8F68;&#x5219;&#x505A;&#x7A7A;(&#x591A;)&#x4EF7;&#x5DEE;</span>
    position_rb_long = api.getSymbolPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], positionSide=EPositionSide.LONG)
    position_rb_short = api.getSymbolPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], positionSide=EPositionSide.SHORT)

    print(<span class="hljs-string">&quot;I&apos;m here!&quot;</span>)
    print(position_rb_long)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> position_rb_long <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-symbol">position_rb_short:</span>
        <span class="hljs-keyword">if</span> spread_now &gt; <span class="hljs-symbol">up:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])

        <span class="hljs-keyword">if</span> spread_now &lt; <span class="hljs-symbol">down:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])

    <span class="hljs-comment"># &#x4EF7;&#x5DEE;&#x56DE;&#x5F52;&#x65F6;&#x5E73;&#x4ED3;</span>
    elif <span class="hljs-symbol">position_rb_short:</span>
        <span class="hljs-keyword">if</span> spread_now &lt;= <span class="hljs-symbol">up:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Clear all positions&quot;</span>)

        <span class="hljs-comment"># &#x8DCC;&#x7834;&#x4E0B;&#x8F68;&#x53CD;&#x5411;&#x5F00;&#x4ED3;</span>
        <span class="hljs-keyword">if</span> spread_now &lt; <span class="hljs-symbol">down:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])

    elif <span class="hljs-symbol">position_rb_long:</span>
        <span class="hljs-keyword">if</span> spread_now &gt;= <span class="hljs-symbol">down:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Clear all positions&quot;</span>)
        <span class="hljs-comment"># &#x7A81;&#x7834;&#x4E0A;&#x8F68;&#x5F00;&#x591A;</span>
        <span class="hljs-keyword">if</span> spread_now &gt; <span class="hljs-symbol">up:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api,exitInfo)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;Finished test&quot;</span>)
</code></pre>
<h3 id="calendararbitrage-&#x8DE8;&#x671F;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><a name="calendararbitrage-&#x8DE8;&#x671F;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;" class="anchor-navigation-ex-anchor" href="#calendararbitrage-&#x8DE8;&#x671F;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>calendarArbitrage-&#x8DE8;&#x671F;&#x5957;&#x5229;&#xFF08;&#x671F;&#x8D27;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment"># coding=utf-8</span>
from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals
import sys
import datetime
import numpy as np
from etasdk import *
<span class="hljs-symbol">try:</span>
    import statsmodels.tsa.stattools as ts
<span class="hljs-symbol">except:</span>
    print(<span class="hljs-string">&apos;please install statsmodels&apos;</span>)
    sys.exit(-<span class="hljs-number">1</span>)

<span class="hljs-string">&apos;&apos;</span><span class="hljs-string">&apos;
&#x671F;&#x8D27;&#x7B56;&#x7565;&#xFF1A;&#x8DE8;&#x671F;&#x5957;&#x5229;
&#x672C;&#x7B56;&#x7565;&#x6839;&#x636E;EG&#x4E24;&#x6B65;&#x6CD5;(1.&#x5E8F;&#x5217;&#x540C;&#x9636;&#x5355;&#x6574;2.OLS&#x6B8B;&#x5DEE;&#x5E73;&#x7A33;)&#x5224;&#x65AD;&#x5E8F;&#x5217;&#x5177;&#x6709;&#x534F;&#x6574;&#x5173;&#x7CFB;&#x540E;(&#x82E5;&#x65E0;&#x534F;&#x6574;&#x5173;&#x7CFB;&#x5219;&#x5168;&#x5E73;&#x4ED3;&#x4F4D;&#x4E0D;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;)
&#x901A;&#x8FC7;&#x8BA1;&#x7B97;&#x4E24;&#x4E2A;&#x4EF7;&#x683C;&#x5E8F;&#x5217;&#x56DE;&#x5F52;&#x6B8B;&#x5DEE;&#x7684;&#x5747;&#x503C;&#x548C;&#x6807;&#x51C6;&#x5DEE;&#x5E76;&#x7528;&#x5747;&#x503C;&#x52A0;&#x51CF;0.9&#x500D;&#x6807;&#x51C6;&#x5DEE;&#x5F97;&#x5230;&#x4E0A;&#x4E0B;&#x8F68;
&#x5728;&#x4EF7;&#x5DEE;&#x7A81;&#x7834;&#x4E0A;&#x8F68;&#x7684;&#x65F6;&#x5019;&#x505A;&#x7A7A;&#x4EF7;&#x5DEE;;&#x5728;&#x4EF7;&#x5DEE;&#x7A81;&#x7834;&#x4E0B;&#x8F68;&#x7684;&#x65F6;&#x5019;&#x505A;&#x591A;&#x4EF7;&#x5DEE;
&#x82E5;&#x6709;&#x4ED3;&#x4F4D;,&#x5728;&#x6B8B;&#x5DEE;&#x56DE;&#x5F52;&#x81F3;&#x4E0A;&#x4E0B;&#x8F68;&#x5185;&#x7684;&#x65F6;&#x5019;&#x5E73;&#x4ED3;
&#x56DE;&#x6D4B;&#x6570;&#x636E;&#x4E3A;:rb1801&#x548C;rb1805&#x7684;1min&#x6570;&#x636E;
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#x4E3A;:2017-09-25 &#x5230;2017-10-01
&#x64AE;&#x5408;&#x5468;&#x671F;&#xFF1A;1&#x5206;&#x949F;
&apos;</span><span class="hljs-string">&apos;&apos;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x54CD;&#x5E94;&#x6A21;&#x5F0F;</span>
    api.setGroupMode(<span class="hljs-number">5000</span>, False)
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;bar&#x957F;&#x5EA6;</span>
    api.data_len = <span class="hljs-number">800</span>
    <span class="hljs-comment"># &#x8FDB;&#x884C;&#x5957;&#x5229;&#x7684;&#x54C1;&#x79CD;</span>
    api.tickersCode = [<span class="hljs-string">&apos;rb1801.CF&apos;</span>, <span class="hljs-string">&apos;rb1805.CF&apos;</span>]
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x884C;&#x60C5;&#x6570;&#x636E;&#x7F13;&#x5B58;</span>
    api.setRequireData(instsets=[<span class="hljs-string">&apos;rb.PRD&apos;</span>], symbols=api.tickersCode, fields=[], bars=[(ETimeSpan.MIN_1, <span class="hljs-number">900</span>)])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api, tradeDate)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># print(tradeDate)</span>
    api.trading_day = tradeDate
    <span class="hljs-comment"># &#x8BA2;&#x9605;&#x884C;&#x60C5;</span>
    api.setFocusSymbols(api.tickersCode)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHandleData</span><span class="hljs-params">(api, timeExch)</span></span><span class="hljs-symbol">:</span>
    api.trade_date = datetime.datetime.fromtimestamp(timeExch / <span class="hljs-number">1000</span>)

    <span class="hljs-comment"># &#x83B7;&#x53D6;&#x4E24;&#x4E2A;&#x54C1;&#x79CD;&#x7684;&#x65F6;&#x95F4;&#x5E8F;&#x5217;</span>
    data_01 = api.getBarsHistory(symbol=api.tickersCode[<span class="hljs-number">0</span>], timeSpan=ETimeSpan.MIN_1, count=api.data_len + <span class="hljs-number">1</span>,
                                 priceMode=EPriceMode.FORMER, fields=None, df=True)
    close_01 = data_01[<span class="hljs-string">&quot;close&quot;</span>].values

    data_02 = api.getBarsHistory(symbol=api.tickersCode[<span class="hljs-number">1</span>], timeSpan=ETimeSpan.MIN_1, count=api.data_len + <span class="hljs-number">1</span>,
                                 priceMode=EPriceMode.FORMER, fields=None, df=True)
    close_02 = data_02[<span class="hljs-string">&quot;close&quot;</span>].values

    <span class="hljs-comment"># &#x5C55;&#x793A;&#x4E24;&#x4E2A;&#x4EF7;&#x683C;&#x5E8F;&#x5217;&#x7684;&#x534F;&#x6574;&#x68C0;&#x9A8C;&#x7684;&#x7ED3;&#x679C;</span>
    beta, c, resid, result = cointegration_test(close_01, close_02)

    <span class="hljs-comment"># &#x5982;&#x679C;&#x8FD4;&#x56DE;&#x534F;&#x6574;&#x68C0;&#x9A8C;&#x4E0D;&#x901A;&#x8FC7;&#x7684;&#x7ED3;&#x679C;&#x5219;&#x5168;&#x5E73;&#x4ED3;&#x4F4D;&#x7B49;&#x5F85;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-symbol">result:</span>
        symbol_positions = api.getSymbolPositions()
        <span class="hljs-keyword">if</span> <span class="hljs-symbol">symbol_positions:</span>
            <span class="hljs-keyword">for</span> symbol_obj <span class="hljs-keyword">in</span> <span class="hljs-symbol">symbol_positions:</span>
                <span class="hljs-keyword">if</span> symbol_obj.positionSide == EPositionSide.<span class="hljs-symbol">SHORT:</span>
                    api.targetPosition(symbol=symbol_obj.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
                    LOG.INFO(<span class="hljs-string">&quot;close old contract short position:%s&quot;</span>, symbol_obj.symbol)
                elif symbol_obj.positionSide == EPositionSide.<span class="hljs-symbol">LONG:</span>
                    api.targetPosition(symbol=symbol_obj.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
                    LOG.INFO(<span class="hljs-string">&quot;close old contract long position:%s&quot;</span>, symbol_obj.symbol)
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x6B8B;&#x5DEE;&#x7684;&#x6807;&#x51C6;&#x5DEE;&#x4E0A;&#x4E0B;&#x8F68;</span>
    mean = np.mean(resid)
    up = mean + <span class="hljs-number">1.5</span> * np.std(resid)
    down = mean - <span class="hljs-number">1.5</span> * np.std(resid)

    <span class="hljs-comment"># &#x8BA1;&#x7B97;&#x65B0;&#x6B8B;&#x5DEE;</span>
    resid_new = close_01[-<span class="hljs-number">1</span>] - beta * close_02[-<span class="hljs-number">1</span>] - c

    <span class="hljs-comment"># &#x83B7;&#x53D6;rb1801&#x7684;&#x591A;&#x7A7A;&#x4ED3;&#x4F4D;</span>
    position_01_long = api.getSymbolPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], positionSide=EPositionSide.LONG)
    position_01_short = api.getSymbolPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], positionSide=EPositionSide.SHORT)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> position_01_long <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-symbol">position_01_short:</span>
        <span class="hljs-keyword">if</span> resid_new &gt; <span class="hljs-symbol">up:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])

        <span class="hljs-keyword">if</span> resid_new &lt; <span class="hljs-symbol">down:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])

    <span class="hljs-comment"># &#x4EF7;&#x5DEE;&#x56DE;&#x5F52;&#x65F6;&#x5E73;&#x4ED3;</span>
    elif <span class="hljs-symbol">position_01_short:</span>
        <span class="hljs-keyword">if</span> resid_new &lt;= <span class="hljs-symbol">up:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Clear all positions&quot;</span>)

        <span class="hljs-comment"># &#x8DCC;&#x7834;&#x4E0B;&#x8F68;&#x53CD;&#x5411;&#x5F00;&#x4ED3;</span>
        <span class="hljs-keyword">if</span> resid_new &lt; <span class="hljs-symbol">down:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])

    elif <span class="hljs-symbol">position_01_long:</span>
        <span class="hljs-keyword">if</span> resid_new &gt;= <span class="hljs-symbol">down:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT)
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Clear all positions&quot;</span>)
        <span class="hljs-comment"># &#x7A81;&#x7834;&#x4E0A;&#x8F68;&#x5F00;&#x591A;</span>
        <span class="hljs-keyword">if</span> resid_new &gt; <span class="hljs-symbol">up:</span>
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">0</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.SHORT)
            LOG.INFO(<span class="hljs-string">&quot;Open short at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">0</span>])
            api.targetPosition(symbol=api.tickersCode[<span class="hljs-number">1</span>], qty=<span class="hljs-number">1</span>, positionSide=EPositionSide.LONG)
            LOG.INFO(<span class="hljs-string">&quot;Open long at market price:%s&quot;</span>, api.tickersCode[<span class="hljs-number">1</span>])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api,exitInfo)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;Finished test&quot;</span>)


<span class="hljs-comment"># &#x534F;&#x6574;&#x68C0;&#x9A8C;&#x7684;&#x51FD;&#x6570;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cointegration_test</span><span class="hljs-params">(series01, series02)</span></span><span class="hljs-symbol">:</span>
    urt_rb1801 = ts.adfuller(np.array(series01), <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]
    urt_rb1805 = ts.adfuller(np.array(series02), <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]
    <span class="hljs-comment"># &#x540C;&#x65F6;&#x5E73;&#x7A33;&#x6216;&#x4E0D;&#x5E73;&#x7A33;&#x5219;&#x5DEE;&#x5206;&#x518D;&#x6B21;&#x68C0;&#x9A8C;</span>
    <span class="hljs-keyword">if</span> (urt_rb1801 &gt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> urt_rb1805 &gt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span>) <span class="hljs-keyword">or</span> (urt_rb1801 &lt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> urt_rb1805 &lt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span>)<span class="hljs-symbol">:</span>
        urt_diff_rb1801 = ts.adfuller(np.diff(np.array(series01)), <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]
        urt_diff_rb1805 = ts.adfuller(np.diff(np.array(series02)), <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]
        <span class="hljs-comment"># &#x540C;&#x65F6;&#x5DEE;&#x5206;&#x5E73;&#x7A33;&#x8FDB;&#x884C;OLS&#x56DE;&#x5F52;&#x7684;&#x6B8B;&#x5DEE;&#x5E73;&#x7A33;&#x68C0;&#x9A8C;</span>
        <span class="hljs-keyword">if</span> urt_diff_rb1801 &lt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> urt_diff_rb1805 &lt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:</span>
            matrix = np.vstack([series02, np.ones(len(series02))]).T
            beta, c = np.linalg.lstsq(matrix, series01)[<span class="hljs-number">0</span>]
            resid = series01 - beta * series02 - c
            <span class="hljs-keyword">if</span> ts.adfuller(np.array(resid), <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">0</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:</span>
                result = <span class="hljs-number">0</span>.<span class="hljs-number">0</span>
            <span class="hljs-symbol">else:</span>
                result = <span class="hljs-number">1.0</span>
            <span class="hljs-keyword">return</span> beta, c, resid, result

        <span class="hljs-symbol">else:</span>
            result = <span class="hljs-number">0</span>.<span class="hljs-number">0</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, result

    <span class="hljs-symbol">else:</span>
        result = <span class="hljs-number">0</span>.<span class="hljs-number">0</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, <span class="hljs-number">0</span>.<span class="hljs-number">0</span>, result
</code></pre>
<h3 id="dualtrust-&#x65E5;&#x5185;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><a name="dualtrust-&#x65E5;&#x5185;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;" class="anchor-navigation-ex-anchor" href="#dualtrust-&#x65E5;&#x5185;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;"><i class="fa fa-link" aria-hidden="true"></i></a>dualTrust-&#x65E5;&#x5185;&#x4EA4;&#x6613;&#xFF08;&#x671F;&#x8D27;&#xFF09;</h3>
<pre><code class="lang-Ruby"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
from __future_<span class="hljs-number">_</span> import print_function, absolute_import, unicode_literals, division
import numpy as np
import datetime
from etasdk import *
import talib
import heapq
import csv
import pandas as pd
from collections import deque, OrderedDict
import sys

reload(sys)
sys.setdefaultencoding(<span class="hljs-string">&quot;utf-8&quot;</span>)

<span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
&#x671F;&#x8D27;&#x65E5;&#x5185;&#x4EA4;&#x6613;
Dual-Trust&#x7B56;&#x7565;&#x6982;&#x8FF0;&#xFF1A;
==================
&#x5728;Dual Thrust &#x4EA4;&#x6613;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x5BF9;&#x4E8E;&#x9707;&#x8361;&#x533A;&#x95F4;&#x7684;&#x5B9A;&#x4E49;&#x975E;&#x5E38;&#x5173;&#x952E;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x8BE5;&#x4EA4;&#x6613;&#x7CFB;&#x7EDF;&#x7684;&#x6838;&#x5FC3;&#x3002;Dual Thrust&#x5728;Range
&#x7684;&#x8BBE;&#x7F6E;&#x4E0A;&#xFF0C;&#x5F15;&#x5165;&#x524D;N &#x65E5;&#x7684;&#x56DB;&#x4E2A;&#x4EF7;&#x4F4D;&#xFF0C;Range = Max(HH-LC,HC-LL)&#x6765;&#x63CF;&#x8FF0;&#x9707;&#x8361;&#x533A;&#x95F4;&#x7684;&#x5927;&#x5C0F;&#x3002;&#x5176;&#x4E2D;HH &#x662F;N &#x65E5;High
&#x7684;&#x6700;&#x9AD8;&#x4EF7;&#xFF0C;LC &#x662F;N &#x65E5;Close &#x7684;&#x6700;&#x4F4E;&#x4EF7;&#xFF0C;HC &#x662F;N &#x65E5;Close &#x7684;&#x6700;&#x9AD8;&#x4EF7;&#xFF0C;LL &#x662F;N &#x65E5;Low &#x7684;&#x6700;&#x4F4E;&#x4EF7;&#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x4F7F;&#x5F97;&#x4E00;
&#x5B9A;&#x65F6;&#x671F;&#x5185;&#x7684;Range &#x76F8;&#x5BF9;&#x7A33;&#x5B9A;&#xFF0C;&#x53EF;&#x4EE5;&#x9002;&#x7528;&#x4E8E;&#x65E5;&#x95F4;&#x7684;&#x8D8B;&#x52BF;&#x8DDF;&#x8E2A;&#x3002;Dual Thrust &#x5BF9;&#x4E8E;&#x591A;&#x5934;&#x548C;&#x7A7A;&#x5934;&#x7684;&#x89E6;&#x53D1;&#x6761;&#x4EF6;&#xFF0C;&#x8003;&#x8651;&#x4E86;&#x975E;
&#x5BF9;&#x79F0;&#x7684;&#x5E45;&#x5EA6;&#xFF0C;&#x505A;&#x591A;&#x548C;&#x505A;&#x7A7A;&#x53C2;&#x8003;&#x7684;Range&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x5468;&#x671F;&#x6570;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53C2;&#x6570;K1 &#x548C;K2 &#x6765;&#x786E;&#x5B9A;&#x3002;

&#x7B2C;&#x4E00;&#x6B65;&#xFF1A;&#x8BA1;&#x7B97;&#x76F8;&#x5173;&#x53C2;&#x6570;&#xFF0C;&#x5F97;&#x5230;&#x4E0A;&#x8F68;Buy_line &#x548C;&#x4E0B;&#x8F68;Sell_line&#xFF1A;
1&#x3001;N &#x65E5;High &#x7684;&#x6700;&#x9AD8;&#x4EF7;HH, N &#x65E5;Close &#x7684;&#x6700;&#x4F4E;&#x4EF7;LC;
2&#x3001;N &#x65E5;Close &#x7684;&#x6700;&#x9AD8;&#x4EF7;HC&#xFF0C;N &#x65E5;Low &#x7684;&#x6700;&#x4F4E;&#x4EF7;LL;
3&#x3001;Range = Max(HH-LC,HC-LL)&#xFF1B;
4&#x3001;BuyLine = Open + K1*Range&#xFF1B;
5&#x3001;SellLine = Open + K2*Range&#xFF1B;

&#x7B2C;&#x4E8C;&#x6B65;&#xFF1A;&#x4EA4;&#x6613;&#x903B;&#x8F91;
1&#x3001;&#x5F53;&#x4EF7;&#x683C;&#x5411;&#x4E0A;&#x7A81;&#x7834;&#x4E0A;&#x8F68;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x65F6;&#x6301;&#x6709;&#x7A7A;&#x4ED3;&#xFF0C;&#x5219;&#x5148;&#x5E73;&#x4ED3;&#xFF0C;&#x518D;&#x5F00;&#x591A;&#x4ED3;&#xFF1B;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x5F00;&#x591A;&#x4ED3;&#xFF1B;
2&#x3001;&#x5F53;&#x4EF7;&#x683C;&#x5411;&#x4E0B;&#x7A81;&#x7834;&#x4E0B;&#x8F68;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x65F6;&#x6301;&#x6709;&#x591A;&#x4ED3;&#xFF0C;&#x5219;&#x5148;&#x5E73;&#x4ED3;&#xFF0C;&#x518D;&#x5F00;&#x7A7A;&#x4ED3;&#xFF1B;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4ED3;&#x4F4D;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x5F00;&#x7A7A;&#x4ED3;&#xFF1B;

&#x7B2C;&#x4E09;&#x6B65;&#xFF1A;&#x6B62;&#x635F;
1&#x3001;&#x521D;&#x59CB;&#x6B62;&#x635F;
2&#x3001;&#x5165;&#x573A;&#x540E;&#x8DDF;&#x8E2A;&#x6B62;&#x635F;
3&#x3001;&#x51FA;&#x73B0;&#x53CD;&#x5411;&#x4FE1;&#x53F7;&#x6B62;&#x635F;&#x5F00;&#x53CD;&#x5411;&#x4ED3;&#x4F4D;
4&#x3001;&#x5728;&#x6536;&#x76D8;&#x524D;1&#x5206;&#x949F;&#x5E73;&#x4ED3;&#xFF08;14:58&#xFF09;
5&#x3001;&#x6BCF;&#x65E5;&#x6700;&#x591A;&#x4EA4;&#x6613;&#x6B21;&#x6570;2&#x6B21;&#xFF0C;&#x591A;&#x7A7A;&#x5404;&#x4E00;&#x6B21;


&#x56DE;&#x6D4B;&#x6570;&#x636E;&#x4E3A;:ruZ0.CF&#x4E3B;&#x529B;&#x5408;&#x7EA6;&#x7684;&#x7684;1min&#x6570;&#x636E;
&#x56DE;&#x6D4B;&#x65F6;&#x95F4;&#x4E3A;:2018-10-8 &#x5230;2018-10-18

&quot;</span><span class="hljs-string">&quot;&quot;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onInitialize</span><span class="hljs-params">(api)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># &#x8BBE;&#x7F6E;&#x54CD;&#x5E94;&#x6A21;&#x5F0F;</span>
    api.setGroupMode(<span class="hljs-number">5000</span>, False)
    api.focused_contracts = <span class="hljs-string">&quot;ruZ0.CF&quot;</span>
    api.threshold = <span class="hljs-number">0</span>.<span class="hljs-number">015</span>
    api.percent = <span class="hljs-number">0</span>.<span class="hljs-number">035</span>
    api.k = <span class="hljs-number">0</span>.<span class="hljs-number">65</span>
    api.focused_prd = str(api.focused_contracts.replace(<span class="hljs-string">&quot;Z0.CF&quot;</span>, <span class="hljs-string">&quot;.PRD&quot;</span>))
    api.setRequireData(instsets=api.focused_prd, symbols=api.focused_contracts, fields=[],
                       bars=[(ETimeSpan.DAY_1, <span class="hljs-number">10</span>), (ETimeSpan.MIN_1, <span class="hljs-number">130</span>)])

    <span class="hljs-comment"># &#x521D;&#x59CB;&#x8D44;&#x91D1;&#x548C;&#x6570;&#x636E;&#x6D4B;&#x8BD5;</span>
    account = api.getAccount(symbol=api.focused_contracts, market=MARKET_CHINAFUTURE)
    api.capital = account.cashAvailable  <span class="hljs-comment"># &#x8D26;&#x6237;&#x521D;&#x59CB;&#x8D44;&#x91D1;</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBeforeMarketOpen</span><span class="hljs-params">(api, tradeDate)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-comment"># print(tradeDate)</span>
    api.trading_day = tradeDate
    api.bars_since_today = <span class="hljs-number">0</span>
    api.lots = <span class="hljs-number">1</span>
    api.can_trade = False
    api.long_can_trade = True
    api.short_can_trade = True
    api.code = api.getContinuousSymbol(api.focused_contracts, tradeDate)
    api.history_range, normalize_tr, last_close = get_history_range(api, api.code)

    <span class="hljs-comment"># &#x8BA2;&#x9605;&#x5408;&#x7EA6;</span>
    <span class="hljs-keyword">if</span> normalize_tr &gt; api.<span class="hljs-symbol">threshold:</span>
        api.setFocusSymbols(api.code)
        api.can_trade = True
        multiply = get_multiply(api, api.focused_contracts)
        api.lots = int(<span class="hljs-number">1000000</span> / (last_close * multiply))
    <span class="hljs-comment"># print(&quot;api.can_trade:&quot;, api.can_trade)</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onBar</span><span class="hljs-params">(api, bar)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-keyword">if</span> api.<span class="hljs-symbol">can_trade:</span>
        time_now = datetime.datetime.fromtimestamp(api.timeNow() / <span class="hljs-number">1000</span>)
        api.bars_since_today += <span class="hljs-number">1</span>
        bars = api.getBarsHistory(symbol=bar.symbol, timeSpan=ETimeSpan.MIN_1, count=api.bars_since_today,
                                  priceMode=EPriceMode.REAL, fields=None, df=True)
        <span class="hljs-comment"># print(&quot;time_now:&quot;, time_now)</span>
        today_open = bars[<span class="hljs-string">&apos;open&apos;</span>].values[<span class="hljs-number">0</span>]
        buy_line, sell_line = get_buy_and_sell_lines(today_open=today_open, history_range=api.history_range,
                                                     k1=api.k, k2=api.k)

        position_side = get_position_side(api, bar.symbol)

        <span class="hljs-keyword">if</span> position_side &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> bar.high &gt; buy_line <span class="hljs-keyword">and</span> api.<span class="hljs-symbol">long_can_trade:</span>
            api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT,
                               remark=<span class="hljs-string">&quot;Reverse!&quot;</span>)
            api.targetPosition(symbol=bar.symbol, qty=api.lots, positionSide=EPositionSide.LONG,
                               remark=<span class="hljs-string">&quot;Entry LONG!&quot;</span>)
            api.long_can_trade = False
        <span class="hljs-keyword">if</span> position_side &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> bar.low &lt; sell_line <span class="hljs-keyword">and</span> api.<span class="hljs-symbol">short_can_trade:</span>
            api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,
                               remark=<span class="hljs-string">&quot;Reverse!&quot;</span>)
            api.targetPosition(symbol=bar.symbol, qty=api.lots, positionSide=EPositionSide.SHORT,
                               remark=<span class="hljs-string">&quot;Entry Short!&quot;</span>)
            api.short_can_trade = False

        <span class="hljs-keyword">if</span> position_side &gt; <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            symbol_position = api.getSymbolPosition(symbol=bar.symbol, positionSide=EPositionSide.LONG)
            <span class="hljs-keyword">if</span> bar.low &lt;= symbol_position.posHigh * (<span class="hljs-number">1</span> - api.percent)<span class="hljs-symbol">:</span>
                api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,
                                   remark=<span class="hljs-string">&quot;Long Liquid!&quot;</span>)
        <span class="hljs-keyword">if</span> position_side &lt; <span class="hljs-number">0</span><span class="hljs-symbol">:</span>
            symbol_position = api.getSymbolPosition(symbol=bar.symbol, positionSide=EPositionSide.SHORT)
            <span class="hljs-keyword">if</span> bar.high &gt;= symbol_position.posLow * (<span class="hljs-number">1</span> + api.percent)<span class="hljs-symbol">:</span>
                api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT,
                                   remark=<span class="hljs-string">&quot;Short Liquid!&quot;</span>)

        <span class="hljs-keyword">if</span> time_now.hour == <span class="hljs-number">14</span> <span class="hljs-keyword">and</span> time_now.minute == <span class="hljs-number">59</span><span class="hljs-symbol">:</span>
            api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.SHORT,
                               remark=<span class="hljs-string">&quot;Closing the market, Exit Short!&quot;</span>)
            api.targetPosition(symbol=bar.symbol, qty=<span class="hljs-number">0</span>, positionSide=EPositionSide.LONG,
                               remark=<span class="hljs-string">&quot;Closing the market, Exit LONG!&quot;</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onTerminate</span><span class="hljs-params">(api, exit_info)</span></span><span class="hljs-symbol">:</span>
    print(<span class="hljs-string">&quot;Finished test&quot;</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_history_range</span><span class="hljs-params">(api, symbol, look_back=<span class="hljs-number">5</span>)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x6BCF;&#x6B21;&#x5F00;&#x76D8;&#x4E4B;&#x524D;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#xFF1A;
    &#x83B7;&#x53D6;&#x8FC7;&#x53BB;N&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x7684;&#x6700;&#x9AD8;&#x4EF7;HH&#xFF0C;&#x6700;&#x4F4E;&#x4EF7;LL&#xFF0C;&#x6700;&#x9AD8;&#x6536;&#x76D8;&#x4EF7;HC&#xFF0C;&#x6700;&#x4F4E;&#x6536;&#x76D8;&#x4EF7;
    &quot;</span><span class="hljs-string">&quot;&quot;</span>
    str_fields = [<span class="hljs-string">&apos;tradeDate&apos;</span>, <span class="hljs-string">&apos;open&apos;</span>, <span class="hljs-string">&apos;high&apos;</span>, <span class="hljs-string">&apos;low&apos;</span>, <span class="hljs-string">&apos;close&apos;</span>]
    str_index = <span class="hljs-string">&apos;tradeDate&apos;</span>
    bars = api.getBarsHistory(symbol=symbol, timeSpan=ETimeSpan.DAY_1, skipSuspended=<span class="hljs-number">1</span>, count=look_back,
                              df=True, priceMode=EPriceMode.REAL, fields=str_fields).set_index(str_index)
    <span class="hljs-keyword">if</span> len(bars) &lt; <span class="hljs-symbol">look_back:</span>
        print(<span class="hljs-string">&quot;%s lack of data:&quot;</span>, symbol)
        history_range = <span class="hljs-number">0</span>
        normalize_tr = <span class="hljs-number">0</span>
        last_close = float(<span class="hljs-string">&quot;inf&quot;</span>)
    <span class="hljs-symbol">else:</span>
        highs = bars[<span class="hljs-string">&apos;high&apos;</span>].values
        lows = bars[<span class="hljs-string">&apos;low&apos;</span>].values
        closes = bars[<span class="hljs-string">&apos;close&apos;</span>].values
        highest_high = np.max(highs)
        lowest_low = np.min(lows)
        highest_close = np.max(closes)
        lowest_close = np.min(closes)
        history_range = np.max([highest_high - lowest_close, highest_close - lowest_low])
        true_range = np.max([highs[-<span class="hljs-number">1</span>] - lows[-<span class="hljs-number">1</span>], abs(highs[-<span class="hljs-number">1</span>] - closes[-<span class="hljs-number">2</span>]), abs(closes[-<span class="hljs-number">2</span>] - lows[-<span class="hljs-number">1</span>])])
        last_close = closes[-<span class="hljs-number">1</span>]
        normalize_tr = true_range / last_close

    <span class="hljs-keyword">return</span> history_range, normalize_tr, last_close


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_buy_and_sell_lines</span><span class="hljs-params">(today_open, history_range, k1=<span class="hljs-number">0</span>.<span class="hljs-number">45</span>, k2=<span class="hljs-number">0</span>.<span class="hljs-number">55</span>)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;&#x8BA1;&#x7B97;&#x4E70;&#x5165;&#x5F00;&#x4ED3;&#x4EF7;&#x4E0A;&#x8F68;&#x548C;&#x5356;&#x51FA;&#x5F00;&#x4ED3;&#x4EF7;&#x4E0B;&#x8F68;
    BuyLine = today_open + K1*Range
    SellLine = today_open + K2*Range
    &quot;</span><span class="hljs-string">&quot;&quot;</span>
    buy_line = today_open + k1 * history_range
    sell_line = today_open - k2 * history_range
    <span class="hljs-keyword">return</span> buy_line, sell_line


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_position_side</span><span class="hljs-params">(api, symbol)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x901A;&#x8FC7;API&#x83B7;&#x53D6;&#x7ED9;&#x5B9A;&#x5408;&#x7EA6;&#x7684;&#x6301;&#x4ED3;&#x65B9;&#x5411;&#x53CA;&#x6570;&#x91CF;
    1&#x6301;&#x4ED3;&#x4E3A;&#x591A;&#x5355;&#xFF0C;-1&#x6301;&#x4ED3;&#x4E3A;&#x7A7A;&#x5355;&#xFF0C;&#x7B49;&#x4E8E;0&#x8868;&#x660E;&#x5F53;&#x524D;&#x6CA1;&#x6709;&#x6301;&#x4ED3;
    &quot;</span><span class="hljs-string">&quot;&quot;</span>
    long_position = int(api.getSymbolPosition(symbol, EPositionSide.LONG).posQty)
    short_position = int(api.getSymbolPosition(symbol, EPositionSide.SHORT).posQty)
    position_side = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> <span class="hljs-symbol">long_position:</span>
        position_side = <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-symbol">short_position:</span>
        position_side = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> position_side


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_multiply</span><span class="hljs-params">(api, symbol)</span></span><span class="hljs-symbol">:</span>
    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;
    &#x83B7;&#x53D6;&#x7ED9;&#x5B9A;&#x5408;&#x7EA6;&#x7684;&#x5408;&#x7EA6;&#x4EF7;&#x503C;&#x548C;&#x6700;&#x5C0F;&#x53D8;&#x52A8;&#x4EF7;&#x683C;
    &quot;</span><span class="hljs-string">&quot;&quot;</span>
    ref_data = api.getRefData(str(symbol))
    multiplier = ref_data.valuePerUnit
    <span class="hljs-keyword">return</span> multiplier
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="api5.html#sendcustommessagemsg-设置用户自定义运行消息" class="navigation navigation-prev " aria-label="Previous page: send_custom_message(msg) 设置用户自定义运行消息">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="starategy6.html#入门策略" class="navigation navigation-next " aria-label="Next page: 入门策略">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"策略示例","level":"1.7","depth":1,"next":{"title":"入门策略","level":"1.7.1","depth":2,"anchor":"#入门策略","path":"starategy6.md","ref":"starategy6.md#入门策略","articles":[{"title":"buySellSymbol-股票买卖策略","level":"1.7.1.1","depth":3,"anchor":"#buysellsymbol-股票买卖策略","path":"starategy6.md","ref":"starategy6.md#buysellsymbol-股票买卖策略","articles":[]},{"title":"buySellFutures-期货买卖策略","level":"1.7.1.2","depth":3,"anchor":"#buysellfutures-期货买卖策略","path":"starategy6.md","ref":"starategy6.md#buysellfutures-期货买卖策略","articles":[]},{"title":"MA-双均线策略（股票）","level":"1.7.1.3","depth":3,"anchor":"#ma-双均线策略（股票）","path":"starategy6.md","ref":"starategy6.md#ma-双均线策略（股票）","articles":[]}]},"previous":{"title":"send_custom_message(msg) 设置用户自定义运行消息","level":"1.6.9.5.4","depth":4,"anchor":"#sendcustommessagemsg-设置用户自定义运行消息","path":"api5.md","ref":"api5.md#sendcustommessagemsg-设置用户自定义运行消息","articles":[]},"dir":"ltr"},"config":{"plugins":["advanced-emoji","-back-to-top-button","-lunr","-search","search-pro","-copy-code-button","-expandable-chapters-small","splitter","-popup","expandable-chapters","ancre-navigation","-page-treeview","-theme-faq","-sharing","livereload"],"styles":{"website":"style/override.css"},"pluginsConfig":{"livereload":{},"splitter":{},"search-pro":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"ancre-navigation":{"associatedWithSummary":true,"float":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showLevel":true},"advanced-emoji":{"embedEmojis":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"language":"zh-hans","gitbook":"*"},"file":{"path":"starategy6.md","mtime":"2019-04-11T02:02:46.260Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-04-11T10:23:49.723Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

